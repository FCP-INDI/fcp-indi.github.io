
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>C-PAC Pipeline Construction &#8212; C-PAC 1.6.2.a Beta documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Anatomical Preprocessing" href="anat_preproc.html" />
    <link rel="prev" title="Workflows" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="anat_preproc.html" title="Anatomical Preprocessing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Workflows"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">C-PAC 1.6.2.a Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Workflows</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="c-pac-pipeline-construction">
<span id="cpac-pipeline"></span><h1>C-PAC Pipeline Construction<a class="headerlink" href="#c-pac-pipeline-construction" title="Permalink to this headline">¶</a></h1>
<div class="section" id="configuration-object">
<h2>Configuration Object<a class="headerlink" href="#configuration-object" title="Permalink to this headline">¶</a></h2>
<p>The ‘c’ variable in cpac_pipeline.py is a <a class="reference external" href="https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/utils/configuration.py">Configuration object</a>, which is an abstract representation used to store the options for the pipeline configuration YAML after it is read in by C-PAC.  Each attribute of the Configuration object is a key from the YAML file, with values mirroring the YAML.</p>
</div>
<div class="section" id="strategy-object">
<h2>Strategy Object<a class="headerlink" href="#strategy-object" title="Permalink to this headline">¶</a></h2>
<p>A strategy object represents an individual pipeline.  The number of strategies is determined by how options have been set in the configuration file.  If there is a step where multiple options have been specified, all steps in the pipeline prior to that step will be forked and multiple strategies will created for each option.  The steps where forking can occur are CompCor, nuisance regressor, segmentation and scrubbing.  Each strategy has the following attributes:</p>
<ul class="simple">
<li>resource pool - a dictionary containing all nodes/workflows used by a strategy.  Keys are descriptors of the node/workflow and values are two-element tuples containing a copy of the node/workflow and the outputspec for that node/workflow.</li>
<li>leaf_node - the final node/workflow added during the last step of strategy construction.</li>
<li>leaf_out_file - the outputspec associated with the leaf node.</li>
<li>name - a list of workflow names</li>
</ul>
</div>
<div class="section" id="strategy-construction">
<h2>Strategy Construction<a class="headerlink" href="#strategy-construction" title="Permalink to this headline">¶</a></h2>
<p>cpac_pipeline.py is where the Nipype workflow object for each strategy is constructed via flow control.
To add a new method/technique, add a code block similar to this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Inserting &lt;technique/method&gt;</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="n">new_strat_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">num_strat</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">runTechnique</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">strat</span> <span class="ow">in</span> <span class="n">strat_list</span><span class="p">:</span>
                <span class="c1"># Introduce nodes/workflows here</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="n">nipype_node</span><span class="o">=</span><span class="n">spawn_nipype_node</span><span class="p">()</span>
                <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Something went wrong!&#39;</span><span class="p">)</span>
                <span class="c1"># Get the necessary inputs from the resource pool and connect to the node/workflow.</span>
                <span class="k">try</span><span class="p">:</span>
                        <span class="n">node</span><span class="p">,</span> <span class="n">out_file</span> <span class="o">=</span> <span class="n">strat</span><span class="o">.</span><span class="n">get_node_from_resource_pool</span><span class="p">(</span><span class="s1">&#39;previous&#39;</span><span class="p">)</span>
                        <span class="n">workflow</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">nipype_node</span><span class="p">,</span><span class="s1">&#39;inputspec.input&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Something went wrong!&#39;</span><span class="p">)</span>
                <span class="c1"># Add additional options from configuration YAML / config object here using conditional statements.</span>

                <span class="c1"># If runTechnique can take multiple values, fork the strategy.</span>
                <span class="c1"># This is the off option, so the original strategy is copied into a new one.</span>
                <span class="c1"># The new strategy is then updated with the values for a pipeline where the technique is turned on.</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">runTechnique</span><span class="p">:</span>
                        <span class="n">tmp</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">()</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">resource_pool</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">resource_pool</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">leaf_node</span> <span class="o">=</span> <span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">leaf_node</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">leaf_out_file</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">leaf_out_file</span><span class="p">)</span>
                        <span class="n">tmp</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">strat</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="c1"># strat now points at the new strategy, rather than the old strategy contained in strat_list</span>
                        <span class="n">strat</span> <span class="o">=</span> <span class="n">tmp</span>
                        <span class="n">new_strat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strat</span><span class="p">)</span>
                <span class="n">strat</span><span class="o">.</span><span class="n">append_name</span><span class="p">(</span><span class="n">nipype_node</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">strat</span><span class="o">.</span><span class="n">update_resource_pool</span><span class="p">({</span><span class="s1">&#39;output&#39;</span><span class="p">:(</span><span class="n">output</span><span class="p">,</span><span class="s1">&#39;outputspec.output&#39;</span><span class="p">)})</span>
                <span class="n">create_log_node</span><span class="p">(</span><span class="n">nipype_node</span><span class="p">,</span><span class="s1">&#39;outputspec.output&#39;</span><span class="p">,</span> <span class="n">num_strat</span><span class="p">)</span>
                <span class="n">num_strat</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">strat_list</span> <span class="o">+=</span> <span class="n">new_strat_list</span>
</pre></div>
</div>
<p>Where <cite>runTechnique</cite> is the name of the YAML configuration key for that method/technique.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">C-PAC Pipeline Construction</a><ul>
<li><a class="reference internal" href="#configuration-object">Configuration Object</a></li>
<li><a class="reference internal" href="#strategy-object">Strategy Object</a></li>
<li><a class="reference internal" href="#strategy-construction">Strategy Construction</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">Workflows</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="anat_preproc.html"
                        title="next chapter">Anatomical Preprocessing</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/workflows/cpac_pipeline.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="anat_preproc.html" title="Anatomical Preprocessing"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="Workflows"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">C-PAC 1.6.2.a Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Workflows</a> &#187;</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2018, C-PAC Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>

  </body>
</html>