
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CPAC.anat_preproc.anat_preproc &#8212; C-PAC 1.7.0 Beta documentation</title>
    <link rel="stylesheet" href="../../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="../../../genindex" />
    <link rel="search" title="Search" href="../../../search" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.7.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CPAC.anat_preproc.anat_preproc</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="k">as</span> <span class="nn">pe</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.ants</span> <span class="kn">import</span> <span class="n">init_brain_extraction_wf</span>
<span class="kn">from</span> <span class="nn">CPAC.anat_preproc.utils</span> <span class="kn">import</span> <span class="n">create_3dskullstrip_arg_string</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.datasource</span> <span class="kn">import</span> <span class="n">create_check_for_s3_node</span>
<span class="kn">from</span> <span class="nn">CPAC.unet.function</span> <span class="kn">import</span> <span class="n">predict_volumes</span>

<span class="k">def</span> <span class="nf">patch_cmass_output</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lst : list of tuples</span>
<span class="sd">        output of afni.CenterMass()</span>
<span class="sd">    index : int</span>
<span class="sd">        index in the list of tuples</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        tuple</span>
<span class="sd">            one set of center of mass coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">index</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;lst index out of range&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lst</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>

<div class="viewcode-block" id="create_anat_preproc"><a class="viewcode-back" href="../../../developer/workflows/anat_preproc#CPAC.anat_preproc.create_anat_preproc">[docs]</a><span class="k">def</span> <span class="nf">create_anat_preproc</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;afni&#39;</span><span class="p">,</span> <span class="n">already_skullstripped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="s1">&#39;anat_preproc&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main purpose of this workflow is to process T1 scans. Raw mprage file is deobliqued, reoriented</span>
<span class="sd">    into RPI and skullstripped. Also, a whole brain only mask is generated from the skull stripped image</span>
<span class="sd">    for later use in registration.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    anat_preproc : workflow</span>
<span class="sd">        Anatomical Preprocessing Workflow</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    `Source &lt;https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/anat_preproc/anat_preproc.py&gt;`_</span>

<span class="sd">    Workflow Inputs::</span>
<span class="sd">        inputspec.anat : string</span>
<span class="sd">            User input anatomical (T1) Image, in any of the 8 orientations</span>

<span class="sd">    Workflow Outputs::</span>

<span class="sd">        outputspec.refit : string</span>
<span class="sd">            Path to deobliqued anatomical image</span>

<span class="sd">        outputspec.reorient : string</span>
<span class="sd">            Path to RPI oriented anatomical image</span>

<span class="sd">        outputspec.skullstrip : string</span>
<span class="sd">            Path to skull stripped RPI oriented mprage file with normalized intensities.</span>

<span class="sd">        outputspec.brain : string</span>
<span class="sd">            Path to skull stripped RPI brain image with original intensity values and not normalized or scaled.</span>

<span class="sd">    Order of commands:</span>
<span class="sd">    - Deobliqing the scans. ::</span>
<span class="sd">        3drefit -deoblique mprage.nii.gz</span>

<span class="sd">    - Re-orienting the Image into Right-to-Left Posterior-to-Anterior Inferior-to-Superior  (RPI) orientation ::</span>
<span class="sd">        3dresample -orient RPI</span>
<span class="sd">                   -prefix mprage_RPI.nii.gz</span>
<span class="sd">                   -inset mprage.nii.gz</span>

<span class="sd">    - Skull-Stripping the image ::</span>
<span class="sd">        Using AFNI ::</span>
<span class="sd">            3dSkullStrip -input mprage_RPI.nii.gz</span>
<span class="sd">                         -o_ply mprage_RPI_3dT.nii.gz</span>
<span class="sd">        or using BET ::</span>
<span class="sd">            bet mprage_RPI.nii.gz</span>

<span class="sd">    - The skull-stripping step modifies the intensity values. To get back the original intensity values, we do an element wise product of RPI data with step function of skull-stripped data ::</span>
<span class="sd">        3dcalc -a mprage_RPI.nii.gz</span>
<span class="sd">               -b mprage_RPI_3dT.nii.gz</span>
<span class="sd">               -expr &#39;a*step(b)&#39;</span>
<span class="sd">               -prefix mprage_RPI_3dc.nii.gz</span>

<span class="sd">    High Level Workflow Graph:</span>
<span class="sd">    .. image:: ../images/anatpreproc_graph.dot.png</span>
<span class="sd">       :width: 500</span>

<span class="sd">    Detailed Workflow Graph:</span>
<span class="sd">    .. image:: ../images/anatpreproc_graph_detailed.dot.png</span>
<span class="sd">       :width: 500</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from CPAC.anat_preproc import create_anat_preproc</span>
<span class="sd">    &gt;&gt;&gt; preproc = create_anat_preproc()</span>
<span class="sd">    &gt;&gt;&gt; preproc.inputs.inputspec.anat = &#39;sub1/anat/mprage.nii.gz&#39;</span>
<span class="sd">    &gt;&gt;&gt; preproc.run() #doctest: +SKIP</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">wf_name</span><span class="p">)</span>

    <span class="n">inputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> 
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;template_cmass&#39;</span><span class="p">]),</span> 
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputnode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;refit&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;reorient&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;skullstrip&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;center_of_mass&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">anat_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_deoblique&#39;</span><span class="p">)</span>
    <span class="n">anat_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;refit&#39;</span><span class="p">)</span>    
    <span class="c1"># Disable non_local_means_filtering and n4_bias_field_correction when run niworkflows-ants</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
        <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;anat_denoise&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_n4&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
        <span class="n">denoise</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">DenoiseImage</span><span class="p">(),</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;anat_denoise&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
        <span class="n">n4</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span> <span class="o">=</span> <span class="n">ants</span><span class="o">.</span><span class="n">N4BiasFieldCorrection</span><span class="p">(</span><span class="n">dimension</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">shrink_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">copy_header</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_n4&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>

    <span class="c1"># Anatomical reorientation</span>
    <span class="n">anat_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_reorient&#39;</span><span class="p">)</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;RPI&#39;</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
    
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">n4</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">non_local_means_filtering</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">n4_bias_field_correction</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">denoise</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;reorient&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">already_skullstripped</span><span class="p">:</span>

        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>
        
        <span class="c1"># binarize skullstripped brain to get brain mask</span>
        <span class="n">brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>
        <span class="n">brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;afni&#39;</span><span class="p">:</span>
            <span class="c1"># Skull-stripping using AFNI 3dSkullStrip</span>
            <span class="n">inputnode_afni</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;monkey&#39;</span><span class="p">]),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;AFNI_options&#39;</span><span class="p">)</span>

            <span class="n">skullstrip_args</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spat_norm&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;spat_norm_dxyz&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;shrink_fac&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;niter&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;pushout&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;touchup&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;use_edge&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;use_skull&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;perc_int&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;fac&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;monkey&#39;</span><span class="p">],</span>
                                                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">],</span>
                                                    <span class="n">function</span><span class="o">=</span><span class="n">create_3dskullstrip_arg_string</span><span class="p">),</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_args&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">inputnode_afni</span><span class="p">,</span> <span class="n">skullstrip_args</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;mask_vol&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_vol&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;shrink_factor&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">,</span> <span class="s1">&#39;var_shrink_fac&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">,</span> <span class="s1">&#39;shrink_fac_bot_lim&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;avoid_vent&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_vent&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;niter&#39;</span><span class="p">,</span> <span class="s1">&#39;niter&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;pushout&#39;</span><span class="p">,</span> <span class="s1">&#39;pushout&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;touchup&#39;</span><span class="p">,</span> <span class="s1">&#39;touchup&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;fill_hole&#39;</span><span class="p">,</span> <span class="s1">&#39;fill_hole&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;avoid_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;avoid_eyes&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;use_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;use_edge&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;exp_frac&#39;</span><span class="p">,</span> <span class="s1">&#39;exp_frac&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;smooth_final&#39;</span><span class="p">,</span> <span class="s1">&#39;smooth_final&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;push_to_edge&#39;</span><span class="p">,</span> <span class="s1">&#39;push_to_edge&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;use_skull&#39;</span><span class="p">,</span> <span class="s1">&#39;use_skull&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;perc_int&#39;</span><span class="p">,</span> <span class="s1">&#39;perc_int&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;max_inter_iter&#39;</span><span class="p">,</span> <span class="s1">&#39;max_inter_iter&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;blur_fwhm&#39;</span><span class="p">,</span> <span class="s1">&#39;blur_fwhm&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;fac&#39;</span><span class="p">,</span> <span class="s1">&#39;fac&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;monkey&#39;</span><span class="p">,</span><span class="s1">&#39;monkey&#39;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="p">])</span>

            <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">SkullStrip</span><span class="p">(),</span>
                                      <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>

            <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">skullstrip_args</span><span class="p">,</span> <span class="s1">&#39;expr&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">)</span>

            <span class="c1"># Generate anatomical brain mask</span>

            <span class="n">anat_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_brain_mask&#39;</span><span class="p">)</span>

            <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;step(a)&#39;</span>
            <span class="n">anat_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

            <span class="c1"># Apply skull-stripping step mask to original volume</span>
            <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">)</span>

            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;fsl&#39;</span><span class="p">:</span>
            <span class="c1"># Skull-stripping using FSL BET</span>
            <span class="n">inputnode_bet</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;outline&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;padding&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;radius&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;robust&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;skull&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;surfaces&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;threshold&#39;</span><span class="p">,</span>
                                               <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">]),</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;BET_options&#39;</span><span class="p">)</span>

            <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">BET</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip&#39;</span><span class="p">)</span>
            <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
            
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">([</span>
                <span class="p">(</span><span class="n">inputnode_bet</span><span class="p">,</span> <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="p">[</span>
                    <span class="p">(</span><span class="s1">&#39;frac&#39;</span><span class="p">,</span> <span class="s1">&#39;frac&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;mask_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;mesh_boolean&#39;</span><span class="p">,</span> <span class="s1">&#39;mesh&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;outline&#39;</span><span class="p">,</span> <span class="s1">&#39;outline&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;padding&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;reduce_bias&#39;</span><span class="p">,</span> <span class="s1">&#39;reduce_bias&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;remove_eyes&#39;</span><span class="p">,</span> <span class="s1">&#39;remove_eyes&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;robust&#39;</span><span class="p">,</span> <span class="s1">&#39;robust&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;skull&#39;</span><span class="p">,</span> <span class="s1">&#39;skull&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;surfaces&#39;</span><span class="p">,</span> <span class="s1">&#39;surfaces&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="s1">&#39;threshold&#39;</span><span class="p">),</span>
                    <span class="p">(</span><span class="s1">&#39;vertical_gradient&#39;</span><span class="p">,</span> <span class="s1">&#39;vertical_gradient&#39;</span><span class="p">),</span>
                <span class="p">])</span>
            <span class="p">])</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>

            <span class="c1"># Apply skull-stripping step mask to original volume</span>
            <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">)</span>

            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;niworkflows-ants&#39;</span><span class="p">:</span> 
            <span class="c1"># Skull-stripping using niworkflows-ants  </span>
            <span class="n">anat_skullstrip_ants</span> <span class="o">=</span> <span class="n">init_brain_extraction_wf</span><span class="p">(</span><span class="n">tpl_target_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_template_path</span><span class="p">,</span>
                                                            <span class="n">tpl_mask_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_mask_path</span><span class="p">,</span>
                                                            <span class="n">tpl_regmask_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">niworkflows_ants_regmask_path</span><span class="p">,</span>
                                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_ants&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;inputnode.in_files&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;copy_xform.out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;skullstrip&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;copy_xform.out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_ants</span><span class="p">,</span> <span class="s1">&#39;atropos_wf.copy_xform.out_mask&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mask&#39;</span><span class="p">:</span>

            <span class="n">brain_mask_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask_deoblique&#39;</span><span class="p">)</span>
            <span class="n">brain_mask_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                            <span class="n">brain_mask_deoblique</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">brain_mask_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;brain_mask_reorient&#39;</span><span class="p">)</span>
            <span class="n">brain_mask_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s1">&#39;RPI&#39;</span>
            <span class="n">brain_mask_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_deoblique</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>


            <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">)</span>
            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s1">&#39;a*step(b)&#39;</span>
            <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">brain_mask_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>

            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;unet&#39;</span><span class="p">:</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            UNet</span>
<span class="sd">            options (following numbers are default):</span>
<span class="sd">            input_slice: 3</span>
<span class="sd">            conv_block: 5</span>
<span class="sd">            kernel_root: 16</span>
<span class="sd">            rescale_dim: 256</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># TODO: add options to pipeline_config</span>
            <span class="n">unet_check_for_s3</span> <span class="o">=</span> <span class="n">create_check_for_s3_node</span><span class="p">(</span><span class="s1">&#39;unet&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">unet_model</span><span class="p">)</span>
            <span class="n">unet_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">],</span> 
                                              <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_path&#39;</span><span class="p">],</span>
                                              <span class="n">function</span><span class="o">=</span><span class="n">predict_volumes</span><span class="p">),</span>                        
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unet_mask&#39;</span><span class="p">)</span>
            
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_check_for_s3</span><span class="p">,</span> <span class="s1">&#39;local_path&#39;</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;model_path&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;cimg_in&#39;</span><span class="p">)</span>

            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Revised mask with ANTs</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># fslmaths &lt;whole head&gt; -mul &lt;mask&gt; brain.nii.gz</span>
            <span class="n">unet_masked_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;unet_masked_brain&#39;</span><span class="p">)</span>
            <span class="n">unet_masked_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_mask</span><span class="p">,</span> <span class="s1">&#39;out_path&#39;</span><span class="p">,</span> <span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>

            <span class="c1"># flirt-v-dof6-inbrain.nii.gz-refNMT_SS_0.5mm.nii.gz-obrain_rot2atl-omatbrain_rot2atl.mat-interpsinc</span>
            <span class="c1"># TODO: antsRegistration -z 0 -d 3 -r [NMT_SS_0.5mm.nii.gz,brain.nii.gz,0] -o [transform,brain_rot2atl.nii.gz,brain_inv_rot2atl.nii.gz] -t Rigid[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1 -t Affine[0.1] -m MI[NMT_SS_0.5mm.nii.gz,brain.nii.gz,1,32,Regular,0.25] -c [1000x500x250x100,1e-08,10] -s 3.0x2.0x1.0x0.0 -f 8x4x2x1 -u 1</span>
            <span class="n">native_brain_to_template_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;native_brain_to_template_brain&#39;</span><span class="p">)</span>
            <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">native_brain_to_template_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;sinc&#39;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span> <span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
            
            <span class="c1"># flirt-inhead.nii.gz-refNMT_0.5mm.nii.gz-ohead_rot2atl-applyxfm-initbrain_rot2atl.mat</span>
            <span class="c1"># TODO: antsApplyTransforms -d 3 -i head.nii.gz -r NMT_0.5mm.nii.gz -n Linear -o head_rot2atl.nii.gz -v -t transform1Rigid.mat -t transform2Affine.mat -t transform0DerivedInitialMovingTranslation.mat </span>
            <span class="n">native_head_to_template_head</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;native_head_to_template_head&#39;</span><span class="p">)</span>
            <span class="n">native_head_to_template_head</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> <span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>

            <span class="c1"># fslmathsNMT_SS_0.5mm.nii.gz-bintemplateMask.nii.gz</span>
            <span class="n">template_brain_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">maths</span><span class="o">.</span><span class="n">MathsCommand</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_brain_mask&#39;</span><span class="p">)</span>
            <span class="n">template_brain_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_brain_only_for_anat&#39;</span><span class="p">,</span> <span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="c1"># ANTS 3 -m  CC[head_rot2atl.nii.gz,NMT_0.5mm.nii.gz,1,5] -t SyN[0.25] -r Gauss[3,0] -o atl2T1rot -i 60x50x20 --use-Histogram-Matching  --number-of-affine-iterations 10000x10000x10000x10000x10000 --MI-option 32x16000</span>
            <span class="n">ants_template_head_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">Registration</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_head_to_template&#39;</span><span class="p">)</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CC&#39;</span><span class="p">]</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">metric_weight</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SyN&#39;</span><span class="p">]</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">transform_parameters</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.25</span><span class="p">,)]</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="s1">&#39;NearestNeighbor&#39;</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_iterations</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">60</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">20</span><span class="p">]]</span> 
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">smoothing_sigmas</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.0</span><span class="p">]]</span>
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">shrink_factors</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span> 
            <span class="n">ants_template_head_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">convergence_threshold</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.e-8</span><span class="p">]</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_head_to_template_head</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;fixed_image&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputnode</span><span class="p">,</span> <span class="s1">&#39;template_skull_for_anat&#39;</span><span class="p">,</span> <span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;moving_image&#39;</span><span class="p">)</span>
            <span class="c1"># antsApplyTransforms-d3-itemplateMask.nii.gz-tatl2T1rotWarp.nii.gzatl2T1rotAffine.txt-rbrain_rot2atl.nii.gz-obrain_rot2atl_mask.nii.gz</span>
            <span class="n">template_head_transform_to_template</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">ants</span><span class="o">.</span><span class="n">ApplyTransforms</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_head_transform_to_template&#39;</span><span class="p">)</span>
            <span class="n">template_head_transform_to_template</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;reference_image&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">ants_template_head_to_template</span><span class="p">,</span> <span class="s1">&#39;forward_transforms&#39;</span><span class="p">,</span> <span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)</span>

            <span class="c1"># TODO: replace convert_xfmand flirt with: </span>
            <span class="c1"># antsApplyTransforms -d 3 -i brain_rot2atl_mask.nii.gz -r brain.nii.gz -n linear -o brain_mask.nii.gz -t [transform0DerivedInitialMovingTranslation.mat,1] -t [transform2Affine.mat,1] -t [transform1Rigid.mat,1] </span>
            <span class="c1"># convert_xfm-omatbrain_rot2native.mat-inversebrain_rot2atl.mat</span>
            <span class="n">invt</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;convert_xfm&#39;</span><span class="p">)</span>
            <span class="n">invt</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">native_brain_to_template_brain</span><span class="p">,</span> <span class="s1">&#39;out_matrix_file&#39;</span><span class="p">,</span> <span class="n">invt</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="c1"># flirt -in brain_rot2atl_mask.nii.gz -ref brain.nii.gz -o brain_mask.nii.gz -applyxfm -init brain_rot2native.mat</span>
            <span class="n">template_brain_to_native_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;template_brain_to_native_brain&#39;</span><span class="p">)</span>
            <span class="n">template_brain_to_native_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_head_transform_to_template</span><span class="p">,</span> <span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">unet_masked_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">invt</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>

            <span class="c1"># fslmaths brain_mask.nii.gz -thr .5 -bin brain_mask_thr.nii.gz</span>
            <span class="n">refined_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refined_mask&#39;</span><span class="p">)</span>
            <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">refined_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="s1">&#39;-bin&#39;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">template_brain_to_native_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="c1"># get a new brain with mask</span>
            <span class="n">refined_brain</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">MultiImageMaths</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;refined_brain&#39;</span><span class="p">)</span>
            <span class="n">refined_brain</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">op_string</span> <span class="o">=</span> <span class="s2">&quot;-mul </span><span class="si">%s</span><span class="s2">&quot;</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;operand_files&#39;</span><span class="p">)</span>
            
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">)</span>
            <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">refined_brain</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">outputnode</span><span class="p">,</span> <span class="s1">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index">
              <img class="logo" src="../../../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index">Welcome to CPACs developer documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index#indices-and-tables">Indices and tables</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.7.0 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.anat_preproc.anat_preproc</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, C-PAC Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>
    <script defer src="https://fcp-indi.github.io/scripts/versionList.js"></script>

  </body>
</html>