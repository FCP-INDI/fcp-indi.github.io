
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CPAC.nuisance.nuisance &#8212; C-PAC 1.8.5.dev1 Beta documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="shortcut icon" href="../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../genindex" />
    <link rel="search" title="Search" href="../../../search" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.8.5.dev1 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.nuisance.nuisance</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CPAC.nuisance.nuisance</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2012-2023  C-PAC Developers</span>

<span class="c1"># This file is part of C-PAC.</span>

<span class="c1"># C-PAC is free software: you can redistribute it and/or modify it under</span>
<span class="c1"># the terms of the GNU Lesser General Public License as published by the</span>
<span class="c1"># Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="c1"># option) any later version.</span>

<span class="c1"># C-PAC is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="c1"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="c1"># FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public</span>
<span class="c1"># License for more details.</span>

<span class="c1"># You should have received a copy of the GNU Lesser General Public</span>
<span class="c1"># License along with C-PAC. If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="c1"># pylint: disable=wrong-import-order</span>
<span class="kn">from</span> <span class="nn">CPAC.pipeline</span> <span class="kn">import</span> <span class="n">nipype_pipeline_engine</span> <span class="k">as</span> <span class="n">pe</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="k">as</span> <span class="nn">util</span>
<span class="kn">import</span> <span class="nn">CPAC</span>

<span class="kn">from</span> <span class="nn">nipype</span> <span class="kn">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">fsl</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">ants</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">c3</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">afni</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.afni</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">afni_utils</span>
<span class="kn">from</span> <span class="nn">scipy.fftpack</span> <span class="kn">import</span> <span class="n">fft</span><span class="p">,</span> <span class="n">ifft</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.interfaces.function</span> <span class="kn">import</span> <span class="n">Function</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.interfaces.masktool</span> <span class="kn">import</span> <span class="n">MaskTool</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.interfaces.pc</span> <span class="kn">import</span> <span class="n">PC</span>

<span class="kn">from</span> <span class="nn">CPAC.registration.registration</span> <span class="kn">import</span> <span class="n">warp_timeseries_to_T1template</span><span class="p">,</span> \
    <span class="n">warp_timeseries_to_EPItemplate</span><span class="p">,</span> <span class="n">apply_transform</span>
<span class="kn">from</span> <span class="nn">CPAC.aroma.aroma</span> <span class="kn">import</span> <span class="n">create_aroma</span>

<span class="kn">from</span> <span class="nn">CPAC.nuisance.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">find_offending_time_points</span><span class="p">,</span>
    <span class="n">generate_summarize_tissue_mask</span><span class="p">,</span>
    <span class="n">temporal_variance_mask</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">CPAC.nuisance.utils.compcor</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">calc_compcor_components</span><span class="p">,</span>
    <span class="n">cosine_filter</span><span class="p">,</span>
    <span class="n">TR_string_to_float</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">CPAC.seg_preproc.utils</span> <span class="kn">import</span> <span class="n">erosion</span><span class="p">,</span> <span class="n">mask_erosion</span>

<span class="kn">from</span> <span class="nn">CPAC.utils.datasource</span> <span class="kn">import</span> <span class="n">check_for_s3</span>
<span class="kn">from</span> <span class="nn">CPAC.utils.utils</span> <span class="kn">import</span> <span class="n">check_prov_for_regtool</span>
<span class="kn">from</span> <span class="nn">.bandpass</span> <span class="kn">import</span> <span class="p">(</span><span class="n">bandpass_voxels</span><span class="p">,</span> <span class="n">afni_1dBandpass</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;nipype.workflow&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">choose_nuisance_blocks</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">generate_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to handle selecting appropriate blocks based on</span>
<span class="sd">    existing config and resource pool</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg : CPAC.utils.configuration.Configuration</span>

<span class="sd">    generate_only : boolean</span>
<span class="sd">        generate but don&#39;t run</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nuisance : list</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nuisance</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">to_template_cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">registration_workflows</span><span class="p">[</span><span class="s1">&#39;functional_registration&#39;</span><span class="p">][</span>
        <span class="s1">&#39;func_registration_to_template&#39;</span><span class="p">]</span>
    <span class="n">apply_transform_using</span> <span class="o">=</span> <span class="n">to_template_cfg</span><span class="p">[</span><span class="s1">&#39;apply_transform&#39;</span><span class="p">][</span><span class="s1">&#39;using&#39;</span><span class="p">]</span>
    <span class="n">input_interface</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">]),</span>
        <span class="s1">&#39;abcd&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">,</span> <span class="s1">&#39;bold&#39;</span><span class="p">),</span>
        <span class="s1">&#39;single_step_resampling_from_stc&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;desc-preproc_bold&quot;</span><span class="p">,</span>
                                            <span class="s2">&quot;desc-stc_bold&quot;</span><span class="p">)</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apply_transform_using</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">input_interface</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;T1_template&#39;</span> <span class="ow">in</span> <span class="n">to_template_cfg</span><span class="p">[</span><span class="s1">&#39;target_template&#39;</span><span class="p">][</span><span class="s1">&#39;using&#39;</span><span class="p">]:</span>
            <span class="n">nuisance</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nuisance_regressors_generation_T1w</span><span class="p">,</span>
                             <span class="n">input_interface</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;EPI_template&#39;</span> <span class="ow">in</span> <span class="n">to_template_cfg</span><span class="p">[</span><span class="s1">&#39;target_template&#39;</span><span class="p">][</span><span class="s1">&#39;using&#39;</span><span class="p">]:</span>
            <span class="n">nuisance</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nuisance_regressors_generation_EPItemplate</span><span class="p">,</span>
                             <span class="n">input_interface</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">generate_only</span> <span class="ow">and</span> <span class="s1">&#39;native&#39;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nuisance_corrections&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">,</span>
                                                 <span class="s1">&#39;space&#39;</span><span class="p">]:</span>
            <span class="n">nuisance</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nuisance_regression_native</span><span class="p">,</span> <span class="n">input_interface</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">nuisance</span>


<span class="k">def</span> <span class="nf">erode_mask</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">segmentmap</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;erode_mm&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;erode_prop&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;mask_erode_mm&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eroded_mask&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">form_mask_erosion_prop</span><span class="p">(</span><span class="n">erosion_prop</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">erosion_prop</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
            <span class="n">erosion_prop</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">erosion_prop</span> <span class="o">**</span> <span class="mi">3</span>

    <span class="n">ero_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import scipy.ndimage as nd&#39;</span><span class="p">,</span> <span class="s1">&#39;import numpy as np&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;import nibabel as nb&#39;</span><span class="p">,</span> <span class="s1">&#39;import os&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;from CPAC.seg_preproc.utils import _erode&#39;</span><span class="p">]</span>

    <span class="n">eroded_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span>
        <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;roi_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;skullstrip_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;mask_erosion_mm&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;mask_erosion_prop&#39;</span><span class="p">],</span>
        <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;output_roi_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;eroded_skullstrip_mask&#39;</span><span class="p">],</span>
        <span class="n">function</span><span class="o">=</span><span class="n">mask_erosion</span><span class="p">,</span>
        <span class="n">imports</span><span class="o">=</span><span class="n">ero_imports</span><span class="p">),</span>
                          <span class="n">name</span><span class="o">=</span><span class="s1">&#39;erode_skullstrip_mask&#39;</span><span class="p">,</span>
                          <span class="n">mem_gb</span><span class="o">=</span><span class="mf">2.3</span><span class="p">,</span>
                          <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">4664065662093477</span> <span class="o">/</span> <span class="mi">2417851639229258349412352</span><span class="p">,</span>
                                 <span class="s1">&#39;roi_mask&#39;</span><span class="p">))</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;brain_mask&#39;</span><span class="p">,</span> <span class="n">eroded_mask</span><span class="p">,</span> <span class="s1">&#39;skullstrip_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="n">eroded_mask</span><span class="p">,</span> <span class="s1">&#39;roi_mask&#39;</span><span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;erode_prop&#39;</span><span class="p">,</span> <span class="n">form_mask_erosion_prop</span><span class="p">),</span> <span class="n">eroded_mask</span><span class="p">,</span>
               <span class="s1">&#39;mask_erosion_prop&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;mask_erode_mm&#39;</span><span class="p">,</span> <span class="n">eroded_mask</span><span class="p">,</span> <span class="s1">&#39;mask_erosion_mm&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">segmentmap</span><span class="p">:</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">eroded_mask</span><span class="p">,</span> <span class="s1">&#39;output_roi_mask&#39;</span><span class="p">,</span> <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;eroded_mask&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">segmentmap</span><span class="p">:</span>
        <span class="n">erosion_segmentmap</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;roi_mask&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;erosion_mm&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;erosion_prop&#39;</span>
                                                                <span class="p">],</span>
                                                   <span class="n">output_names</span><span class="o">=</span><span class="p">[</span>
                                                       <span class="s1">&#39;eroded_roi_mask&#39;</span><span class="p">],</span>
                                                   <span class="n">function</span><span class="o">=</span><span class="n">erosion</span><span class="p">,</span>
                                                   <span class="n">imports</span><span class="o">=</span><span class="n">ero_imports</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;erode_mask&#39;</span><span class="p">)</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">eroded_mask</span><span class="p">,</span> <span class="s1">&#39;output_roi_mask&#39;</span><span class="p">,</span> <span class="n">erosion_segmentmap</span><span class="p">,</span> <span class="s1">&#39;roi_mask&#39;</span><span class="p">)</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;erode_prop&#39;</span><span class="p">,</span> <span class="n">erosion_segmentmap</span><span class="p">,</span> <span class="s1">&#39;erosion_prop&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;erode_mm&#39;</span><span class="p">,</span> <span class="n">erosion_segmentmap</span><span class="p">,</span> <span class="s1">&#39;erosion_mm&#39;</span><span class="p">)</span>

        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">erosion_segmentmap</span><span class="p">,</span> <span class="s1">&#39;eroded_roi_mask&#39;</span><span class="p">,</span>
                   <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;eroded_mask&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wf</span>


<span class="k">def</span> <span class="nf">gather_nuisance</span><span class="p">(</span><span class="n">functional_file_path</span><span class="p">,</span>
                    <span class="n">selector</span><span class="p">,</span>
                    <span class="n">grey_matter_summary_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">white_matter_summary_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">csf_summary_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">acompcor_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">tcompcor_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">global_summary_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">motion_parameters_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">custom_file_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">censor_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gathers the various nuisance regressors together into a single tab-</span>
<span class="sd">    separated values file that is an appropriate for input into</span>
<span class="sd">    3dTproject</span>

<span class="sd">    :param functional_file_path: path to file that the regressors are</span>
<span class="sd">        being calculated for, is used to calculate the length of the</span>
<span class="sd">        regressors for error checking and in particular for calculating</span>
<span class="sd">        spike regressors</span>
<span class="sd">    :param output_file_path: path to output TSV that will contain the</span>
<span class="sd">        various nuisance regressors as columns</span>
<span class="sd">    :param grey_matter_summary_file_path: path to TSV that includes</span>
<span class="sd">        summary of grey matter time courses, e.g. output of</span>
<span class="sd">        mask_summarize_time_course</span>
<span class="sd">    :param white_matter_summary_file_path: path to TSV that includes</span>
<span class="sd">        summary of white matter time courses, e.g. output of</span>
<span class="sd">        mask_summarize_time_course</span>
<span class="sd">    :param csf_summary_file_path: path to TSV that includes summary of</span>
<span class="sd">        csf time courses, e.g. output of mask_summarize_time_course</span>
<span class="sd">    :param acompcor_file_path: path to TSV that includes acompcor time</span>
<span class="sd">        courses, e.g. output of mask_summarize_time_course</span>
<span class="sd">    :param tcompcor_file_path: path to TSV that includes tcompcor time</span>
<span class="sd">        courses, e.g. output of mask_summarize_time_course</span>
<span class="sd">    :param global_summary_file_path: path to TSV that includes summary</span>
<span class="sd">        of global time courses, e.g. output of mask_summarize_time_course</span>
<span class="sd">    :param motion_parameters_file_path: path to TSV that includes</span>
<span class="sd">        motion parameters</span>
<span class="sd">    :param custom_file_paths: path to CSV/TSV files to use as regressors</span>
<span class="sd">    :param censor_file_path: path to TSV with a single column with &#39;1&#39;s</span>
<span class="sd">        for indices that should be retained and &#39;0&#39;s for indices that</span>
<span class="sd">        should be censored</span>
<span class="sd">    :return: out_file (str), censor_indices (list)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Basic checks for the functional image</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">functional_file_path</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="ow">not</span> <span class="n">functional_file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nii&quot;</span><span class="p">)</span> <span class="ow">and</span>
         <span class="ow">not</span> <span class="n">functional_file_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nii.gz&quot;</span><span class="p">)):</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for input_file (</span><span class="si">{}</span><span class="s2">). Should be a nifti &quot;</span>
                         <span class="s2">&quot;file and should exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional_file_path</span><span class="p">))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">functional_image</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">functional_file_path</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid value for input_file (</span><span class="si">{}</span><span class="s2">). Should be a nifti &quot;</span>
                         <span class="s2">&quot;file and should exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional_file_path</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">functional_image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">functional_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid input_file (</span><span class="si">{}</span><span class="s2">). Expected 4D file.&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional_file_path</span><span class="p">))</span>

    <span class="n">regressor_length</span> <span class="o">=</span> <span class="n">functional_image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="c1">#selector = selector.selector</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selector</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid type for selectors </span><span class="si">{0}</span><span class="s2">, expecting dict&quot;</span>
                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">selector</span><span class="p">)))</span>

    <span class="n">regressor_files</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;aCompCor&#39;</span><span class="p">:</span> <span class="n">acompcor_file_path</span><span class="p">,</span>
        <span class="s1">&#39;tCompCor&#39;</span><span class="p">:</span> <span class="n">tcompcor_file_path</span><span class="p">,</span>
        <span class="s1">&#39;GlobalSignal&#39;</span><span class="p">:</span> <span class="n">global_summary_file_path</span><span class="p">,</span>
        <span class="s1">&#39;GreyMatter&#39;</span><span class="p">:</span> <span class="n">grey_matter_summary_file_path</span><span class="p">,</span>
        <span class="s1">&#39;WhiteMatter&#39;</span><span class="p">:</span> <span class="n">white_matter_summary_file_path</span><span class="p">,</span>
        <span class="s1">&#39;CerebrospinalFluid&#39;</span><span class="p">:</span> <span class="n">csf_summary_file_path</span><span class="p">,</span>
        <span class="s1">&#39;Motion&#39;</span><span class="p">:</span> <span class="n">motion_parameters_file_path</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">regressors_order</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;Motion&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GlobalSignal&#39;</span><span class="p">,</span>
        <span class="s1">&#39;aCompCor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tCompCor&#39;</span><span class="p">,</span>
        <span class="s1">&#39;CerebrospinalFluid&#39;</span><span class="p">,</span>
        <span class="s1">&#39;WhiteMatter&#39;</span><span class="p">,</span>
        <span class="s1">&#39;GreyMatter&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">motion_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RotY&#39;</span><span class="p">,</span> <span class="s1">&#39;RotX&#39;</span><span class="p">,</span> <span class="s1">&#39;RotZ&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;Z&#39;</span><span class="p">]</span>

    <span class="c1"># Compile regressors into a matrix</span>
    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">nuisance_regressors</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">regressor_type</span> <span class="ow">in</span> <span class="n">regressors_order</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">regressor_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">regressor_file</span> <span class="o">=</span> <span class="n">regressor_files</span><span class="p">[</span><span class="n">regressor_type</span><span class="p">]</span>

        <span class="n">regressor_selector</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;summary&#39;</span> <span class="ow">in</span> <span class="n">regressor_selector</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_file</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Regressor type </span><span class="si">{0}</span><span class="s2"> specified in selectors &quot;</span>
                             <span class="s2">&quot;but the corresponding file was not found!&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Could not read regressor </span><span class="si">{0}</span><span class="s2"> from </span><span class="si">{1}</span><span class="s2">.&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">,</span> <span class="n">regressor_file</span><span class="p">))</span>
            <span class="k">raise</span>

        <span class="k">if</span> <span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">regressor_length</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of time points in </span><span class="si">{0}</span><span class="s2"> (</span><span class="si">{1}</span><span class="s2">) is &quot;</span>
                             <span class="s2">&quot;inconsistent with length of functional &quot;</span>
                             <span class="s2">&quot;file </span><span class="si">{2}</span><span class="s2"> (</span><span class="si">{3}</span><span class="s2">)&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">,</span>
                                     <span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                     <span class="n">functional_file_path</span><span class="p">,</span>
                                     <span class="n">regressor_length</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">regressor_type</span> <span class="o">==</span> <span class="s2">&quot;Motion&quot;</span><span class="p">:</span>
            <span class="n">num_regressors</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;components&#39;</span><span class="p">):</span>
            <span class="n">num_regressors</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_regressors</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">regressors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">regressors</span> <span class="o">=</span> <span class="n">regressors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">num_regressors</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">num_regressors</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Expecting </span><span class="si">{0}</span><span class="s2"> regressors for </span><span class="si">{1}</span><span class="s2">, but &quot;</span>
                             <span class="s2">&quot;found </span><span class="si">{2}</span><span class="s2"> in file </span><span class="si">{3}</span><span class="s2">.&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_regressors</span><span class="p">,</span>
                                     <span class="n">regressor_type</span><span class="p">,</span>
                                     <span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                     <span class="n">regressor_file</span><span class="p">))</span>

        <span class="c1"># Add in the regressors, making sure to also add in the column name</span>
        <span class="k">for</span> <span class="n">regressor_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">regressors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">regressor_type</span> <span class="o">==</span> <span class="s2">&quot;Motion&quot;</span><span class="p">:</span>
                <span class="n">regressor_name</span> <span class="o">=</span> <span class="n">motion_labels</span><span class="p">[</span><span class="n">regressor_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">summary_method</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">summary_method</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
                    <span class="n">summary_method</span> <span class="o">=</span> <span class="n">summary_method</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

                <span class="n">regressor_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">,</span>
                                                    <span class="n">summary_method</span><span class="p">,</span>
                                                    <span class="n">regressor_index</span><span class="p">)</span>

            <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">)</span>
            <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regressors</span><span class="p">[:,</span> <span class="n">regressor_index</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_delayed&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">Delay&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">))</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">regressors</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">regressor_index</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_backdiff&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">BackDiff&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">))</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">regressors</span><span class="p">[:,</span> <span class="n">regressor_index</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_squared&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">Sq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">))</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">regressors</span><span class="p">[:,</span> <span class="n">regressor_index</span><span class="p">])</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_delayed_squared&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">DelaySq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">))</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">regressors</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">regressor_index</span><span class="p">])</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;include_backdiff_squared&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">BackDiffSq&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_name</span><span class="p">))</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">regressors</span><span class="p">[:,</span> <span class="n">regressor_index</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                    <span class="p">)</span>
                <span class="p">)</span>

    <span class="c1"># Add custom regressors</span>
    <span class="k">if</span> <span class="n">custom_file_paths</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">custom_file_path</span> <span class="ow">in</span> <span class="n">custom_file_paths</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">custom_regressor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">custom_file_path</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not read regressor </span><span class="si">{0}</span><span class="s2"> from </span><span class="si">{1}</span><span class="s2">.&quot;</span>
                                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Custom&#39;</span><span class="p">,</span> <span class="n">custom_file_path</span><span class="p">))</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_regressor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">custom_regressor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Invalid format for censor file </span><span class="si">{0}</span><span class="s2">, should be a single &quot;</span>
                    <span class="s2">&quot;column containing 1s for volumes to keep and 0s for volumes &quot;</span>
                    <span class="s2">&quot;to censor.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">custom_file_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_file_path</span><span class="p">)</span>
            <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">custom_regressor</span><span class="p">)</span>

    <span class="n">censor_indices</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># Add spike regressors</span>
    <span class="k">if</span> <span class="n">selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Censor&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;SpikeRegression&#39;</span><span class="p">:</span>

        <span class="n">selector</span> <span class="o">=</span> <span class="n">selector</span><span class="p">[</span><span class="s1">&#39;Censor&#39;</span><span class="p">]</span>

        <span class="n">regressor_file</span> <span class="o">=</span> <span class="n">censor_file_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_file</span><span class="p">:</span>
            <span class="c1">#  This section is gross and temporary </span>
            <span class="n">num_thresh</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selector</span><span class="p">[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">])</span>
            <span class="n">plural_s</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">num_thresh</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s1">&#39;s&#39;</span>
            <span class="n">thresh_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">thresh</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">thresh</span> <span class="ow">in</span> <span class="n">selector</span><span class="p">[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]</span>
            <span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">selector</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> Censor &quot;</span>
                  <span class="s2">&quot;specified with &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;no &#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">num_thresh</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">threshold&quot;</span>
                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plural_s</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">thresh_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> in selectors but &quot;</span>
                  <span class="sa">f</span><span class="s2">&quot; threshold was not reached.&quot;</span><span class="p">)</span>
            <span class="c1">#  This section is gross and temporary </span>
            <span class="c1"># All good to pass through if nothing to censor</span>
            <span class="n">censor_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">regressor_length</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">censor_volumes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Could not read regressor </span><span class="si">{0}</span><span class="s2"> from </span><span class="si">{1}</span><span class="s2">.&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">,</span> <span class="n">regressor_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">censor_volumes</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">censor_volumes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">censor_volumes</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])):</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid format for censor file </span><span class="si">{0}</span><span class="s2">, should be a single &quot;</span>
                <span class="s2">&quot;column containing 1s for volumes to keep and 0s for volumes &quot;</span>
                <span class="s2">&quot;to censor.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_file</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">censor_volumes</span> <span class="o">=</span> <span class="n">censor_volumes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">censor_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">censor_volumes</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">out_of_range_censors</span> <span class="o">=</span> <span class="n">censor_indices</span> <span class="o">&gt;=</span> <span class="n">regressor_length</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">out_of_range_censors</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Censor volumes </span><span class="si">{0}</span><span class="s2"> are out of range&quot;</span>
                <span class="s2">&quot;on censor file </span><span class="si">{1}</span><span class="s2">, calculated &quot;</span>
                <span class="s2">&quot;regressor length is </span><span class="si">{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">censor_indices</span><span class="p">[</span><span class="n">out_of_range_censors</span><span class="p">],</span>
                    <span class="n">regressor_file</span><span class="p">,</span>
                    <span class="n">regressor_length</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">censor_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># if number_of_previous_trs_to_censor and number_of_subsequent_trs_to_censor</span>
            <span class="c1"># are not set, assume they should be zero</span>
            <span class="n">previous_trs_to_censor</span> <span class="o">=</span> \
                <span class="n">selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_of_previous_trs_to_censor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">subsequent_trs_to_censor</span> <span class="o">=</span> \
                <span class="n">selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_of_subsequent_trs_to_censor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="n">spike_regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">regressor_length</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">censor_index</span> <span class="ow">in</span> <span class="n">censor_indices</span><span class="p">:</span>

                <span class="n">censor_begin_index</span> <span class="o">=</span> <span class="n">censor_index</span> <span class="o">-</span> <span class="n">previous_trs_to_censor</span>
                <span class="k">if</span> <span class="n">censor_begin_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">censor_begin_index</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">censor_end_index</span> <span class="o">=</span> <span class="n">censor_index</span> <span class="o">+</span> <span class="n">subsequent_trs_to_censor</span>
                <span class="k">if</span> <span class="n">censor_end_index</span> <span class="o">&gt;=</span> <span class="n">regressor_length</span><span class="p">:</span>
                    <span class="n">censor_end_index</span> <span class="o">=</span> <span class="n">regressor_length</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="n">spike_regressors</span><span class="p">[</span><span class="n">censor_begin_index</span><span class="p">:</span><span class="n">censor_end_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">for</span> <span class="n">censor_index</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spike_regressors</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>

                <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;SpikeRegression</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">censor_index</span><span class="p">))</span>
                <span class="n">spike_regressor_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">regressor_length</span><span class="p">)</span>
                <span class="n">spike_regressor_index</span><span class="p">[</span><span class="n">censor_index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spike_regressor_index</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nuisance_regressors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Compile columns into regressor file</span>
    <span class="n">output_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;nuisance_regressors.1D&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ofd</span><span class="p">:</span>

        <span class="c1"># write out the header information</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# C-PAC </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">CPAC</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Nuisance regressors:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ofd</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# &quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">column_names</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">nuisance_regressors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nuisance_regressors</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span> <span class="n">nuisance_regressors</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.18f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">output_file_path</span><span class="p">,</span> <span class="n">censor_indices</span>


<div class="viewcode-block" id="create_regressor_workflow"><a class="viewcode-back" href="../../../developer/workflows/nuisance#CPAC.nuisance.create_regressor_workflow">[docs]</a><span class="k">def</span> <span class="nf">create_regressor_workflow</span><span class="p">(</span><span class="n">nuisance_selectors</span><span class="p">,</span>
                              <span class="n">use_ants</span><span class="p">,</span>
                              <span class="n">ventricle_mask_exist</span><span class="p">,</span>
                              <span class="n">csf_mask_exist</span><span class="p">,</span>
                              <span class="n">all_bold</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nuisance_regressors&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for the removal of various signals considered to be noise from resting state</span>
<span class="sd">    fMRI data.  The residual signals for linear regression denoising is performed in a single</span>
<span class="sd">    model.  Therefore the residual time-series will be orthogonal to all signals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    :param nuisance_selectors: dictionary describing nuisance regression to be performed</span>
<span class="sd">    :param use_ants: flag indicating whether FNIRT or ANTS is used</span>
<span class="sd">    :param name: Name of the workflow, defaults to &#39;nuisance&#39;</span>
<span class="sd">    :return: nuisance : nipype.pipeline.engine.Workflow</span>
<span class="sd">        Nuisance workflow.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>

<span class="sd">    Workflow Inputs</span>
<span class="sd">    ---------------</span>
<span class="sd">    Workflow Inputs::</span>

<span class="sd">        inputspec.functional_file_path : string (nifti file)</span>
<span class="sd">            Path to realigned and motion corrected functional image (nifti) file.</span>

<span class="sd">        inputspec.functional_brain_mask_file_path : string (nifti file)</span>
<span class="sd">            Whole brain mask corresponding to the functional data.</span>

<span class="sd">        inputspec.anatomical_file_path : string (nifti file)</span>
<span class="sd">            Corresponding preprocessed anatomical.</span>
<span class="sd">        inputspec.wm_mask_file_path : string (nifti file)</span>
<span class="sd">            Corresponding white matter mask.</span>
<span class="sd">        inputspec.csf_mask_file_path : string (nifti file)</span>
<span class="sd">            Corresponding cerebral spinal fluid mask.</span>
<span class="sd">        inputspec.gm_mask_file_path : string (nifti file)</span>
<span class="sd">            Corresponding grey matter mask.</span>
<span class="sd">        inputspec.lat_ventricles_mask_file_path : string (nifti file)</span>
<span class="sd">            Mask of lateral ventricles calculated from the Harvard Oxford Atlas.</span>

<span class="sd">        inputspec.mni_to_anat_linear_xfm_file_path: string (nifti file)</span>
<span class="sd">            FLIRT Linear MNI to Anat transform</span>
<span class="sd">        inputspec.anat_to_mni_initial_xfm_file_path: string (nifti file)</span>
<span class="sd">            ANTS initial transform from anat to MNI</span>
<span class="sd">        inputspec.anat_to_mni_rigid_xfm_file_path: string (nifti file)</span>
<span class="sd">            ANTS rigid (6 parameter, no scaling) transform from anat to MNI</span>
<span class="sd">        inputspec.anat_to_mni_affine_xfm_file_path: string (nifti file)</span>
<span class="sd">            ANTS affine (13 parameter, scales and shears) transform from anat to MNI</span>

<span class="sd">        inputspec.func_to_anat_linear_xfm_file_path: string (nifti file)</span>
<span class="sd">            FLIRT Linear Transform between functional and anatomical spaces</span>

<span class="sd">        inputspec.motion_parameter_file_path : string (text file)</span>
<span class="sd">            Corresponding rigid-body motion parameters. Matrix in the file should be of shape</span>
<span class="sd">            (`T`, `R`), `T` time points and `R` motion parameters.</span>
<span class="sd">        inputspec.fd_j_file_path : string (text file)</span>
<span class="sd">            Framewise displacement calculated from the volume alignment.</span>
<span class="sd">        inputspec.fd_p_file_path : string (text file)</span>
<span class="sd">            Framewise displacement calculated from the motion parameters.</span>
<span class="sd">        inputspec.dvars_file_path : string (text file)</span>
<span class="sd">            DVARS calculated from the functional data.</span>

<span class="sd">        inputspec.selector : Dictionary containing configuration parameters for nuisance regression.</span>
<span class="sd">            To not run a type of nuisance regression, it may be ommited from the dictionary.</span>

<span class="sd">            selector = {</span>
<span class="sd">                aCompCor: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        filter: &#39;cosine&#39;, Principal components are estimated after using a discrete cosine filter with 128s cut-off,</span>
<span class="sd">                            Leave filter field blank, if selected aCompcor method is &#39;DetrendPC&#39;</span>
<span class="sd">                        method: &#39;DetrendPC&#39;, aCompCor will extract the principal components from</span>
<span class="sd">                            detrended tissues signal,</span>
<span class="sd">                        components: number of components to retain,</span>
<span class="sd">                    },</span>
<span class="sd">                    tissues: list of tissues to extract regressors.</span>
<span class="sd">                        Valid values are: &#39;WhiteMatter&#39;, &#39;CerebrospinalFluid&#39;,</span>
<span class="sd">                    extraction_resolution: None | floating point value indicating isotropic</span>
<span class="sd">                        resolution (ex. 2 for 2mm x 2mm x 2mm that data should be extracted at,</span>
<span class="sd">                        the corresponding tissue mask will be resampled to this resolution. The</span>
<span class="sd">                        functional data will also be resampled to this resolution, and the</span>
<span class="sd">                        extraction will occur at this new resolution. The goal is to avoid</span>
<span class="sd">                        contamination from undesired tissue components when extracting nuisance</span>
<span class="sd">                        regressors,</span>
<span class="sd">                    erode_mask: True | False, whether or not the mask should be eroded to</span>
<span class="sd">                        further avoid a mask overlapping with a different tissue class,</span>
<span class="sd">                    include_delayed: True | False, whether or not to include a one-frame delay regressor,</span>
<span class="sd">                        default to False,</span>
<span class="sd">                    include_squared: True | False, whether or not to include a squared regressor,</span>
<span class="sd">                        default to False,</span>
<span class="sd">                    include_delayed_squared: True | False, whether or not to include a squared one-frame</span>
<span class="sd">                        delay regressor, default to False,</span>
<span class="sd">                    include_backdiff: True | False, whether or not to include a one-lag difference,</span>
<span class="sd">                        default to False,</span>
<span class="sd">                    include_backdiff_squared: True | False, whether or not to include a squared one-frame</span>
<span class="sd">                        delay regressor, default to False,</span>
<span class="sd">                },</span>
<span class="sd">                tCompCor: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        filter: &#39;cosine&#39;, Principal components are estimated after using a discrete cosine filter with 128s cut-off,</span>
<span class="sd">                            Leave filter field blank, if selected tCompcor method is &#39;DetrendPC&#39;</span>
<span class="sd">                        method: &#39;DetrendPC&#39;, tCompCor will extract the principal components from</span>
<span class="sd">                            detrended tissues signal,</span>
<span class="sd">                        components: number of components to retain,</span>
<span class="sd">                    },</span>
<span class="sd">                    threshold:</span>
<span class="sd">                        floating point number = cutoff as raw variance value,</span>
<span class="sd">                        floating point number followed by SD (ex. 1.5SD) = mean + a multiple of the SD,</span>
<span class="sd">                        floating point number followed by PCT (ex. 2PCT) = percentile from the top (ex is top 2%),</span>
<span class="sd">                    by_slice: True | False, whether or not the threshold criterion should be applied</span>
<span class="sd">                        by slice or across the entire volume, makes most sense for thresholds</span>
<span class="sd">                        using SD or PCT,</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                WhiteMatter: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        method: &#39;PC&#39;, &#39;DetrendPC&#39;, &#39;Mean&#39;, &#39;NormMean&#39; or &#39;DetrendNormMean&#39;,</span>
<span class="sd">                        components: number of components to retain, if PC,</span>
<span class="sd">                    },</span>
<span class="sd">                    extraction_resolution: None | floating point value (same as for aCompCor),</span>
<span class="sd">                    erode_mask: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                CerebrospinalFluid: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        method: &#39;PC&#39;, &#39;DetrendPC&#39;, &#39;Mean&#39;, &#39;NormMean&#39; or &#39;DetrendNormMean&#39;,</span>
<span class="sd">                        components: number of components to retain, if PC,</span>
<span class="sd">                    },</span>
<span class="sd">                    extraction_resolution: None | floating point value (same as for aCompCor),</span>
<span class="sd">                    erode_mask: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                GreyMatter: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        method: &#39;PC&#39;, &#39;DetrendPC&#39;, &#39;Mean&#39;, &#39;NormMean&#39; or &#39;DetrendNormMean&#39;,</span>
<span class="sd">                        components: number of components to retain, if PC,</span>
<span class="sd">                    },</span>
<span class="sd">                    extraction_resolution: None | floating point value (same as for aCompCor),</span>
<span class="sd">                    erode_mask: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                GlobalSignal: {</span>
<span class="sd">                    summary: {</span>
<span class="sd">                        method: &#39;PC&#39;, &#39;DetrendPC&#39;, &#39;Mean&#39;, &#39;NormMean&#39; or &#39;DetrendNormMean&#39;,</span>
<span class="sd">                        components: number of components to retain, if PC,</span>
<span class="sd">                    },</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                Motion: None | {</span>
<span class="sd">                    include_delayed: True | False (same as for aCompCor),</span>
<span class="sd">                    include_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_delayed_squared: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff: True | False (same as for aCompCor),</span>
<span class="sd">                    include_backdiff_squared: True | False (same as for aCompCor),</span>
<span class="sd">                },</span>
<span class="sd">                Censor: {</span>
<span class="sd">                    method: &#39;Kill&#39;, &#39;Zero&#39;, &#39;Interpolate&#39;, &#39;SpikeRegression&#39;,</span>
<span class="sd">                    thresholds: list of dictionary, {</span>
<span class="sd">                        type: &#39;FD_J&#39;, &#39;FD_P&#39;, &#39;DVARS&#39;,</span>
<span class="sd">                        value: threshold value to be applied to metric</span>
<span class="sd">                    },</span>
<span class="sd">                    number_of_previous_trs_to_censor: integer, number of previous</span>
<span class="sd">                        TRs to censor (remove or regress, if spike regression)</span>
<span class="sd">                    number_of_subsequent_trs_to_censor: integer, number of</span>
<span class="sd">                        subsequent TRs to censor (remove or regress, if spike</span>
<span class="sd">                        regression)</span>
<span class="sd">                },</span>
<span class="sd">                PolyOrt: {</span>
<span class="sd">                    degree: integer, polynomial degree up to which will be removed,</span>
<span class="sd">                        e.g. 2 means constant + linear + quadratic, practically</span>
<span class="sd">                        that is probably, the most that will be need especially</span>
<span class="sd">                        if band pass filtering</span>
<span class="sd">                },</span>
<span class="sd">                Bandpass: {</span>
<span class="sd">                    bottom_frequency: floating point value, frequency in hertz of</span>
<span class="sd">                        the highpass part of the pass band, frequencies below this</span>
<span class="sd">                        will be removed,</span>
<span class="sd">                    top_frequency: floating point value, frequency in hertz of the</span>
<span class="sd">                        lowpass part of the pass band, frequencies above this</span>
<span class="sd">                        will be removed</span>
<span class="sd">                },</span>
<span class="sd">                Custom: [</span>
<span class="sd">                    {</span>
<span class="sd">                        file: file containing the regressors. It can be a CSV file,</span>
<span class="sd">                            with one regressor per column, or a Nifti image, with</span>
<span class="sd">                            one regressor per voxel.</span>
<span class="sd">                        convolve: perform the convolution operation of the given</span>
<span class="sd">                            regressor with the timeseries.</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>

<span class="sd">    Workflow Outputs::</span>

<span class="sd">        outputspec.residual_file_path : string (nifti file)</span>
<span class="sd">            Path of residual file in nifti format</span>
<span class="sd">        outputspec.regressors_file_path : string (TSV file)</span>
<span class="sd">            Path of TSV file of regressors used. Column name indicates the regressors included .</span>
<span class="sd">        outputspec.censor_indices : list</span>
<span class="sd">            Indices of censored volumes</span>

<span class="sd">    Nuisance Procedure:</span>

<span class="sd">    1. Compute nuisance regressors based on input selections.</span>
<span class="sd">    2. Calculate residuals with respect to these nuisance regressors in a</span>
<span class="sd">       single model for every voxel.</span>

<span class="sd">    High Level Workflow Graph:</span>

<span class="sd">    .. exec::</span>
<span class="sd">        from CPAC.nuisance import create_regressor_workflow</span>
<span class="sd">        wf = create_regressor_workflow({</span>
<span class="sd">            &#39;PolyOrt&#39;: {&#39;degree&#39;: 2},</span>
<span class="sd">            &#39;tCompCor&#39;: {&#39;summary&#39;: {&#39;method&#39;: &#39;PC&#39;, &#39;components&#39;: 5}, &#39;threshold&#39;: &#39;1.5SD&#39;, &#39;by_slice&#39;: True},</span>
<span class="sd">            &#39;aCompCor&#39;: {&#39;summary&#39;: {&#39;method&#39;: &#39;PC&#39;, &#39;components&#39;: 5}, &#39;tissues&#39;: [&#39;WhiteMatter&#39;, &#39;CerebrospinalFluid&#39;], &#39;extraction_resolution&#39;: 2},</span>
<span class="sd">            &#39;WhiteMatter&#39;: {&#39;summary&#39;: {&#39;method&#39;: &#39;PC&#39;, &#39;components&#39;: 5}, &#39;extraction_resolution&#39;: 2},</span>
<span class="sd">            &#39;CerebrospinalFluid&#39;: {&#39;summary&#39;: {&#39;method&#39;: &#39;PC&#39;, &#39;components&#39;: 5}, &#39;extraction_resolution&#39;: 2, &#39;erode_mask&#39;: True},</span>
<span class="sd">            &#39;GreyMatter&#39;: {&#39;summary&#39;: {&#39;method&#39;: &#39;PC&#39;, &#39;components&#39;: 5}, &#39;extraction_resolution&#39;: 2, &#39;erode_mask&#39;: True},</span>
<span class="sd">            &#39;GlobalSignal&#39;: {&#39;summary&#39;: &#39;Mean&#39;, &#39;include_delayed&#39;: True, &#39;include_squared&#39;: True, &#39;include_delayed_squared&#39;: True},</span>
<span class="sd">            &#39;Motion&#39;: {&#39;include_delayed&#39;: True, &#39;include_squared&#39;: True, &#39;include_delayed_squared&#39;: True},</span>
<span class="sd">            &#39;Censor&#39;: {&#39;method&#39;: &#39;Interpolate&#39;, &#39;thresholds&#39;: [{&#39;type&#39;: &#39;FD_J&#39;, &#39;value&#39;: 0.5}, {&#39;type&#39;: &#39;DVARS&#39;, &#39;value&#39;: 0.7}]}</span>
<span class="sd">        }, use_ants=False)</span>

<span class="sd">        wf.write_graph(</span>
<span class="sd">            graph2use=&#39;orig&#39;,</span>
<span class="sd">            dotfilename=&#39;./images/generated/nuisance.dot&#39;</span>
<span class="sd">        )</span>

<span class="sd">    .. image:: ../../images/generated/nuisance.png</span>
<span class="sd">       :width: 1000</span>

<span class="sd">    Detailed Workflow Graph:</span>

<span class="sd">    .. image:: ../../images/generated/nuisance_detailed.png</span>
<span class="sd">       :width: 1000</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">nuisance_wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">inputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;selector&#39;</span><span class="p">,</span>
        <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anatomical_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anatomical_eroded_brain_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gm_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;wm_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;csf_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;lat_ventricles_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;func_to_anat_linear_xfm_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anat_to_func_linear_xfm_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;mni_to_anat_linear_xfm_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;anat_to_mni_linear_xfm_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;motion_parameters_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fd_j_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fd_p_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dvars_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;creds_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dl_dir&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tr&#39;</span><span class="p">,</span>
    <span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span>
        <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;regressors_file_path&#39;</span><span class="p">,</span> <span class="s1">&#39;censor_indices&#39;</span><span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">functional_mean</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni_utils</span><span class="o">.</span><span class="n">TStat</span><span class="p">(),</span>
                              <span class="n">name</span><span class="o">=</span><span class="s1">&#39;functional_mean&#39;</span><span class="p">)</span>

    <span class="n">functional_mean</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;-mean&#39;</span>
    <span class="n">functional_mean</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
                        <span class="n">functional_mean</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="c1"># Resources to create regressors</span>
    <span class="n">pipeline_resource_pool</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Anatomical&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;anatomical_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;AnatomicalErodedMask&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;anatomical_eroded_brain_mask_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Functional&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Functional_mean&quot;</span> <span class="p">:</span> <span class="p">(</span><span class="n">functional_mean</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">),</span>
        <span class="s2">&quot;GlobalSignal&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;WhiteMatter&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;wm_mask_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;CerebrospinalFluid&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;csf_mask_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;GreyMatter&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;gm_mask_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Ventricles&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;lat_ventricles_mask_file_path&#39;</span><span class="p">),</span>

        <span class="s2">&quot;Transformations&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;func_to_anat_linear_xfm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;func_to_anat_linear_xfm_file_path&quot;</span><span class="p">),</span>
            <span class="s2">&quot;anat_to_func_linear_xfm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;anat_to_func_linear_xfm_file_path&quot;</span><span class="p">),</span>
            <span class="s2">&quot;mni_to_anat_linear_xfm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;mni_to_anat_linear_xfm_file_path&quot;</span><span class="p">),</span>
            <span class="s2">&quot;anat_to_mni_linear_xfm&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;anat_to_mni_linear_xfm_file_path&quot;</span><span class="p">)</span>
        <span class="p">},</span>

        <span class="s2">&quot;DVARS&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;dvars_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;FD_J&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;framewise_displacement_j_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;FD_P&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;framewise_displacement_p_file_path&#39;</span><span class="p">),</span>
        <span class="s2">&quot;Motion&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;motion_parameters_file_path&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="c1"># Regressor map to simplify construction of the needed regressors</span>
    <span class="n">regressors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;GreyMatter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;grey_matter_summary_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;WhiteMatter&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;white_matter_summary_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;CerebrospinalFluid&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;csf_summary_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;aCompCor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;acompcor_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tCompCor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tcompcor_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;GlobalSignal&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;global_summary_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Custom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;custom_file_paths&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;VoxelCustom&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;custom_file_paths&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;dsort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;DVARS&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;dvars_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;FD_J&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;framewise_displacement_j_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;FD_P&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;framewise_displacement_p_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">],</span>
        <span class="s1">&#39;Motion&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;motion_parameters_file_path&#39;</span><span class="p">,</span> <span class="p">(),</span> <span class="s1">&#39;ort&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">motion</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DVARS&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_J&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_P&#39;</span><span class="p">,</span> <span class="s1">&#39;Motion&#39;</span><span class="p">]</span>
    <span class="n">derived</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tCompCor&#39;</span><span class="p">,</span> <span class="s1">&#39;aCompCor&#39;</span><span class="p">]</span>
    <span class="n">tissues</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;GreyMatter&#39;</span><span class="p">,</span> <span class="s1">&#39;WhiteMatter&#39;</span><span class="p">,</span> <span class="s1">&#39;CerebrospinalFluid&#39;</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">regressor_type</span><span class="p">,</span> <span class="n">regressor_resource</span> <span class="ow">in</span> <span class="n">regressors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="k">if</span> <span class="n">regressor_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nuisance_selectors</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">regressor_selector</span> <span class="o">=</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="n">regressor_type</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">regressor_type</span> <span class="o">==</span> <span class="s1">&#39;Custom&#39;</span><span class="p">:</span>

            <span class="n">custom_ort_check_s3_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">custom_dsort_check_s3_nodes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">custom_dsort_convolve_nodes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">file_num</span><span class="p">,</span> <span class="n">custom_regressor</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span>
                <span class="n">regressor_selector</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="p">)):</span>
                <span class="n">custom_regressor_file</span> <span class="o">=</span> <span class="n">custom_regressor</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>

                <span class="n">custom_check_s3_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span>
                    <span class="n">input_names</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;file_path&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;creds_path&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;dl_dir&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;img_type&#39;</span>
                    <span class="p">],</span>
                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span>
                        <span class="s1">&#39;local_path&#39;</span>
                    <span class="p">],</span>
                    <span class="n">function</span><span class="o">=</span><span class="n">check_for_s3</span><span class="p">,</span>
                    <span class="n">as_module</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;custom_check_for_s3_</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">file_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="n">custom_check_s3_node</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                    <span class="n">file_path</span><span class="o">=</span><span class="n">custom_regressor_file</span><span class="p">,</span>
                    <span class="n">img_type</span><span class="o">=</span><span class="s1">&#39;func&#39;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">custom_regressor_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">custom_regressor_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii&#39;</span><span class="p">)</span>
                <span class="p">):</span>

                    <span class="k">if</span> <span class="n">custom_regressor</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;convolve&#39;</span><span class="p">):</span>
                        <span class="n">custom_dsort_convolve_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">custom_check_s3_node</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">custom_dsort_check_s3_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">custom_check_s3_node</span><span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">custom_ort_check_s3_nodes</span> <span class="o">+=</span> <span class="p">[</span><span class="n">custom_check_s3_node</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_ort_check_s3_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">custom_ort_merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_ort_check_s3_nodes</span><span class="p">)),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom_ort_merge&#39;</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">custom_check_s3_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">custom_ort_check_s3_nodes</span><span class="p">):</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">custom_check_s3_node</span><span class="p">,</span> <span class="s1">&#39;local_path&#39;</span><span class="p">,</span>
                        <span class="n">custom_ort_merge</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;custom_ort_file_paths&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">custom_ort_merge</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>

                <span class="n">regressors</span><span class="p">[</span><span class="s1">&#39;Custom&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;custom_ort_file_paths&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_convolve_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">custom_dsort_convolve_merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_convolve_nodes</span><span class="p">)),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom_dsort_convolve_merge&#39;</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">custom_check_s3_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">custom_dsort_convolve_nodes</span><span class="p">):</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">custom_check_s3_node</span><span class="p">,</span> <span class="s1">&#39;local_path&#39;</span><span class="p">,</span>
                        <span class="n">custom_dsort_convolve_merge</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_check_s3_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

                <span class="n">images_to_merge</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_check_s3_nodes</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_convolve_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">images_to_merge</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="n">custom_dsort_merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="n">images_to_merge</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom_dsort_merge&#39;</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">custom_check_s3_node</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">custom_dsort_check_s3_nodes</span><span class="p">):</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">custom_check_s3_node</span><span class="p">,</span> <span class="s1">&#39;local_path&#39;</span><span class="p">,</span>
                        <span class="n">custom_dsort_merge</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">custom_dsort_convolve_nodes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">custom_dsort_convolve_merge</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span>
                        <span class="n">custom_dsort_merge</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;custom_dsort_file_paths&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">custom_dsort_merge</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">)</span>

                <span class="n">regressors</span><span class="p">[</span><span class="s1">&#39;VoxelCustom&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;custom_dsort_file_paths&#39;</span><span class="p">]</span>

            <span class="k">continue</span>

        <span class="k">if</span> <span class="n">regressor_type</span> <span class="ow">in</span> <span class="n">motion</span><span class="p">:</span>
            <span class="n">regressor_resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">regressor_type</span><span class="p">]</span>
            <span class="k">continue</span>

        <span class="c1"># Set summary method for tCompCor and aCompCor</span>
        <span class="k">if</span> <span class="n">regressor_type</span> <span class="ow">in</span> <span class="n">derived</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;summary&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">regressor_selector</span><span class="p">:</span>
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Regressor </span><span class="si">{0}</span><span class="s2"> requires PC summary method, &quot;</span>
                                 <span class="s2">&quot;but </span><span class="si">{1}</span><span class="s2"> specified&quot;</span>
                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">,</span>
                                         <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;components&#39;</span><span class="p">):</span>
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># If regressor is not present, build up the regressor</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>

            <span class="c1"># We don&#39;t have the regressor, look for it in the resource pool,</span>
            <span class="c1"># build a corresponding key, this is seperated in to a mask key</span>
            <span class="c1"># and an extraction key, which when concatenated provide the</span>
            <span class="c1"># resource key for the regressor</span>
            <span class="n">regressor_descriptor</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">regressor_type</span><span class="p">}</span>

            <span class="k">if</span> <span class="n">regressor_type</span> <span class="o">==</span> <span class="s1">&#39;aCompCor&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tissues&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tissue type required for aCompCor, &quot;</span>
                                     <span class="s2">&quot;but none specified&quot;</span><span class="p">)</span>

                <span class="n">regressor_descriptor</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;tissues&#39;</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="k">if</span> <span class="n">regressor_type</span> <span class="o">==</span> <span class="s1">&#39;tCompCor&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Threshold required for tCompCor, &quot;</span>
                                     <span class="s2">&quot;but none specified.&quot;</span><span class="p">)</span>

                <span class="n">regressor_descriptor</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">&#39;tissue&#39;</span><span class="p">:</span> <span class="s1">&#39;FunctionalVariance-</span><span class="si">{}</span><span class="s1">&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">])</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;by_slice&#39;</span><span class="p">):</span>
                    <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;-BySlice&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;by_slice&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;erode_mask_mm&#39;</span><span class="p">):</span>
                    <span class="n">erosion_mm</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;erode_mask_mm&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">erosion_mm</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
                    <span class="n">degree</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">degree</span> <span class="o">=</span> <span class="mi">1</span>

                <span class="n">temporal_wf</span> <span class="o">=</span> <span class="n">temporal_variance_mask</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;threshold&#39;</span><span class="p">],</span>
                                                     <span class="n">by_slice</span><span class="o">=</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;by_slice&#39;</span><span class="p">],</span>
                                                     <span class="n">erosion</span><span class="o">=</span><span class="n">erosion_mm</span><span class="p">,</span>
                                                     <span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">)</span>

                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Functional&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">temporal_wf</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">erosion_mm</span><span class="p">:</span> <span class="c1"># TODO: in func/anat space</span>
                    <span class="c1"># transform eroded anat brain mask to functional space</span>
                    <span class="c1"># convert_xfm</span>
                    <span class="n">anat_to_func_linear_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anat_to_func_linear_xfm&#39;</span><span class="p">)</span>
                    <span class="n">anat_to_func_linear_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Transformations&#39;</span><span class="p">][</span><span class="s1">&#39;func_to_anat_linear_xfm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">anat_to_func_linear_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)))</span>

                    <span class="c1"># flirt</span>
                    <span class="n">anat_to_func_mask</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Functional_eroded_mask&#39;</span><span class="p">)</span>
                    <span class="n">anat_to_func_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">output_type</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
                    <span class="n">anat_to_func_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">anat_to_func_mask</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;nearestneighbour&#39;</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_to_func_linear_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">anat_to_func_mask</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;AnatomicalErodedMask&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">anat_to_func_mask</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)))</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;GlobalSignal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">anat_to_func_mask</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)))</span>

                    <span class="c1"># connect workflow</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_to_func_mask</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="n">temporal_wf</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask_file_path&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;GlobalSignal&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">temporal_wf</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask_file_path&#39;</span><span class="p">)))</span>

                <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="p">(</span><span class="n">temporal_wf</span><span class="p">,</span> <span class="s1">&#39;outputspec.mask&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span>
                <span class="p">}</span>

            <span class="c1"># Add selector into regressor description</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">):</span>
                <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="nb">str</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;mm&quot;</span>

            <span class="k">elif</span> <span class="n">regressor_type</span> <span class="ow">in</span> <span class="n">tissues</span><span class="p">:</span>
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Functional&quot;</span>
                <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;resolution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Functional&quot;</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;erode_mask&#39;</span><span class="p">):</span>
                <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;erosion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Eroded&#39;</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;summary&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Summary method required for </span><span class="si">{0}</span><span class="s2">, &quot;</span>
                                 <span class="s2">&quot;but none specified&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">))</span>

            <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;extraction&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;extraction&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DetrendPC&#39;</span><span class="p">,</span> <span class="s1">&#39;PC&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;components&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Summary method PC requires components, &quot;</span>
                                     <span class="s2">&quot;but received none.&quot;</span><span class="p">)</span>

                <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;extraction&#39;</span><span class="p">]</span> <span class="o">+=</span> \
                    <span class="s1">&#39;_</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">])</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span><span class="p">:</span>
                <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                    <span class="n">regressor_selector</span><span class="p">[</span><span class="s2">&quot;extraction_resolution&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Functional&quot;</span><span class="p">:</span>

                <span class="n">functional_at_resolution_key</span> <span class="o">=</span> <span class="s2">&quot;Functional_</span><span class="si">{0}</span><span class="s2">mm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">regressor_selector</span><span class="p">[</span><span class="s2">&quot;extraction_resolution&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="n">anatomical_at_resolution_key</span> <span class="o">=</span> <span class="s2">&quot;Anatomical_</span><span class="si">{0}</span><span class="s2">mm&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">regressor_selector</span><span class="p">[</span><span class="s2">&quot;extraction_resolution&quot;</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">anatomical_at_resolution_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_resource_pool</span><span class="p">:</span>

                    <span class="n">anat_resample</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                        <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_flirt&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">anatomical_at_resolution_key</span><span class="p">),</span>
                        <span class="n">mem_gb</span><span class="o">=</span><span class="mf">3.63</span><span class="p">,</span>
                        <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">3767129957844731</span> <span class="o">/</span> <span class="mi">1208925819614629174706176</span><span class="p">,</span>
                               <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">anat_resample</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_isoxfm</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s2">&quot;extraction_resolution&quot;</span><span class="p">]</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Anatomical&#39;</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">anat_resample</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
                    <span class="p">))</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Anatomical&#39;</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">anat_resample</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="p">))</span>

                    <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">anatomical_at_resolution_key</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">anat_resample</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">functional_at_resolution_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_resource_pool</span><span class="p">:</span>

                    <span class="n">func_resample</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                        <span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">FLIRT</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_flirt&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">functional_at_resolution_key</span><span class="p">),</span>
                        <span class="n">mem_gb</span><span class="o">=</span><span class="mf">0.521</span><span class="p">,</span>
                        <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">4394984950818853</span> <span class="o">/</span> <span class="mi">302231454903657293676544</span><span class="p">,</span>
                               <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">func_resample</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">apply_xfm</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Transformations&#39;</span><span class="p">][</span><span class="s1">&#39;func_to_anat_linear_xfm&#39;</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">func_resample</span><span class="p">,</span> <span class="s1">&#39;in_matrix_file&#39;</span><span class="p">)</span>
                    <span class="p">))</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="s1">&#39;Functional&#39;</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">func_resample</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
                    <span class="p">))</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="o">*</span><span class="p">(</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">anatomical_at_resolution_key</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="n">func_resample</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">)</span>
                    <span class="p">))</span>

                    <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">functional_at_resolution_key</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="p">(</span><span class="n">func_resample</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

            <span class="c1"># Create merger to summarize the functional timeseries</span>
            <span class="n">regressor_mask_file_resource_keys</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tissue</span> <span class="ow">in</span> <span class="n">regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]:</span>

                <span class="c1"># Ignore non tissue masks</span>
                <span class="k">if</span> <span class="n">tissue</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tissues</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="n">tissue</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;FunctionalVariance&#39;</span><span class="p">):</span>
                    <span class="n">regressor_mask_file_resource_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">tissue</span><span class="p">]</span>
                    <span class="k">continue</span>

                <span class="n">tissue_regressor_descriptor</span> <span class="o">=</span> <span class="n">regressor_descriptor</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">tissue_regressor_descriptor</span><span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tissue</span>

                <span class="c1"># Generate resource masks</span>
                <span class="p">(</span><span class="n">pipeline_resource_pool</span><span class="p">,</span>
                 <span class="n">regressor_mask_file_resource_key</span><span class="p">)</span> <span class="o">=</span> \
                    <span class="n">generate_summarize_tissue_mask</span><span class="p">(</span>
                        <span class="n">nuisance_wf</span><span class="p">,</span>
                        <span class="n">pipeline_resource_pool</span><span class="p">,</span>
                        <span class="n">tissue_regressor_descriptor</span><span class="p">,</span>
                        <span class="n">regressor_selector</span><span class="p">,</span>
                        <span class="n">csf_mask_exist</span><span class="p">,</span>
                        <span class="n">use_ants</span><span class="o">=</span><span class="n">use_ants</span><span class="p">,</span>
                        <span class="n">ventricle_mask_exist</span><span class="o">=</span><span class="n">ventricle_mask_exist</span><span class="p">,</span>
                        <span class="n">all_bold</span><span class="o">=</span><span class="n">all_bold</span>
                    <span class="p">)</span>

                <span class="n">regressor_mask_file_resource_keys</span> <span class="o">+=</span> \
                    <span class="p">[</span><span class="n">regressor_mask_file_resource_key</span><span class="p">]</span>

            <span class="c1"># Keep tissues ordered, to avoid duplicates</span>
            <span class="n">regressor_mask_file_resource_keys</span> <span class="o">=</span> \
                <span class="nb">list</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">regressor_mask_file_resource_keys</span><span class="p">))</span>

            <span class="c1"># Create key for the final regressors</span>
            <span class="n">regressor_file_resource_key</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regressor_descriptor</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">regressor_descriptor</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">==</span> <span class="nb">list</span>
                <span class="k">else</span> <span class="n">regressor_descriptor</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tissue&#39;</span><span class="p">,</span> <span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="s1">&#39;erosion&#39;</span><span class="p">,</span> <span class="s1">&#39;extraction&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">regressor_descriptor</span>
            <span class="p">])</span>

            <span class="k">if</span> <span class="n">regressor_file_resource_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pipeline_resource_pool</span><span class="p">:</span>

                <span class="c1"># Merge mask paths to extract voxel timeseries</span>
                <span class="n">merge_masks_paths</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">regressor_mask_file_resource_keys</span><span class="p">)),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_merge_masks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">regressor_mask_file_resource_key</span> <span class="ow">in</span> \
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">regressor_mask_file_resource_keys</span><span class="p">):</span>

                    <span class="n">node</span><span class="p">,</span> <span class="n">node_output</span> <span class="o">=</span> \
                        <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">regressor_mask_file_resource_key</span><span class="p">]</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">node</span><span class="p">,</span> <span class="n">node_output</span><span class="p">,</span>
                        <span class="n">merge_masks_paths</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">union_masks_paths</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">MaskTool</span><span class="p">(</span><span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_union_masks&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">),</span>
                    <span class="n">mem_gb</span><span class="o">=</span><span class="mf">2.1</span><span class="p">,</span>
                    <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">1708448960473801</span> <span class="o">/</span> <span class="mi">1208925819614629174706176</span><span class="p">,</span>
                           <span class="s1">&#39;in_files&#39;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">merge_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span>
                    <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;in_files&#39;</span>
                <span class="p">)</span>

                <span class="n">functional_key</span> <span class="o">=</span> <span class="s1">&#39;Functional&#39;</span>
                <span class="k">if</span> <span class="n">regressor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                        <span class="n">regressor_selector</span><span class="p">[</span><span class="s2">&quot;extraction_resolution&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Functional&quot;</span><span class="p">:</span>

                    <span class="n">functional_key</span> <span class="o">=</span> <span class="s1">&#39;Functional_</span><span class="si">{}</span><span class="s1">mm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;extraction_resolution&#39;</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="n">summary_filter</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">summary_filter_input</span> <span class="o">=</span> <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">functional_key</span><span class="p">]</span>

                <span class="n">summary_method</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span>
                <span class="n">summary_method_input</span> <span class="o">=</span> <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">functional_key</span><span class="p">]</span>

                <span class="k">if</span> <span class="s1">&#39;DetrendPC&#39;</span> <span class="ow">in</span> <span class="n">summary_method</span><span class="p">:</span>

                    <span class="n">compcor_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import os&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;import scipy.signal as signal&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;import nibabel as nb&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;import numpy as np&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;from CPAC.utils import safe_shape&#39;</span><span class="p">]</span>

                    <span class="n">compcor_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;data_filename&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;num_components&#39;</span><span class="p">,</span>
                                                                 <span class="s1">&#39;mask_filename&#39;</span><span class="p">],</span>
                                                    <span class="n">output_names</span><span class="o">=</span><span class="p">[</span>
                                                        <span class="s1">&#39;compcor_file&#39;</span><span class="p">],</span>
                                                    <span class="n">function</span><span class="o">=</span><span class="n">calc_compcor_components</span><span class="p">,</span>
                                                    <span class="n">imports</span><span class="o">=</span><span class="n">compcor_imports</span><span class="p">),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_DetrendPC&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">),</span>
                                           <span class="n">mem_gb</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
                                           <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">3811976743057169</span> <span class="o">/</span>
                                                  <span class="mi">151115727451828646838272</span><span class="p">,</span>
                                                  <span class="s1">&#39;data_filename&#39;</span><span class="p">))</span>

                    <span class="n">compcor_node</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">num_components</span> <span class="o">=</span> <span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">]</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">compcor_node</span><span class="p">,</span> <span class="s1">&#39;data_filename&#39;</span>
                    <span class="p">)</span>

                    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                        <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">compcor_node</span><span class="p">,</span> <span class="s1">&#39;mask_filename&#39;</span>
                    <span class="p">)</span>

                    <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">compcor_node</span><span class="p">,</span> <span class="s1">&#39;compcor_file&#39;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;cosine&#39;</span> <span class="ow">in</span> <span class="n">summary_filter</span><span class="p">:</span>
                        <span class="n">cosfilter_imports</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;import os&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;import numpy as np&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;import nibabel as nb&#39;</span><span class="p">,</span>
                                             <span class="s1">&#39;from nipype import logging&#39;</span><span class="p">]</span>

                        <span class="n">cosfilter_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_image_path&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;timestep&#39;</span><span class="p">],</span>
                                          <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;cosfiltered_img&#39;</span><span class="p">],</span>
                                          <span class="n">function</span><span class="o">=</span><span class="n">cosine_filter</span><span class="p">,</span>
                                          <span class="n">imports</span><span class="o">=</span><span class="n">cosfilter_imports</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_cosine_filter&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">),</span>
                            <span class="n">mem_gb</span><span class="o">=</span><span class="mf">8.0</span><span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_filter_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_filter_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">cosfilter_node</span><span class="p">,</span> <span class="s1">&#39;input_image_path&#39;</span>
                        <span class="p">)</span>
                        <span class="n">tr_string2float_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tr&#39;</span><span class="p">],</span>
                                                                     <span class="n">output_names</span><span class="o">=</span><span class="p">[</span>
                                                                         <span class="s1">&#39;tr_float&#39;</span><span class="p">],</span>
                                                                     <span class="n">function</span><span class="o">=</span><span class="n">TR_string_to_float</span><span class="p">),</span>
                                                       <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_tr_string2float&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">))</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">,</span>
                            <span class="n">tr_string2float_node</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span>
                        <span class="p">)</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">tr_string2float_node</span><span class="p">,</span> <span class="s1">&#39;tr_float&#39;</span><span class="p">,</span>
                            <span class="n">cosfilter_node</span><span class="p">,</span> <span class="s1">&#39;timestep&#39;</span>
                        <span class="p">)</span>

                        <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">cosfilter_node</span><span class="p">,</span> <span class="s1">&#39;cosfiltered_img&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Detrend&#39;</span> <span class="ow">in</span> <span class="n">summary_method</span><span class="p">:</span>

                        <span class="n">detrend_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">Detrend</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;-polort 1&#39;</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_detrend&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">detrend_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span>
                        <span class="p">)</span>

                        <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">detrend_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Norm&#39;</span> <span class="ow">in</span> <span class="n">summary_method</span><span class="p">:</span>

                        <span class="n">l2norm_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">TStat</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;-l2norm&#39;</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_l2norm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">l2norm_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">l2norm_node</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span>
                        <span class="p">)</span>

                        <span class="n">norm_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="s1">&#39;a/b&#39;</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_norm&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">),</span>
                            <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.7</span><span class="p">,</span>
                            <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">1233286593342025</span> <span class="o">/</span>
                                   <span class="mi">151115727451828646838272</span><span class="p">,</span>
                                   <span class="s1">&#39;in_file_a&#39;</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">norm_node</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">l2norm_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">norm_node</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span>
                        <span class="p">)</span>

                        <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;Mean&#39;</span> <span class="ow">in</span> <span class="n">summary_method</span><span class="p">:</span>

                        <span class="n">mean_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">ROIStats</span><span class="p">(</span><span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="s1">&#39;-1Dformat&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_mean&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">),</span>
                            <span class="n">mem_gb</span><span class="o">=</span><span class="mf">5.0</span>
                        <span class="p">)</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">mean_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span>
                        <span class="p">)</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">mean_node</span><span class="p">,</span> <span class="s1">&#39;mask_file&#39;</span>
                        <span class="p">)</span>

                        <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="s1">&#39;PC&#39;</span> <span class="ow">in</span> <span class="n">summary_method</span><span class="p">:</span>

                        <span class="n">std_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">TStat</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;-nzstdev&#39;</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_std&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">std_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">std_node</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span>
                        <span class="p">)</span>

                        <span class="n">standardized_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">afni</span><span class="o">.</span><span class="n">Calc</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="s1">&#39;a/b&#39;</span><span class="p">,</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_standardized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">summary_method_input</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">standardized_node</span><span class="p">,</span> <span class="s1">&#39;in_file_a&#39;</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">std_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">standardized_node</span><span class="p">,</span> <span class="s1">&#39;in_file_b&#39;</span>
                        <span class="p">)</span>

                        <span class="n">pc_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                            <span class="n">PC</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;-vmean -nscale&#39;</span><span class="p">,</span> <span class="n">pcs</span><span class="o">=</span><span class="n">regressor_selector</span><span class="p">[</span><span class="s1">&#39;summary&#39;</span><span class="p">][</span><span class="s1">&#39;components&#39;</span><span class="p">],</span> <span class="n">outputtype</span><span class="o">=</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_pc&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">regressor_type</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">standardized_node</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">pc_node</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span>
                        <span class="p">)</span>
                        <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                            <span class="n">union_masks_paths</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">pc_node</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span>
                        <span class="p">)</span>

                        <span class="n">summary_method_input</span> <span class="o">=</span> <span class="p">(</span><span class="n">pc_node</span><span class="p">,</span> <span class="s1">&#39;pcs_file&#39;</span><span class="p">)</span>

                <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">regressor_file_resource_key</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">summary_method_input</span>

                <span class="c1"># Add it to internal resource pool</span>
                <span class="n">regressor_resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> \
                    <span class="n">pipeline_resource_pool</span><span class="p">[</span><span class="n">regressor_file_resource_key</span><span class="p">]</span>

    <span class="c1"># Build regressors and combine them into a single file</span>
    <span class="n">build_nuisance_regressors</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span>
        <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;selector&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;grey_matter_summary_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;white_matter_summary_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;csf_summary_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;acompcor_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;tcompcor_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;global_summary_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;motion_parameters_file_path&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;custom_file_paths&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;censor_file_path&#39;</span><span class="p">],</span>
        <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;censor_indices&#39;</span><span class="p">],</span>
        <span class="n">function</span><span class="o">=</span><span class="n">gather_nuisance</span><span class="p">,</span>
        <span class="n">as_module</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;build_nuisance_regressors&quot;</span><span class="p">)</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
        <span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
        <span class="n">build_nuisance_regressors</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span>
    <span class="p">)</span>

    <span class="n">build_nuisance_regressors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">selector</span> <span class="o">=</span> <span class="n">nuisance_selectors</span>

    <span class="c1"># Check for any regressors to combine into files</span>
    <span class="n">has_nuisance_regressors</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">regressor_node</span>
        <span class="k">for</span> <span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span><span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span><span class="p">)</span>
        <span class="ow">in</span> <span class="n">regressors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">regressor_target</span> <span class="o">==</span> <span class="s1">&#39;ort&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">has_nuisance_regressors</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">regressors</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">regressor_target</span> <span class="o">!=</span> <span class="s1">&#39;ort&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">regressor_key</span> <span class="ow">in</span> <span class="n">nuisance_selectors</span><span class="p">:</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                    <span class="n">regressor_node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">regressor_node</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">build_nuisance_regressors</span><span class="p">,</span> <span class="n">regressor_arg</span>
                <span class="p">)</span>

    <span class="c1"># Check for any regressors to combine into files</span>
    <span class="n">has_voxel_nuisance_regressors</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
        <span class="n">regressor_node</span>
        <span class="k">for</span> <span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="n">regressors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">regressor_target</span> <span class="o">==</span> <span class="s1">&#39;dsort&#39;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">has_voxel_nuisance_regressors</span><span class="p">:</span>

        <span class="n">voxel_nuisance_regressors</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span><span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span>
                <span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span>
            <span class="p">)</span> <span class="ow">in</span> <span class="n">regressors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">regressor_target</span> <span class="o">==</span> <span class="s1">&#39;dsort&#39;</span>
        <span class="p">]</span>

        <span class="n">voxel_nuisance_regressors_merge</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
            <span class="n">util</span><span class="o">.</span><span class="n">Merge</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">voxel_nuisance_regressors</span><span class="p">)),</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;voxel_nuisance_regressors_merge&#39;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">regressor_key</span><span class="p">,</span> <span class="p">(</span>
            <span class="n">regressor_arg</span><span class="p">,</span> <span class="n">regressor_node</span><span class="p">,</span> <span class="n">regressor_target</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">voxel_nuisance_regressors</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">regressor_target</span> <span class="o">!=</span> <span class="s1">&#39;dsort&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">node</span><span class="p">,</span> <span class="n">node_output</span> <span class="o">=</span> <span class="n">regressor_node</span>

            <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
                <span class="n">node</span><span class="p">,</span> <span class="n">node_output</span><span class="p">,</span>
                <span class="n">voxel_nuisance_regressors_merge</span><span class="p">,</span> <span class="s2">&quot;in</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">build_nuisance_regressors</span><span class="p">,</span> <span class="n">outputspec</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;regressors_file_path&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;censor_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;censor_indices&#39;</span><span class="p">)])])</span>

    <span class="k">return</span> <span class="n">nuisance_wf</span></div>


<span class="k">def</span> <span class="nf">create_nuisance_regression_workflow</span><span class="p">(</span><span class="n">nuisance_selectors</span><span class="p">,</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nuisance_regression&#39;</span><span class="p">):</span>

    <span class="n">inputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;selector&#39;</span><span class="p">,</span>
        <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fd_j_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fd_p_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;dvars_file_path&#39;</span>
    <span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;residual_file_path&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">nuisance_wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Censor&#39;</span><span class="p">):</span>

        <span class="n">censor_methods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Kill&#39;</span><span class="p">,</span> <span class="s1">&#39;Zero&#39;</span><span class="p">,</span> <span class="s1">&#39;Interpolate&#39;</span><span class="p">,</span> <span class="s1">&#39;SpikeRegression&#39;</span><span class="p">]</span>

        <span class="n">censor_selector</span> <span class="o">=</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Censor&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">censor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">censor_methods</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Improper censoring method specified (</span><span class="si">{0}</span><span class="s2">), &quot;</span>
                             <span class="s2">&quot;should be one of </span><span class="si">{1}</span><span class="s2">.&quot;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">censor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">),</span>
                                     <span class="n">censor_methods</span><span class="p">))</span>

        <span class="n">find_censors</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span>
            <span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;fd_j_file_path&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;fd_j_threshold&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;fd_p_file_path&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;fd_p_threshold&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;dvars_file_path&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;dvars_threshold&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;number_of_previous_trs_to_censor&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;number_of_subsequent_trs_to_censor&#39;</span><span class="p">],</span>
            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
            <span class="n">function</span><span class="o">=</span><span class="n">find_offending_time_points</span><span class="p">,</span>
            <span class="n">as_module</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;find_offending_time_points&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">censor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thresholds&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Censoring requested, but thresh_metric not provided.&#39;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">threshold</span> <span class="ow">in</span> <span class="n">censor_selector</span><span class="p">[</span><span class="s1">&#39;thresholds&#39;</span><span class="p">]:</span>

            <span class="k">if</span> <span class="s1">&#39;type&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;DVARS&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_J&#39;</span><span class="p">,</span> <span class="s1">&#39;FD_P&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Censoring requested, but with invalid threshold type.&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;value&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s1">&#39;Censoring requested, but threshold not provided.&#39;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FD_J&#39;</span><span class="p">:</span>
                <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fd_j_threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;fd_j_file_path&quot;</span><span class="p">,</span>
                                    <span class="n">find_censors</span><span class="p">,</span> <span class="s2">&quot;fd_j_file_path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FD_P&#39;</span><span class="p">:</span>
                <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">fd_p_threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;fd_p_file_path&quot;</span><span class="p">,</span>
                                    <span class="n">find_censors</span><span class="p">,</span> <span class="s2">&quot;fd_p_file_path&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DVARS&#39;</span><span class="p">:</span>
                <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">dvars_threshold</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s2">&quot;dvars_file_path&quot;</span><span class="p">,</span>
                                    <span class="n">find_censors</span><span class="p">,</span> <span class="s2">&quot;dvars_file_path&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">censor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_of_previous_trs_to_censor&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">censor_selector</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;SpikeRegression&#39;</span><span class="p">:</span>

            <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_previous_trs_to_censor</span> <span class="o">=</span> \
                <span class="n">censor_selector</span><span class="p">[</span><span class="s1">&#39;number_of_previous_trs_to_censor&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_previous_trs_to_censor</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">censor_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;number_of_subsequent_trs_to_censor&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="n">censor_selector</span><span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;SpikeRegression&#39;</span><span class="p">:</span>

            <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_subsequent_trs_to_censor</span> <span class="o">=</span> \
                <span class="n">censor_selector</span><span class="p">[</span><span class="s1">&#39;number_of_subsequent_trs_to_censor&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">find_censors</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">number_of_subsequent_trs_to_censor</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Use 3dTproject to perform nuisance variable regression</span>
    <span class="n">nuisance_regression</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">TProject</span><span class="p">(),</span>
                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nuisance_regression&#39;</span><span class="p">,</span>
                                  <span class="n">mem_gb</span><span class="o">=</span><span class="mf">1.716</span><span class="p">,</span>
                                  <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">6278549929741219</span> <span class="o">/</span>
                                         <span class="mi">604462909807314587353088</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">))</span>

    <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="s1">&#39;residuals.nii.gz&#39;</span>
    <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
    <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">norm</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Censor&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Censor&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SpikeRegression&#39;</span><span class="p">:</span>
            <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">find_censors</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                                <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;censor&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Censor&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Interpolate&#39;</span><span class="p">:</span>
                <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cenmode</span> <span class="o">=</span> <span class="s1">&#39;NTRP&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">cenmode</span> <span class="o">=</span> \
                    <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Censor&#39;</span><span class="p">][</span><span class="s1">&#39;method&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

            <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">find_censors</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                                <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;censor&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PolyOrt&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;PolyOrt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;degree&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Polynomial orthogonalization requested, &quot;</span>
                             <span class="s2">&quot;but degree not provided.&quot;</span><span class="p">)</span>

        <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">polort</span> <span class="o">=</span> \
            <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;PolyOrt&#39;</span><span class="p">][</span><span class="s1">&#39;degree&#39;</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">nuisance_regression</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">polort</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
                        <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">,</span>
                        <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Custom&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Custom&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;file&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Custom&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="n">nuisance_selectors</span><span class="p">[</span><span class="s1">&#39;Custom&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.nii.gz&#39;</span><span class="p">):</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                                    <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;dsort&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                                    <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;ort&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                                <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;ort&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># there&#39;s no regressor file generated if only Bandpass in nuisance_selectors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="s1">&#39;Bandpass&#39;</span> <span class="ow">in</span> <span class="n">nuisance_selectors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                                <span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;ort&#39;</span><span class="p">)</span>

    <span class="n">nuisance_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">nuisance_regression</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;residual_file_path&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nuisance_wf</span>


<span class="k">def</span> <span class="nf">filtering_bold_and_regressors</span><span class="p">(</span><span class="n">nuisance_selectors</span><span class="p">,</span>
                                  <span class="n">name</span><span class="o">=</span><span class="s1">&#39;filtering_bold_and_regressors&#39;</span><span class="p">):</span>

    <span class="n">inputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span>
        <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;regressors_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">,</span>
        <span class="s1">&#39;nuisance_selectors&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tr&#39;</span>
    <span class="p">]),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inputspec&#39;</span><span class="p">)</span>

    <span class="n">outputspec</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;residual_file_path&#39;</span><span class="p">,</span>
                                                        <span class="s1">&#39;residual_regressor&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s1">&#39;outputspec&#39;</span><span class="p">)</span>

    <span class="n">filtering_wf</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
    <span class="n">bandpass_selector</span> <span class="o">=</span> <span class="n">nuisance_selectors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Bandpass&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">):</span>
        <span class="n">bandpass_method</span> <span class="o">=</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bandpass_method</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>

    <span class="k">if</span> <span class="n">bandpass_method</span> <span class="o">==</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>

        <span class="n">frequency_filter</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span>
                    <span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;realigned_file&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;bandpass_freqs&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;sample_period&#39;</span><span class="p">],</span>
                            <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;bandpassed_file&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;regressor_file&#39;</span><span class="p">],</span>
                            <span class="n">function</span><span class="o">=</span><span class="n">bandpass_voxels</span><span class="p">,</span>
                            <span class="n">as_module</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;frequency_filter&#39;</span><span class="p">,</span>
                    <span class="n">mem_gb</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                    <span class="n">mem_x</span><span class="o">=</span><span class="p">(</span><span class="mi">3811976743057169</span> <span class="o">/</span> <span class="mi">151115727451828646838272</span><span class="p">,</span>
                           <span class="s1">&#39;realigned_file&#39;</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">frequency_filter</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">bandpass_freqs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bottom_frequency&#39;</span><span class="p">),</span>
                    <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_frequency&#39;</span><span class="p">)</span>
                <span class="p">]</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
                            <span class="n">frequency_filter</span><span class="p">,</span> <span class="s1">&#39;realigned_file&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressors_file_path&#39;</span><span class="p">,</span>
                            <span class="n">frequency_filter</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">frequency_filter</span><span class="p">,</span> <span class="s1">&#39;bandpassed_file&#39;</span><span class="p">,</span>
                            <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;residual_file_path&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">frequency_filter</span><span class="p">,</span> <span class="s1">&#39;regressor_file&#39;</span><span class="p">,</span>
                            <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;residual_regressor&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">bandpass_method</span> <span class="o">==</span> <span class="s1">&#39;AFNI&#39;</span><span class="p">:</span>

        <span class="n">bandpass_ts</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">afni</span><span class="o">.</span><span class="n">Bandpass</span><span class="p">(),</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bandpass_ts&#39;</span><span class="p">)</span>

        <span class="n">bandpass_ts</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">highpass</span> <span class="o">=</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bottom_frequency&#39;</span><span class="p">)</span>
        <span class="n">bandpass_ts</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">lowpass</span> <span class="o">=</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_frequency&#39;</span><span class="p">)</span>
        <span class="n">bandpass_ts</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>

        <span class="n">tr_string2float_node</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tr&#39;</span><span class="p">],</span>
                                                     <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;tr_float&#39;</span><span class="p">],</span>
                                                     <span class="n">function</span><span class="o">=</span><span class="n">TR_string_to_float</span><span class="p">),</span>
                                        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tr_string2float&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">,</span>
                            <span class="n">tr_string2float_node</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tr_string2float_node</span><span class="p">,</span> <span class="s1">&#39;tr_float&#39;</span><span class="p">,</span>
                            <span class="n">bandpass_ts</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_file_path&#39;</span><span class="p">,</span>
                            <span class="n">bandpass_ts</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;functional_brain_mask_file_path&#39;</span><span class="p">,</span>
                            <span class="n">bandpass_ts</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">bandpass_ts</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;residual_file_path&#39;</span><span class="p">)</span>

        <span class="n">bandpass_regressor</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">input_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;in_file&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;highpass&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;lowpass&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;tr&#39;</span><span class="p">],</span>
                                              <span class="n">output_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">],</span>
                                              <span class="n">function</span><span class="o">=</span><span class="n">afni_1dBandpass</span><span class="p">),</span>
                                     <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bandpass_regressor&#39;</span><span class="p">)</span>

        <span class="n">bandpass_regressor</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">highpass</span> <span class="o">=</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bottom_frequency&#39;</span><span class="p">)</span>
        <span class="n">bandpass_regressor</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">lowpass</span> <span class="o">=</span> <span class="n">bandpass_selector</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_frequency&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputspec</span><span class="p">,</span> <span class="s1">&#39;regressors_file_path&#39;</span><span class="p">,</span>
                            <span class="n">bandpass_regressor</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">tr_string2float_node</span><span class="p">,</span> <span class="s1">&#39;tr_float&#39;</span><span class="p">,</span>
                            <span class="n">bandpass_regressor</span><span class="p">,</span> <span class="s1">&#39;tr&#39;</span><span class="p">)</span>

        <span class="n">filtering_wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">bandpass_regressor</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                            <span class="n">outputspec</span><span class="p">,</span> <span class="s1">&#39;residual_regressor&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">filtering_wf</span>


<span class="k">def</span> <span class="nf">ICA_AROMA_FSLreg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;ICA_AROMA_FSLreg&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;1-ICA-AROMA&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                &quot;from-bold_to-T1w_mode-image_desc-linear_xfm&quot;,</span>
<span class="sd">                &quot;from-T1w_to-template_mode-image_xfm&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;desc-cleaned_bold&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span><span class="s1">&#39;from-T1w_to-template_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reg_tool</span> <span class="o">!=</span> <span class="s1">&#39;fsl&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">aroma_preproc</span> <span class="o">=</span> <span class="n">create_aroma</span><span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;create_aroma_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">aroma_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">denoise_type</span> <span class="o">=</span> \
        <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;desc-preproc_bold&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.denoise_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
        <span class="s2">&quot;from-bold_to-T1w_mode-image_desc-linear_xfm&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.mat_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;from-T1w_to-template_mode-image_xfm&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.fnirt_warp_file&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nonaggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.nonaggr_denoised_file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.aggr_denoised_file&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span>
        <span class="s1">&#39;desc-cleaned_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ICA_AROMA_ANTsreg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;ICA_AROMA_ANTsreg&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;1-ICA-AROMA&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;sbref&quot;,</span>
<span class="sd">                 &quot;from-bold_to-template_mode-image_xfm&quot;,</span>
<span class="sd">                 &quot;from-template_to-bold_mode-image_xfm&quot;),</span>
<span class="sd">                &quot;T1w-brain-template-funcreg&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;desc-cleaned_bold&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span>
        <span class="s1">&#39;from-bold_to-template_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reg_tool</span> <span class="o">!=</span> <span class="s1">&#39;ants&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">num_cpus</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span><span class="s1">&#39;system_config&#39;</span><span class="p">][</span>
        <span class="s1">&#39;max_cores_per_participant&#39;</span><span class="p">]</span>

    <span class="n">num_ants_cores</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span><span class="s1">&#39;system_config&#39;</span><span class="p">][</span><span class="s1">&#39;num_ants_threads&#39;</span><span class="p">]</span>

    <span class="n">aroma_preproc</span> <span class="o">=</span> <span class="n">create_aroma</span><span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;create_aroma_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">aroma_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">denoise_type</span> <span class="o">=</span> \
        <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">warp_timeseries_to_T1template</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.denoise_file&#39;</span><span class="p">)</span>

    <span class="n">apply_xfm</span> <span class="o">=</span> <span class="n">apply_transform</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ICA-AROMA_ANTs_template_to_bold_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">reg_tool</span><span class="o">=</span><span class="n">reg_tool</span><span class="p">,</span> <span class="n">time_series</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
                                <span class="n">num_ants_cores</span><span class="o">=</span><span class="n">num_ants_cores</span><span class="p">)</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">registration_workflows</span><span class="p">[</span>
            <span class="s1">&#39;functional_registration&#39;</span><span class="p">][</span><span class="s1">&#39;func_registration_to_template&#39;</span><span class="p">][</span>
            <span class="s1">&#39;ANTs_pipelines&#39;</span><span class="p">][</span><span class="s1">&#39;interpolation&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nonaggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.nonaggr_denoised_file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.aggr_denoised_file&#39;</span><span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.input_image&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;sbref&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.reference&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;from-template_to-bold_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.transform&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;outputspec.output_image&#39;</span><span class="p">),</span>
        <span class="s1">&#39;desc-cleaned_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;outputspec.output_image&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ICA_AROMA_FSLEPIreg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;ICA_AROMA_FSLEPIreg&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;1-ICA-AROMA&quot;, &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;desc-brain_bold&quot;, &quot;desc-motion_bold&quot;,</span>
<span class="sd">                 &quot;desc-preproc_bold&quot;, &quot;bold&quot;],</span>
<span class="sd">                &quot;from-bold_to-EPItemplate_mode-image_xfm&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;desc-cleaned_bold&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span><span class="s1">&#39;from-bold_to-EPItemplate_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reg_tool</span> <span class="o">!=</span> <span class="s1">&#39;fsl&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">aroma_preproc</span> <span class="o">=</span> <span class="n">create_aroma</span><span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;create_aroma_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">aroma_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">denoise_type</span> <span class="o">=</span> \
        <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s2">&quot;desc-brain_bold&quot;</span><span class="p">,</span> <span class="s2">&quot;desc-motion_bold&quot;</span><span class="p">,</span>
                                     <span class="s2">&quot;desc-preproc_bold&quot;</span><span class="p">,</span> <span class="s2">&quot;bold&quot;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.denoise_file&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;from-bold_to-EPItemplate_mode-image_xfm&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.fnirt_warp_file&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nonaggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.nonaggr_denoised_file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.aggr_denoised_file&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">),</span>
        <span class="s1">&#39;desc-cleaned_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">ICA_AROMA_ANTsEPIreg</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;ICA_AROMA_ANTsEPIreg&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;1-ICA-AROMA&quot;, &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;sbref&quot;,</span>
<span class="sd">                 &quot;from-bold_to-EPItemplate_mode-image_xfm&quot;,</span>
<span class="sd">                 &quot;from-EPItemplate_to-bold_mode-image_xfm&quot;),</span>
<span class="sd">                &quot;EPI-template&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;desc-cleaned_bold&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span>
        <span class="s1">&#39;from-bold_to-EPItemplate_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">reg_tool</span> <span class="o">!=</span> <span class="s1">&#39;ants&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">num_cpus</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span><span class="s1">&#39;system_config&#39;</span><span class="p">][</span>
        <span class="s1">&#39;max_cores_per_participant&#39;</span><span class="p">]</span>

    <span class="n">num_ants_cores</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pipeline_setup</span><span class="p">[</span><span class="s1">&#39;system_config&#39;</span><span class="p">][</span><span class="s1">&#39;num_ants_threads&#39;</span><span class="p">]</span>

    <span class="n">aroma_preproc</span> <span class="o">=</span> <span class="n">create_aroma</span><span class="p">(</span><span class="n">tr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wf_name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;create_aroma_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">aroma_preproc</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">denoise_type</span> <span class="o">=</span> \
        <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span>

    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">warp_timeseries_to_EPItemplate</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span>
                                                 <span class="n">pipe_num</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">val</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;inputspec.denoise_file&#39;</span><span class="p">)</span>

    <span class="n">apply_xfm</span> <span class="o">=</span> <span class="n">apply_transform</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ICA-AROMA_ANTs_EPItemplate_to_bold_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">reg_tool</span><span class="o">=</span><span class="n">reg_tool</span><span class="p">,</span> <span class="n">time_series</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">num_cpus</span><span class="o">=</span><span class="n">num_cpus</span><span class="p">,</span>
                                <span class="n">num_ants_cores</span><span class="o">=</span><span class="n">num_ants_cores</span><span class="p">)</span>
    <span class="n">apply_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">interpolation</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">registration_workflows</span><span class="p">[</span>
            <span class="s1">&#39;functional_registration&#39;</span><span class="p">][</span><span class="s1">&#39;func_registration_to_template&#39;</span><span class="p">][</span>
            <span class="s1">&#39;ANTs_pipelines&#39;</span><span class="p">][</span><span class="s1">&#39;interpolation&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;nonaggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.nonaggr_denoised_file&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span><span class="s1">&#39;1-ICA-AROMA&#39;</span><span class="p">][</span><span class="s1">&#39;denoising_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;aggr&#39;</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">aroma_preproc</span><span class="p">,</span> <span class="s1">&#39;outputspec.aggr_denoised_file&#39;</span><span class="p">)</span>

    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.input_image&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;sbref&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.reference&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;from-EPItemplate_to-bold_mode-image_xfm&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;inputspec.transform&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;outputspec.output_image&#39;</span><span class="p">),</span>
        <span class="s1">&#39;desc-cleaned_bold&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">apply_xfm</span><span class="p">,</span> <span class="s1">&#39;outputspec.output_image&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_T1w</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_T1w&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;create_regressors&quot;],</span>
<span class="sd">                [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                &quot;regressor_masks&quot;, &quot;erode_anatomical_brain_mask&quot;,</span>
<span class="sd">                &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;space-T1w_desc-brain_mask&quot;,</span>
<span class="sd">                 [&quot;label-CSF_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;label-CSF_mask&quot;])],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-T1w_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_T1w_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">segmentmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span>
        <span class="s1">&#39;erode_anatomical_brain_mask&#39;</span><span class="p">][</span><span class="s1">&#39;brain_mask_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span>
        <span class="s1">&#39;erode_anatomical_brain_mask&#39;</span><span class="p">][</span><span class="s1">&#39;brain_mask_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;label-CSF_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;label-CSF_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-T1w_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_CSF</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_CSF&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;create_regressors&quot;],</span>
<span class="sd">                [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                &quot;regressor_masks&quot;, &quot;erode_csf&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;label-CSF_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;label-CSF_mask&quot;],</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;)],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;label-CSF_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_CSF_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;label-CSF_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;label-CSF_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;label-CSF_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_GM</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_GM&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;create_regressors&quot;],</span>
<span class="sd">                [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                &quot;regressor_masks&quot;, &quot;erode_gm&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;label-GM_desc-preproc&quot;,</span>
<span class="sd">                 &quot;label-GM_mask&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;label-GM_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_GM_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;label-GM_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;label-GM_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;label-GM_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_WM</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_WM&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;create_regressors&quot;],</span>
<span class="sd">                [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                &quot;regressor_masks&quot;, &quot;erode_wm&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;label-WM_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;label-WM_mask&quot;],</span>
<span class="sd">                 &quot;space-T1w_desc-brain_mask&quot;)],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;label-WM_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_WM_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;label-WM_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;label-WM_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-T1w_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;label-WM_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">nuisance_regressors_generation_EPItemplate</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span>
                                               <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;nuisance_regressors_generation_EPItemplate&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;create_regressors&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;Regressors&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;USER-DEFINED&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;desc-brain_bold&quot;,</span>
<span class="sd">                 &quot;space-bold_desc-brain_mask&quot;,</span>
<span class="sd">                 &quot;movement-parameters&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-jenkinson&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-power&quot;,</span>
<span class="sd">                 &quot;dvars&quot;,</span>
<span class="sd">                 [&quot;space-bold_desc-eroded_mask&quot;, &quot;space-bold_desc-brain_mask&quot;],</span>
<span class="sd">                 [&quot;space-bold_label-CSF_desc-eroded_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-CSF_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-CSF_mask&quot;],</span>
<span class="sd">                 [&quot;space-bold_label-WM_desc-eroded_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-WM_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-WM_mask&quot;],</span>
<span class="sd">                 [&quot;space-bold_label-GM_desc-eroded_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-GM_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-GM_mask&quot;],</span>
<span class="sd">                 &quot;from-EPItemplate_to-bold_mode-image_desc-linear_xfm&quot;,</span>
<span class="sd">                 &quot;from-bold_to-EPItemplate_mode-image_desc-linear_xfm&quot;),</span>
<span class="sd">                &quot;lateral-ventricles-mask&quot;,</span>
<span class="sd">                &quot;TR&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;regressors&quot;, &quot;censor-indices&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">nuisance_regressors_generation</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span>
                                          <span class="s1">&#39;bold&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nuisance_regressors_generation_T1w</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span>
                                       <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;nuisance_regressors_generation&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;create_regressors&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;Regressors&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;USER-DEFINED&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;space-bold_desc-brain_mask&quot;,</span>
<span class="sd">                 &quot;from-bold_to-T1w_mode-image_desc-linear_xfm&quot;,</span>
<span class="sd">                 &quot;movement-parameters&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-jenkinson&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-power&quot;,</span>
<span class="sd">                 &quot;dvars&quot;,</span>
<span class="sd">                 &quot;desc-brain_T1w&quot;,</span>
<span class="sd">                 [&quot;space-T1w_desc-eroded_mask&quot;, &quot;space-T1w_desc-brain_mask&quot;],</span>
<span class="sd">                 [&quot;label-CSF_desc-eroded_mask&quot;, &quot;label-CSF_desc-preproc_mask&quot;, &quot;label-CSF_mask&quot;],</span>
<span class="sd">                 [&quot;label-WM_desc-eroded_mask&quot;, &quot;label-WM_desc-preproc_mask&quot;, &quot;label-WM_mask&quot;],</span>
<span class="sd">                 [&quot;label-GM_desc-eroded_mask&quot;, &quot;label-GM_desc-preproc_mask&quot;, &quot;label-GM_mask&quot;],</span>
<span class="sd">                 &quot;from-template_to-T1w_mode-image_desc-linear_xfm&quot;,</span>
<span class="sd">                 &quot;from-T1w_to-template_mode-image_desc-linear_xfm&quot;),</span>
<span class="sd">                &quot;lateral-ventricles-mask&quot;,</span>
<span class="sd">                &quot;TR&quot;],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;regressors&quot;, &quot;censor-indices&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">nuisance_regressors_generation</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span>
                                          <span class="s1">&#39;T1w&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nuisance_regressors_generation</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">space</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wf, cfg, strat_pool, pipe_num, opt</span>
<span class="sd">        pass through from Node Block</span>

<span class="sd">    space : str</span>
<span class="sd">        T1w or bold</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wf : nipype.pipeline.engine.workflows.Workflow</span>

<span class="sd">    outputs : dict</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;space-</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">_&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">reg_tool</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;T1w&#39;</span><span class="p">:</span>
        <span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
            <span class="s1">&#39;from-template_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span>
                <span class="s1">&#39;from-template_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span>
        <span class="n">xfm_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span>
            <span class="s1">&#39;from-EPItemplate_to-bold_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
        <span class="n">reg_tool</span> <span class="o">=</span> <span class="n">check_prov_for_regtool</span><span class="p">(</span><span class="n">xfm_prov</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reg_tool</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">use_ants</span> <span class="o">=</span> <span class="n">reg_tool</span> <span class="o">==</span> <span class="s1">&#39;ants&#39;</span>

    <span class="n">ventricle</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;lateral-ventricles-mask&#39;</span><span class="p">)</span>
    <span class="n">csf_mask</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_&#39;</span>
                                       <span class="s1">&#39;desc-eroded_mask&#39;</span><span class="p">,</span>
                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_&#39;</span>
                                       <span class="s1">&#39;desc-preproc_mask&#39;</span><span class="p">,</span>
                                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_mask&#39;</span><span class="p">])</span>

    <span class="n">regressors</span> <span class="o">=</span> <span class="n">create_regressor_workflow</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">use_ants</span><span class="p">,</span>
                                           <span class="n">ventricle_mask_exist</span><span class="o">=</span><span class="n">ventricle</span><span class="p">,</span>
                                           <span class="n">all_bold</span><span class="o">=</span><span class="n">space</span><span class="o">==</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span>
                                           <span class="n">csf_mask_exist</span> <span class="o">=</span> <span class="n">csf_mask</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nuisance_regressors_&#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s2">&quot;desc-preproc_bold&quot;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
               <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;desc-brain_</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;desc-brain_</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.anatomical_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">desc-eroded_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">desc-brain_mask&#39;</span><span class="p">]):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">desc-eroded_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">desc-brain_mask&#39;</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span>
                   <span class="s1">&#39;inputspec.anatomical_eroded_brain_mask_file_path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1">-space brain mask found in resource pool.&#39;</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_desc-eroded_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_desc-preproc_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_mask&#39;</span><span class="p">]):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_&#39;</span>
                                         <span class="s1">&#39;desc-eroded_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_&#39;</span>
                                         <span class="s1">&#39;desc-preproc_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-CSF_mask&#39;</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.csf_mask_file_path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1">-space CSF mask found in resource pool.&#39;</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_desc-eroded_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_desc-preproc_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_mask&#39;</span><span class="p">]):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_&#39;</span>
                                         <span class="s1">&#39;desc-eroded_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_&#39;</span>
                                         <span class="s1">&#39;desc-preproc_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-WM_mask&#39;</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.wm_mask_file_path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1">-space WM mask found in resource pool.&#39;</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_desc-eroded_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_desc-preproc_mask&#39;</span><span class="p">,</span>
                               <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_mask&#39;</span><span class="p">]):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_&#39;</span>
                                         <span class="s1">&#39;desc-eroded_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_&#39;</span>
                                         <span class="s1">&#39;desc-preproc_mask&#39;</span><span class="p">,</span>
                                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">prefixes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1">label-GM_mask&#39;</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.gm_mask_file_path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;No </span><span class="si">%s</span><span class="s1">-space GM mask found in resource pool.&#39;</span><span class="p">,</span> <span class="n">space</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ventricle</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;lateral-ventricles-mask&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                   <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.lat_ventricles_mask_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;T1w&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
                <span class="s1">&#39;from-bold_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;from-bold_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.func_to_anat_linear_xfm_file_path&#39;</span><span class="p">)</span>

            <span class="c1"># invert func2anat matrix to get anat2func_linear_xfm</span>
            <span class="n">anat2func_linear_xfm</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">fsl</span><span class="o">.</span><span class="n">ConvertXFM</span><span class="p">(),</span>
                                           <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;anat_to_func_linear_xfm_&#39;</span>
                                                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">anat2func_linear_xfm</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">invert_xfm</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">anat2func_linear_xfm</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>

            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat2func_linear_xfm</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.anat_to_func_linear_xfm_file_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
                <span class="s1">&#39;from-template_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;from-template_to-T1w_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.mni_to_anat_linear_xfm_file_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
            <span class="s1">&#39;from-T1w_to-template_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;from-T1w_to-template_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.anat_to_mni_linear_xfm_file_path&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;bold&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
                <span class="s1">&#39;from-EPItemplate_to-bold_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;from-EPItemplate_to-bold_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.mni_to_anat_linear_xfm_file_path&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.anat_to_func_linear_xfm_file_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span>
                <span class="s1">&#39;from-bold_to-EPItemplate_mode-image_desc-linear_xfm&#39;</span><span class="p">):</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span>
                <span class="s1">&#39;from-bold_to-EPItemplate_mode-image_desc-linear_xfm&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.anat_to_mni_linear_xfm_file_path&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">regressors</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.func_to_anat_linear_xfm_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;movement-parameters&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;movement-parameters&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                   <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.motion_parameters_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-jenkinson&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-jenkinson&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_j_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-power&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-power&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_p_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;dvars&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;dvars&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.dvars_file_path&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;TR&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;inputspec.tr&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;regressors&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;outputspec.regressors_file_path&#39;</span><span class="p">),</span>
        <span class="s1">&#39;censor-indices&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">regressors</span><span class="p">,</span> <span class="s1">&#39;outputspec.censor_indices&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nuisance_regression</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">res</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Nuisance regression in native (BOLD) or template space</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    wf, cfg, strat_pool, pipe_num, opt</span>
<span class="sd">        pass through from Node Block</span>

<span class="sd">    space : str</span>
<span class="sd">        native or template</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wf : nipype.pipeline.engine.workflows.Workflow</span>

<span class="sd">    outputs : dict</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">regressor_prov</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_cpac_provenance</span><span class="p">(</span><span class="s1">&#39;regressors&#39;</span><span class="p">)</span>
    <span class="n">regressor_strat_name</span> <span class="o">=</span> <span class="n">regressor_prov</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">regressor_dct</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nuisance_corrections&#39;</span><span class="p">][</span><span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span>
            <span class="s1">&#39;Regressors&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">regressor_dct</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">regressor_strat_name</span><span class="p">:</span>
            <span class="n">opt</span> <span class="o">=</span> <span class="n">regressor_dct</span>
            <span class="k">break</span>

    <span class="n">bandpass</span> <span class="o">=</span> <span class="s1">&#39;Bandpass&#39;</span> <span class="ow">in</span> <span class="n">opt</span>
    <span class="n">bandpass_before</span> <span class="o">=</span> <span class="n">bandpass</span> <span class="ow">and</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nuisance_corrections&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;bandpass_filtering_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Before&#39;</span>

    <span class="n">name_suff</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s1">&#39;space-</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">_reg-</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span>
                 <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span>
                 <span class="sa">f</span><span class="s1">&#39;space-</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">_res-</span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">_reg-</span><span class="si">{</span><span class="n">opt</span><span class="p">[</span><span class="s2">&quot;Name&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">nuis_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;nuisance_regression_</span><span class="si">{</span><span class="n">name_suff</span><span class="si">}</span><span class="s1">&#39;</span>

    <span class="n">nuis</span> <span class="o">=</span> <span class="n">create_nuisance_regression_workflow</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">nuis_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
        <span class="n">nofilter_nuis</span> <span class="o">=</span> <span class="n">nuis</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">nuis</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-noFilter&#39;</span><span class="p">)</span>

    <span class="n">desc_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;desc-preproc_bold&#39;</span><span class="p">,</span> <span class="s1">&#39;desc-cleaned_bold&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;desc-denoisedNofilt_bold&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">space</span> <span class="o">!=</span> <span class="s1">&#39;native&#39;</span><span class="p">:</span>
        <span class="n">new_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;space-</span><span class="si">{</span><span class="n">space</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">new_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">new_label</span><span class="si">}</span><span class="s1">_res-</span><span class="si">{</span><span class="n">res</span><span class="si">}</span><span class="s1">&#39;</span>
        <span class="n">desc_keys</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">new_label</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">desc_keys</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
        <span class="c1"># sometimes mm dimensions match but the voxel dimensions don&#39;t</span>
        <span class="c1"># so here we align the mask to the resampled data before applying</span>
        <span class="n">match_grid</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">afni</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;align_template_mask_to_template_data_&#39;</span>
                                  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">name_suff</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">match_grid</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s1">&#39;NIFTI_GZ&#39;</span>
        <span class="n">match_grid</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">resample_mode</span> <span class="o">=</span> <span class="s1">&#39;Cu&#39;</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;FSL-AFNI-brain-mask&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">match_grid</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">match_grid</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">match_grid</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                   <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">match_grid</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                       <span class="n">nofilter_nuis</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                   <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">nofilter_nuis</span><span class="p">,</span>
                       <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;regressors&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.regressor_file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.regressor_file&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-jenkinson&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-jenkinson&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_j_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_j_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-power&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;framewise-displacement-power&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_p_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.fd_p_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;dvars&#39;</span><span class="p">):</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;dvars&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.dvars_file_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bandpass_before</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.dvars_file_path&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">bandpass</span><span class="p">:</span>
        <span class="n">filt</span> <span class="o">=</span> <span class="n">filtering_bold_and_regressors</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;filtering_bold_and_&#39;</span>
                                             <span class="sa">f</span><span class="s1">&#39;regressors_</span><span class="si">{</span><span class="n">name_suff</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">filt</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">nuisance_selectors</span> <span class="o">=</span> <span class="n">opt</span>

        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;regressors&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.regressors_file_path&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="s1">&#39;template&#39;</span><span class="p">:</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">match_grid</span><span class="p">,</span> <span class="s1">&#39;out_file&#39;</span><span class="p">,</span>
                       <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_brain_mask_file_path&#39;</span><span class="p">)</span>

        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;TR&#39;</span><span class="p">)</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.tr&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;nuisance_corrections&#39;</span><span class="p">,</span> <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">,</span>
               <span class="s1">&#39;bandpass_filtering_order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;After&#39;</span><span class="p">:</span>

            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>

            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">,</span>
                       <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="p">(</span><span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="s1">&#39;regressors&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_regressor&#39;</span><span class="p">)</span>
            <span class="p">}</span>

        <span class="k">elif</span> <span class="n">bandpass_before</span><span class="p">:</span>

            <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>
            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span>
                       <span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>

            <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">,</span>
                       <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>


            <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="p">(</span><span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="p">(</span><span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="n">desc_keys</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="p">(</span><span class="n">nofilter_nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">),</span>
                <span class="s1">&#39;regressors&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">filt</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_regressor&#39;</span><span class="p">)}</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="n">desc_keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;inputspec.functional_file_path&#39;</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span><span class="n">desc_key</span><span class="p">:</span> <span class="p">(</span><span class="n">nuis</span><span class="p">,</span> <span class="s1">&#39;outputspec.residual_file_path&#39;</span><span class="p">)</span> <span class="k">for</span>
                   <span class="n">desc_key</span> <span class="ow">in</span> <span class="n">desc_keys</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nuisance_regression_native</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Apply nuisance regression to native-space image</span>

<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;nuisance_regression_native&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;space&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;native&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;regressors&quot;,</span>
<span class="sd">                 &quot;space-bold_desc-brain_mask&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-jenkinson&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-power&quot;,</span>
<span class="sd">                 &quot;dvars&quot;),</span>
<span class="sd">                &quot;TR&quot;],</span>
<span class="sd">     &quot;outputs&quot;: {&quot;desc-preproc_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in native space&quot;},</span>
<span class="sd">                 &quot;desc-cleaned_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in native space&quot;},</span>
<span class="sd">                 &quot;desc-denoisedNofilt_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in native space, but without &quot;</span>
<span class="sd">                       &quot;frequency filtering.&quot;},</span>
<span class="sd">                 &quot;regressors&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Regressors that were applied in native space&quot;}}}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">nuisance_regression</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;native&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">nuisance_regression_template</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Apply nuisance regression to template-space image</span>

<span class="sd">    Node Block:</span>
<span class="sd">    {&quot;name&quot;: &quot;nuisance_regression_template&quot;,</span>
<span class="sd">     &quot;config&quot;: [&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;],</span>
<span class="sd">     &quot;switch&quot;: [&quot;run&quot;],</span>
<span class="sd">     &quot;option_key&quot;: &quot;space&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;template&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;desc-stc_bold&quot;,</span>
<span class="sd">                 &quot;space-template_desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;space-template_res-derivative_desc-preproc_bold&quot;,</span>
<span class="sd">                 &quot;movement-parameters&quot;,</span>
<span class="sd">                 &quot;regressors&quot;,</span>
<span class="sd">                 &quot;FSL-AFNI-brain-mask&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-jenkinson&quot;,</span>
<span class="sd">                 &quot;framewise-displacement-power&quot;,</span>
<span class="sd">                 &quot;dvars&quot;),</span>
<span class="sd">                &quot;TR&quot;],</span>
<span class="sd">     &quot;outputs&quot;: {&quot;space-template_desc-preproc_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space&quot;},</span>
<span class="sd">                 &quot;space-template_res-derivative_desc-preproc_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space&quot;},</span>
<span class="sd">                 &quot;space-template_desc-cleaned_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space&quot;},</span>
<span class="sd">                 &quot;space-template_res-derivative_desc-cleaned_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space&quot;},</span>
<span class="sd">                &quot;space-template_desc-denoisedNofilt_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space, but without &quot;</span>
<span class="sd">                       &quot;frequency filtering.&quot;},</span>
<span class="sd">                 &quot;space-template_res-derivative_desc-denoisedNofilt_bold&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Preprocessed BOLD image that was nuisance-&quot;</span>
<span class="sd">                       &quot;regressed in template space, but without &quot;</span>
<span class="sd">                       &quot;frequency filtering.&quot;},</span>
<span class="sd">                 &quot;regressors&quot;: {</span>
<span class="sd">        &quot;Description&quot;: &quot;Regressors that were applied in template space&quot;}}}</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span> <span class="o">=</span> <span class="n">nuisance_regression</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> 
                                      <span class="s1">&#39;template&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">check_rpool</span><span class="p">(</span><span class="s1">&#39;space-template_res-derivative_desc-preproc_bold&#39;</span><span class="p">):</span>
        <span class="n">wf</span><span class="p">,</span> <span class="n">res_outputs</span> <span class="o">=</span> <span class="n">nuisance_regression</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> 
                                              <span class="n">opt</span><span class="p">,</span> <span class="s1">&#39;template&#39;</span><span class="p">,</span> <span class="s1">&#39;derivative&#39;</span><span class="p">)</span>
        <span class="n">outputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">res_outputs</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_bold</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_bold&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;regressor_masks&quot;, &quot;erode_anatomical_brain_mask&quot;,</span>
<span class="sd">                 &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [(&quot;space-bold_desc-brain_mask&quot;,</span>
<span class="sd">                 [&quot;space-bold_label-CSF_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-CSF_mask&quot;])],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-bold_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_T1w_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">segmentmap</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span>
        <span class="s1">&#39;erode_anatomical_brain_mask&#39;</span><span class="p">][</span><span class="s1">&#39;brain_mask_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span>
        <span class="s1">&#39;erode_anatomical_brain_mask&#39;</span><span class="p">][</span><span class="s1">&#39;brain_mask_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;space-bold_label-CSF_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;space-bold_label-CSF_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-bold_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_boldCSF</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_boldCSF&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;regressor_masks&quot;, &quot;erode_csf&quot;, &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;space-bold_label-CSF_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-CSF_mask&quot;],</span>
<span class="sd">                 &quot;space-bold_desc-brain_mask&quot;)],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-bold_label-CSF_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_CSF_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_csf&#39;</span><span class="p">][</span>
        <span class="s1">&#39;csf_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;space-bold_label-CSF_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;space-bold_label-CSF_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-bold_label-CSF_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_boldGM</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_boldGM&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;regressor_masks&quot;, &quot;erode_gm&quot;, &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [[&quot;space-bold_label-GM_desc-preproc&quot;,</span>
<span class="sd">                 &quot;space-bold_label-GM_mask&quot;]],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-bold_label-GM_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_GM_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_gm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;gm_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;space-bold_label-GM_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;space-bold_label-GM_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-bold_label-GM_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">erode_mask_boldWM</span><span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">strat_pool</span><span class="p">,</span> <span class="n">pipe_num</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    {&quot;name&quot;: &quot;erode_mask_boldWM&quot;,</span>
<span class="sd">     &quot;config&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;switch&quot;: [[&quot;nuisance_corrections&quot;, &quot;2-nuisance_regression&quot;,</span>
<span class="sd">                 &quot;regressor_masks&quot;, &quot;erode_wm&quot;, &quot;run&quot;],</span>
<span class="sd">                [&quot;registration_workflows&quot;, &quot;functional_registration&quot;,</span>
<span class="sd">                 &quot;EPI_registration&quot;, &quot;run&quot;]],</span>
<span class="sd">     &quot;option_key&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;option_val&quot;: &quot;None&quot;,</span>
<span class="sd">     &quot;inputs&quot;: [([&quot;space-bold_label-WM_desc-preproc_mask&quot;,</span>
<span class="sd">                  &quot;space-bold_label-WM_mask&quot;],</span>
<span class="sd">                 &quot;space-bold_desc-brain_mask&quot;)],</span>
<span class="sd">     &quot;outputs&quot;: [&quot;space-bold_label-WM_desc-eroded_mask&quot;]}</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">erode</span> <span class="o">=</span> <span class="n">erode_mask</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;erode_WM_mask_</span><span class="si">{</span><span class="n">pipe_num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_erosion_mm&#39;</span><span class="p">]</span>
    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">erode_prop</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_erosion_prop&#39;</span><span class="p">]</span>

    <span class="n">erode</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">inputspec</span><span class="o">.</span><span class="n">mask_erode_mm</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nuisance_corrections</span><span class="p">[</span>
        <span class="s1">&#39;2-nuisance_regression&#39;</span><span class="p">][</span><span class="s1">&#39;regressor_masks&#39;</span><span class="p">][</span><span class="s1">&#39;erode_wm&#39;</span><span class="p">][</span>
        <span class="s1">&#39;wm_mask_erosion_mm&#39;</span><span class="p">]</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="s1">&#39;space-bold_label-WM_desc-preproc_mask&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;space-bold_label-WM_mask&#39;</span><span class="p">])</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.mask&#39;</span><span class="p">)</span>

    <span class="n">node</span><span class="p">,</span> <span class="n">out</span> <span class="o">=</span> <span class="n">strat_pool</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;space-bold_desc-brain_mask&#39;</span><span class="p">)</span>
    <span class="n">wf</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">erode</span><span class="p">,</span> <span class="s1">&#39;inputspec.brain_mask&#39;</span><span class="p">)</span>

    <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;space-bold_label-WM_desc-eroded_mask&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">erode</span><span class="p">,</span>
                                                 <span class="s1">&#39;outputspec.eroded_mask&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">wf</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index">
              <img class="logo" src="../../../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../../../index">Table of Contents</a></h3>
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../user/index">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../developer/index">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license">License</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index">C-PAC 1.8.5.dev1 Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">CPAC.nuisance.nuisance</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 20122022, C-PAC Developers. C-PAC is licensed under LGPL-3.0-or-later.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.0.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>
    <script defer src="https://fcp-indi.github.io/scripts/versionList.js"></script>

  </body>
</html>