Anatomical Preprocessing
------------------------

Skull-Stripping
^^^^^^^^^^^^^^^
Skull-stripping is the removal of skull and other non-brain tissue like dura and eyes from anatomical images, which could otherwise complicate co-registration and normalization steps.

C-PAC provides options for configuring skull-stripping - users can select:

* `AFNI's 3dSkullStrip <https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dSkullStrip.html>`_
* `FSL's BET <https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/BET/UserGuide>`_, and can configure further parameters for each of these tools.
* niworkflows-ants: `niworkflows's antsBrainExtraction <https://github.com/poldracklab/niworkflows/blob/master/niworkflows/anat/ants.py>`_
* Providing their own brain mask for extraction


Configuring CPAC to run Skull-Stripping:
""""""""""""""""""""""""""""""""""""""""

**NOTE:** If providing your own brain mask for extraction, you can leave the following options at default. The skull-stripping tools will not run if a brain mask is found in the data configuration file.

.. figure:: /_images/skullstrip_gui.png

#. **Inputs already skull stripped? - [On,Off]:** If inputs are already skull stripped (i.e. the structural input data is brain-only) then you can toggle this option to off. 

#. **Which tool for skull-stripping? - [FSL, AFNI, FSL/AFNI]:** Chose if you’d like to use FSL BET, AFNI 3dSkullStrip, or run both options in parallel.

Configuring AFNI 3dSkullStrip options:
""""""""""""""""""""""""""""""""""""""""
**Note:** These options are pre-set for AFNI 3dSkullStrip's default values. These do not need to be modified unless you are looking to optimize the results of skull-stripping for your particular dataset.

.. figure:: /_images/afni_gui.png

#. **Shrink factor - [0.6]:** Set the threshold value for controlling the brain vs non-brain voxels

#. **Vary shrink factor - [On,Off]:** Vary the shrink factor at every iteration of the algorithm. This prevents the likelihood of surface getting stuck in large pools of CSF before reaching the outer surface of the brain. Default is On.

#. **Shrink factor bottom limit - [0.4]:** The shrink factor bottom limit sets the lower threshold when varying the shrink factor. Default is 0.4, for when edge detection is used (which is On by default),otherwise the default value is 0.4.

#. **Avoid ventricles - [On,Off]:** Avoid ventricles while skull stripping. Default is On.

#. **Number of iterations - [250]:** Set the number of iterations. Default is 250. The number of iterations should depend upon the density of your mesh. Default is 250.

#. **Pushout - [On, Off]:** While expanding, consider the voxels above and not only the voxels below. Default is On

#. **Touchup - [On,Off]:** Perform touchup operations at the end to include areas not covered by surface expansion.

#. **Fill hole option - [10]:** Give the maximum number of pixels on either sid of the hole that can be filled. The default is 10 only if ’Touchup’ is On. Otherwise default is 0.

#. **NN smooth - [72]:** Perform final surface smoothing after all iterations. Default is 20. 

#. **Avoid eyes - [On,Off]:** Avoid eyes while skull stripping. Default is On.

#. **Use edge - [On,Off]:** Use edge detection to reduce leakage into meninges. Default is On.

#. **Fractional expansion - [0.1]:** Speed of expansion. Default Value is 0.1

#. **Push to edge - [Off,On]:** Perform aggressive push to edge, this might cause leakage. Default is Off.

#. **Use Skull - [Off, On]:** Use the outer skull to limit expansion of surface into the skull in case of very strong shading artifacts. Use this only if you leakage into the skull. 

#. **Perc_init - [0]:** Percentage of segments allowed to intersect surface.It is typically a number between 0 and 0.1, but can include negative values (which implies no testing for intersection). Default is 0.

#. **Max_inter_iter - [4]:** Number of iterations to remove intersection problems. With each iteration, the program automatically increases the amount of smoothing to get rid of intersections. Default is 4.

#. **Fac - [1]:** Multiply input dataset by FAC if range of values is too small. Default value is 1.

#. **blur_fwhm - [2]:** Blur datasets after spatial normalization.Default value is 2.

Configuring FSL BET options:
""""""""""""""""""""""""""""""""""""""""
**Note:** These options are pre-set for FSL BET's default values. These do not need to be modified unless you are looking to optimize the results of skull-stripping for your particular dataset.

.. figure:: /_images/bet_gui.png

#. **Frac - [0.5]:** Set the threshold value controlling the brain vs non-brain voxels. Default is 0.5

#. **Mask - [Off, On]:** Mask created along with skull stripping. Default option is Off.

#. **Mesh - [Off, On]:** Mesh created along with skull stripping. Default is Off.

#. **Outline - [Off, On]:** Create a surface outline image, Default is Off.

#. **Padding - [Off, On]:** Add padding to the end of the image, improving BET. Mutually exclusive functional,reduce_bias,robust,padding,remove_eyes,surfaces.

#. **Radius - [0]:** Integer value of head radius. Default is 0.

#. **Reduce bias - [Off, On]:** Reduce bias and cleanup neck. Mutually exclusive with functional, reduce_bias,robust,padding, remove_eyes,surfaces.

#. **Remove_bias - [Off,On]:** Eyes and optic nerve cleanup. Mutually exclusive with functional, reduce_bias,robust,padding,remove_eyes, surfaces. 

#. **Robust - [Off, On]:** Robust brain center estimation. Mutually exclusive with functional, reduce_bias, robust,padding,remove_eyes,surfaces.

#. **Skull - [Off,On]:** Create a Skull Image. Default is Off.

#. **Surfaces - [Off, On]:** Get additional skull and scalp surfaces by running bet2 and betsurf. This is mutually exclusive with reduce bias, robust,padding, remove_eyes.

#. **Threshold - [Off,On]:** Apply thresholding to segmented brain image and mask.Default is Off.

#. **Vertical gradient - [Off,On]:** Vertical gradient un fractional intensity threshold. Within the range of (-1,1).

Configuring niworkflows-ants options:
""""""""""""""""""""""""""""""""""""""""
**Note:** These templates are used during niworkflows-ants skull stripping. e.g. OASIS template can be downloaded `here <https://s3-eu-west-1.amazonaws.com/pfigshare-u-files/3133832/Oasis.zip>`_


#. **niworkflows_ants_template_path:** Set the brain extraction template . e.g. OASIStemplate/T_template0_BrainCerebellumProbabilityMask.nii.gz

#. **niworkflows_ants_mask_path:** Set the brain extraction probability mask. e.g. OASIStemplate/T_template0_BrainCerebellumProbabilityMask.nii.gz

#. **niworkflows_ants_regmask_path:** Set the brain extraction registration mask, used for registration to limit the metric computation to a specific region. e.g. OASIStemplate/T_template0_BrainCerebellumRegistrationMask.nii.gz


Anatomical Registration
^^^^^^^^^^^^^^^^^^^^^^^
In order to compare brain activations between subjects, individual functional and anatomical images must first be transformed to match a common template. The most commonly used template (`MNI152 <http://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009>`_) is maintained by the Montreal Neurological Institute, and is created by combining data from the brains of many different individuals to create an "average" brain. The image below shows how an individual brain is warped to match the shape of the template.

.. figure:: /_images/registration.png

C-PAC provides the option of either using FSL (`FLIRT <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLIRT>`_ and `FNIRT <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FNIRT>`_) or `Advanced Normalization Tools (ANTS) <http://stnava.github.io/ANTs/>`_ to register images. Although the use of ANTS requires an extra step during the C-PAC install process, we have found its results to be significantly better than those produced by FSL (a conclusion supported by a `recent systematic analysis by Klein et al. <https://www.ncbi.nlm.nih.gov/pubmed/20123029>`_).

During registration, individual anatomical images are first transformed to match the common template. Then, the functional data for each subject is registered to their own transformed anatomical image. Finally, functional derivative files are transformed to the common template. For more detail on how C-PAC computes these steps, please see the `Registration Page of the developer documentation <http://fcp-indi.github.io/docs/developer/workflows/registration.html>`_.

By default, C-PAC will register subject brains to the MNI152 template included with FSL. Users wishing to register their data to a different template (such as a group specific template) can specify alternative template files.

Configuring CPAC to Run Anatomical Registration
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. figure:: /_images/anat_reg_gui.png

#. **Anatomical Template Resolution - [1 An interger indicating three same dimensions (e.g., 1mm, 2mm, 3mm, 4mm); 2 A float number indicating three same dimensions (e.g., 3.5mm etc.); 3 Three numbers connected by 'x' indicating three different dimensions (e.g., 2.67mmx2.67mmx3mm etc.)]:** The resolution to which anatomical images should be transformed during registration. This is the resolution at which processed anatomical files will be output.

#. **Anatomical Template (Brain Only) - [path]:** Template to be used during registration. It is not necessary to change this path unless you intend to use a non-standard template.

#. **Anatomical Template (With Skull) - [path]:** Template to be used during registration. It is not necessary to change this path unless you intend to use a non-standard template.

#. **Anatomical to Template Registration Method - [ANTS, FSL, ANTS & FSL]:** Registration method(s) to be used. Options are `ANTS <http://stnava.github.io/ANTs/>`_, `FSL <http://fsl.fmrib.ox.ac.uk/fslcourse/lectures/practicals/reg/>`_, or both.

#. **Interpolation Method - [Linear, BSpline, LanczosWindowedSinc]:** Interpolation method for writing out transformed anatomical images. ANTS registration tools only. Options are Linear, BSpline, or LanczosWindowedSinc.

#. **Interpolation Method - [trilinear, sinc, spline]:** Interpolation method for writing out transformed anatomical images. FSL registration tools only. Options are trilinear, sinc, or spline.

#. **FSL FNIRT Configuration File - [path]:** Configuration file specifying settings used during registration. Required if FSL is selected as the registration method. This file can be found in the :file:`/etc/flirtsch` directory of your FSL install.

#. **FSL FNIRT Reference Mask - [path]:** A reference mask to be used by FNIRT.

#. **Use skull-on image to calculate transform? (ANTS only) - [Off, On]:** Register skull-on anatomical image to template. Calculating the transform with skull-stripped images is reported to be better, but it requires very high-quality skull-stripping. If skull-stripping is imprecise, registration with skull is preferred. Note: This option only affects ANTS due to the fact that FNIRT already uses skull-on images for calculating warps. 

#. **Inputs Already Skull-stripped? - [On, Off]**: Disables skull-stripping on the anatomical inputs if they are already skull-stripped.

Configuration Without the GUI
""""""""""""""""""""""""""""""

The following key/value pairs must be defined in your :doc:`pipeline configuration YAML </pipeline_config>` for C-PAC to run anatomical preprocessing:

.. csv-table::
    :header: "Key","Description","Potential Values"
    :widths: 5,30,15
    :file: _static/params/anat_config.csv

The box below contains an example of what these parameters might look like when defined in the YAML::

    resolution_for_anat : 2mm
    template_brain_only_for_anat : /usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}_brain.nii.gz
    template_skull_for_anat : /usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}.nii.gz
    regOption : ['ANTS']
    fnirtConfig : T1_2_MNI152_2mm
    ref_mask : $FSLDIR/data/standard/MNI152_T1_${resolution_for_anat}_brain_mask_symmetric_dil.nii.gz
    regWithSkull : [0]
    already_skullstripped : [0]

Anatomical Tissue Segmentation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C-PAC uses `FSL/FAST <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FAST>`_ to automatically segment brain images into white matter, gray matter, and CSF. This is done using probability maps that contain information about the likelihood that a given voxel will be of a particular tissue type. Users specify a probability threshold such that voxels meeting a minimum probability of being a particular tissue will be classified as such. This results in masks containing voxels of only a single tissue type.

.. figure:: /_images/segmentation.png

The default tissue probability maps (referred to as Prior Probability Maps) used during segmentation are based on information from a large number of brains, and are based on the priors distributed with FSL and are included in the "Image Resource Files" package downloaded during installation. For more detail on how CPAC computes these steps, please see the `Segmentation Page of the developer documentation <http://fcp-indi.github.io/docs/developer/workflows/seg_preproc.html>`_.

If you would like to use different priors, they must first be binarized such that for each voxel the probability for each tissue type is set to either 0% or 100%.

The following bash script will binarize existing priors::

    # Define what kind of priors to generate (gray, white, or csf)
    tissue=gray

    # Define threshold to use when binarizing data
    threshold=0.5

    # Copy existing priors (in this example, from FSL)
    3dcopy $FSL_DIR/data/standard/tissuepriors/avg152T1_${tissue}.hdr avg152T1_${tissue}.nii.gz

    # Binarize image using threshold set above
    fslmaths avg152T1_${tissue}.nii.gz -thr $threshold -bin avg152T1_${tissue}_2mm_bin

Configuring CPAC to Run Anatomical Tissue Segmentation
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.. figure:: /_images/seg_gui.png

#. **Run Tissue Segmentation - [On, Off, On/Off]:** Automatically segment anatomical images into white matter, gray matter, and CSF based on prior probability maps.

#. **Priors Directory - [path]:** Full path to a directory containing binarized prior probability maps. These maps are included as part of the 'Image Resource Files' package available on the Install page of the User Guide. It is not necessary to change this path unless you intend to use non-standard priors.

#. **White Matter Prior Probability Map - [path]:** Full path to a binarized White Matter prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.

#. **Gray Matter Prior Probability Map - [path]:** Full path to a binarized Gray Matter prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.

#. **CSF Prior Probability Map - [path]:** Full path to a binarized CSF prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.

Configuration Without the GUI
""""""""""""""""""""""""""""""

The following key/value pairs must be defined in your :doc:`pipeline configuration YAML </pipeline_config>` for C-PAC to run anatomical tissue segmentation:

.. csv-table::
    :header: "Key","Description","Potential Values"
    :widths: 5,30,15
    :file: _static/params/seg_config.csv


The box below contains an example of what these parameters might look like when defined in the YAML::

    runSegmentationPreprocessing : [1]
    priors_path : /usr/share/fsl/5.0/data/standard/tissuepriors/2mm
    PRIORS_WHITE : $priors_path/avg152T1_white_bin.nii.gz
    PRIORS_GRAY : $priors_path/avg152T1_gray_bin.nii.gz
    PRIORS_CSF : $priors_path/avg152T1_csf_bin.nii.gz

References
^^^^^^^^^^
`AFNI 3dSkullStrip <https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dSkullStrip.html>`_

Smith, Stephen M., `Fast robust automated brain extraction <http://dx.doi.org/10.1002/hbm.10062>`_, Human Brain Mapping 2002, Volume 17 Issue 3, page 143-155.
