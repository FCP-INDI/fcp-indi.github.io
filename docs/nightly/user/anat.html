
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Anatomical Preprocessing &#8212; C-PAC 1.8.5.dev Beta documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex" />
    <link rel="search" title="Search" href="../search" />
    <link rel="next" title="Functional Preprocessing" href="func" />
    <link rel="prev" title="Pre- and post-processing" href="pipelines/pre-and-post" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="func" title="Functional Preprocessing"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="pipelines/pre-and-post" title="Pre- and post-processing"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index">C-PAC 1.8.5.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index" >User Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="pipelines/pipeline_config" >Setting Up A Pipeline Configuration</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="pipelines/pre-and-post" accesskey="U">Pre- and post-processing</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Anatomical Preprocessing</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="anatomical-preprocessing">
<h1>Anatomical Preprocessing<a class="headerlink" href="#anatomical-preprocessing" title="Permalink to this headline">¶</a></h1>
<div class="flowchart-container"><object data="../_static/flowcharts/anatomical.svg" type="image/svg+xml"></object></div><section id="surface-analysis">
<h2>Surface Analysis<a class="headerlink" href="#surface-analysis" title="Permalink to this headline">¶</a></h2>
<p>Surface analysis runs FreeSurfer recon-all and generates CSF, WM, GM masks, pial surface mesh, smoothed surface mesh, spherical surface mesh, white matter surface mesh, sulcal depth surface maps, cortical thickness surface maps and cortical volume surface maps.</p>
<section id="configuring-cpac-to-run-surface-analysis">
<h3>Configuring CPAC to run surface analysis:<a class="headerlink" href="#configuring-cpac-to-run-surface-analysis" title="Permalink to this headline">¶</a></h3>
<figure class="align-default">
<img alt="../_images/anat_surface.png" src="../_images/anat_surface.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>FreeSurfer - [On,Off]:</strong> FreeSurfer recon-all. Default is Off.</p></li>
</ol>
</section>
<section id="configuration-without-the-gui">
<h3>Configuration Without the GUI<a class="headerlink" href="#configuration-without-the-gui" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">surface_analysis</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Will run Freesurfer for surface-based analysis. Will output traditional Freesurfer derivatives.</span><span class="w"></span>
<span class="w">  </span><span class="c1"># If you wish to employ Freesurfer outputs for brain masking or tissue segmentation in the voxel-based pipeline,</span><span class="w"></span>
<span class="w">  </span><span class="c1"># select those &#39;Freesurfer-&#39; labeled options further below in anatomical_preproc.</span><span class="w"></span>
<span class="w">  </span><span class="nt">freesurfer</span><span class="p">:</span><span class="w"> </span>

<span class="w">    </span><span class="c1"># If anatomical_preproc[&#39;brain_extraction&#39;][&#39;using&#39;] includes FreeSurfer-ABCD and this switch is On, C-PAC will automatically turn this switch Off to avoid running FreeSurfer twice unnecessarily</span><span class="w"></span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Add extra arguments to recon-all command</span><span class="w"></span>
<span class="w">    </span><span class="nt">reconall_args</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"></span>
<span class="w">    </span>
<span class="w">    </span><span class="c1"># (Optional) Provide an already-existing FreeSurfer output directory to ingress already-computed surfaces</span><span class="w"></span>
<span class="w">    </span><span class="nt">freesurfer_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Run ABCD-HCP post FreeSurfer and fMRISurface pipeline</span><span class="w"></span>
<span class="w">  </span><span class="nt">post_freesurfer</span><span class="p">:</span><span class="w"> </span>

<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"></span>

<span class="w">    </span><span class="nt">subcortical_gray_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/dcan-tools/pipeline/global/config/FreeSurferSubcorticalLabelTableLut.txt</span><span class="w"></span>

<span class="w">    </span><span class="nt">freesurfer_labels</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/dcan-tools/pipeline/global/config/FreeSurferAllLut.txt</span><span class="w"></span>

<span class="w">    </span><span class="nt">surf_atlas_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/dcan-tools/pipeline/global/templates/standard_mesh_atlases</span><span class="w"></span>

<span class="w">    </span><span class="nt">gray_ordinates_dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/dcan-tools/pipeline/global/templates/91282_Greyordinates</span><span class="w"></span>

<span class="w">    </span><span class="nt">gray_ordinates_res</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>

<span class="w">    </span><span class="nt">high_res_mesh</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">164</span><span class="w"></span>

<span class="w">    </span><span class="nt">low_res_mesh</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span><span class="w"></span>

<span class="w">    </span><span class="nt">fmri_res</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>

<span class="w">    </span><span class="nt">smooth_fwhm</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="initial-preprocessing">
<h2>Initial Preprocessing<a class="headerlink" href="#initial-preprocessing" title="Permalink to this headline">¶</a></h2>
<p>Initial preprocessing offers methods like <a class="reference external" href="https://doi.org/10.1016/j.neuroimage.2013.04.127">ACPC Alignment</a> , <a class="reference external" href="https://www.iro.umontreal.ca/~mignotte/IFT6150/Articles/Buades-NonLocal.pdf">non-local means filtering</a> and <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3071855/">N4 bias field correction</a> to preprocess anatomical images.</p>
<p>C-PAC provides options for configuring initial preprocessing - users can select:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/Washington-University/HCPpipelines/blob/master/PreFreeSurfer/scripts/ACPCAlignment.sh">ACPC Alignment</a></p></li>
<li><p><a class="reference external" href="https://manpages.debian.org/experimental/ants/DenoiseImage.1.en.html">ANT’s DenoiseImage</a></p></li>
<li><p><a class="reference external" href="http://manpages.ubuntu.com/manpages/trusty/man1/N4BiasFieldCorrection.1.html">ANT’s N4BiasFieldCorrection</a></p></li>
</ul>
<section id="configuring-cpac-to-run-initial-preprocessing">
<h3>Configuring CPAC to run initial preprocessing:<a class="headerlink" href="#configuring-cpac-to-run-initial-preprocessing" title="Permalink to this headline">¶</a></h3>
<figure class="align-default">
<img alt="../_images/anat_init_options.png" src="../_images/anat_init_options.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>ACPC Alignment - [On,Off]:</strong> Anterior Commissure - Posterior Comissure (ACPC) alignment. Default is Off. If choose ‘on’, clicking on the setting icon will bring up a dialog where you can set ACPC alignment parameters.</p></li>
<li><p><strong>Non-Local Means Filtering - [On,Off]:</strong> ANTs DenoiseImage. Default is Off.</p></li>
<li><p><strong>N4 Bias Field Correction - [On,Off]:</strong> ANTs N4BiasFieldCorrection - a variant of the popular N3 (nonparametric nonuniform normalization) retrospective bias correction algorithm. Default is Off.</p></li>
</ol>
</section>
<section id="id2">
<h3>Configuration Without the GUI<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">On</span><span class="w"></span>

<span class="w">  </span><span class="nt">run_t2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Non-local means filtering via ANTs DenoiseImage</span><span class="w"></span>
<span class="w">  </span><span class="nt">non_local_means_filtering</span><span class="p">:</span><span class="w"> </span>

<span class="w">    </span><span class="c1"># this is a fork option</span><span class="w"></span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Off</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># options: &#39;Gaussian&#39; or &#39;Rician&#39;</span><span class="w"></span>
<span class="w">    </span><span class="nt">noise_model</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Gaussian&#39;</span><span class="w"></span>

<span class="w">  </span><span class="c1"># N4 bias field correction via ANTs</span><span class="w"></span>
<span class="w">  </span><span class="nt">n4_bias_field_correction</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="c1"># this is a fork option</span><span class="w"></span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">Off</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># An integer to resample the input image to save computation time. Shrink factors &lt;= 4 are commonly used.</span><span class="w"></span>
<span class="w">    </span><span class="nt">shrink_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Bias field correction based on square root of T1w * T2w</span><span class="w"></span>
<span class="w">  </span><span class="nt">t1t2_bias_field_correction</span><span class="p">:</span><span class="w"> </span>

<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"> </span>
<span class="w">    </span>
<span class="w">    </span><span class="nt">BiasFieldSmoothingSigma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span><span class="w"></span>
<span class="w">    </span>
<span class="w">  </span><span class="nt">acpc_alignment</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="configuring-acpc-alignment-options">
<h3>Configuring ACPC Alignment options:<a class="headerlink" href="#configuring-acpc-alignment-options" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> These options are pre-set for ACPC Alignment’s default values. These do not need to be modified unless you are looking to optimize the results of ACPC alignment for your particular dataset.</p>
<figure class="align-default">
<img alt="../_images/acpc_gui.png" src="../_images/acpc_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>ACPC Brain Size - [150]:</strong> ACPC size of brain in z-dimension in mm. Default: 150mm for human data, 70mm for macaque data.</p></li>
<li><p><strong>ACPC Aligned Skull Template - [path]:</strong> Skull template to be used for ACPC alignment. It is not necessary to change this path unless you intend to use a non-standard template.</p></li>
<li><p><strong>ACPC Aligned Brain Template - [path]:</strong> Brain template to be used for ACPC alignment. For human data, it can be ‘None’. It is not necessary to change this path unless you intend to use a non-standard template.</p></li>
</ol>
</section>
<section id="id3">
<h3>Configuration Without the GUI<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">acpc_alignment</span><span class="p">:</span>

    <span class="n">run</span><span class="p">:</span> <span class="n">Off</span>

    <span class="c1"># Run ACPC alignment before non-local means filtering or N4 bias</span>
    <span class="c1"># correction</span>
    <span class="n">run_before_preproc</span><span class="p">:</span> <span class="kc">True</span>

    <span class="c1"># ACPC size of brain in z-dimension in mm.</span>
    <span class="c1"># Default: 150mm for human data.</span>
    <span class="n">brain_size</span><span class="p">:</span> <span class="mi">150</span>

    <span class="c1"># Choose a tool to crop the FOV in ACPC alignment. </span>
    <span class="c1"># Using FSL&#39;s robustfov or flirt command. </span>
    <span class="c1"># Default: robustfov for human data, flirt for monkey data. </span>
    <span class="n">FOV_crop</span><span class="p">:</span> <span class="n">robustfov</span>
    
    <span class="c1"># ACPC Target</span>
    <span class="c1"># options: &#39;brain&#39; or &#39;whole-head&#39;</span>
    <span class="c1">#   note: &#39;brain&#39; requires T1w_brain_ACPC_template below to be populated</span>
    <span class="n">acpc_target</span><span class="p">:</span> <span class="s1">&#39;whole-head&#39;</span>

    <span class="c1"># Run ACPC alignment on brain mask </span>
    <span class="c1"># If the brain mask is in native space, turn it on</span>
    <span class="c1"># If the brain mask is ACPC aligned, turn it off</span>
    <span class="n">align_brain_mask</span><span class="p">:</span> <span class="n">Off</span>

    <span class="c1"># ACPC aligned template</span>
    <span class="n">T1w_ACPC_template</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="mf">5.0</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">standard</span><span class="o">/</span><span class="n">MNI152_T1_1mm</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
    <span class="n">T1w_brain_ACPC_template</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">fsl</span><span class="o">/</span><span class="mf">5.0</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">standard</span><span class="o">/</span><span class="n">MNI152_T1_1mm_brain</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>
    <span class="n">T2w_ACPC_template</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">T2w_brain_ACPC_template</span><span class="p">:</span> <span class="kc">None</span>

</pre></div>
</div>
</section>
</section>
<section id="skull-stripping">
<h2>Skull-Stripping<a class="headerlink" href="#skull-stripping" title="Permalink to this headline">¶</a></h2>
<p>Skull-stripping is the removal of skull and other non-brain tissue like dura and eyes from anatomical images, which could otherwise complicate co-registration and normalization steps.</p>
<p>C-PAC provides options for configuring skull-stripping - users can select:</p>
<ul class="simple">
<li><p>AFNI: <a class="reference external" href="https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dSkullStrip.html">3dSkullStrip</a></p></li>
<li><p>FSL: <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/BET/UserGuide">BET</a>. Further parameters for each of these tools are configurable.</p></li>
<li><p>niworkflows-ants: <a class="reference external" href="https://github.com/poldracklab/niworkflows/blob/master/niworkflows/anat/ants.py">niworkflows’s antsBrainExtraction</a></p></li>
<li><p>U-Net: U-Net is a Fully Convolutional Network (FCN) for image segmentation. Users can now select this option for brain extraction, especially optimal for non-human primate data.</p></li>
<li><p>Providing their own brain mask for extraction</p></li>
</ul>
<section id="configuring-cpac-to-run-skull-stripping">
<h3>Configuring CPAC to run Skull-Stripping:<a class="headerlink" href="#configuring-cpac-to-run-skull-stripping" title="Permalink to this headline">¶</a></h3>
<p><strong>NOTE:</strong> If providing your own brain mask for extraction, you can leave the following options at default. The skull-stripping tools will not run if a brain mask is found in the data configuration file.</p>
<figure class="align-default">
<img alt="../_images/skullstrip_gui.png" src="../_images/skullstrip_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Already skull-stripped - [On,Off]:</strong> If inputs are already skull stripped (i.e. the structural input data is brain-only) then you can toggle this option to off.</p></li>
<li><p><strong>Which tool for skull-stripping - [FSL, AFNI, niworkflows-ants]:</strong> Choose if you’d like to use FSL BET, AFNI 3dSkullStrip, or run all options in parallel.</p></li>
</ol>
</section>
<section id="id4">
<h3>Configuration Without the GUI<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">brain_extraction</span><span class="p">:</span>
  
    <span class="n">run</span><span class="p">:</span> <span class="n">On</span>

    <span class="c1"># using: [&#39;3dSkullStrip&#39;, &#39;BET&#39;, &#39;UNet&#39;, &#39;niworkflows-ants&#39;, &#39;FreeSurfer-ABCD&#39;, &#39;FreeSurfer-BET-Tight&#39;, &#39;FreeSurfer-BET-Loose&#39;]</span>
    <span class="c1"># this is a fork option</span>
    <span class="n">using</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;3dSkullStrip&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="configuring-afni-3dskullstrip-options">
<h3>Configuring AFNI 3dSkullStrip options:<a class="headerlink" href="#configuring-afni-3dskullstrip-options" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> These options are pre-set for AFNI 3dSkullStrip’s default values. These do not need to be modified unless you are looking to optimize the results of skull-stripping for your particular dataset.</p>
<figure class="align-default">
<img alt="../_images/afni_gui.png" src="../_images/afni_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Shrink factor - [0.6]:</strong> Set the threshold value for controlling the brain vs non-brain voxels</p></li>
<li><p><strong>Vary shrink factor - [On,Off]:</strong> Vary the shrink factor at every iteration of the algorithm. This prevents the likelihood of surface getting stuck in large pools of CSF before reaching the outer surface of the brain. Default is On.</p></li>
<li><p><strong>Shrink factor bottom limit - [0.4]:</strong> The shrink factor bottom limit sets the lower threshold when varying the shrink factor. Default is 0.4, for when edge detection is used (which is On by default),otherwise the default value is 0.4.</p></li>
<li><p><strong>Avoid ventricles - [On,Off]:</strong> Avoid ventricles while skull stripping. Default is On.</p></li>
<li><p><strong>Number of iterations - [250]:</strong> Set the number of iterations. Default is 250. The number of iterations should depend upon the density of your mesh. Default is 250.</p></li>
<li><p><strong>Pushout - [On, Off]:</strong> While expanding, consider the voxels above and not only the voxels below. Default is On.</p></li>
<li><p><strong>Touchup - [On,Off]:</strong> Perform touchup operations at the end to include areas not covered by surface expansion.</p></li>
<li><p><strong>Fill hole option - [10]:</strong> Give the maximum number of pixels on either side of the hole that can be filled. The default is 10 only if ’Touchup’ is On. Otherwise default is 0.</p></li>
<li><p><strong>NN smooth - [72]:</strong> Perform final surface smoothing after all iterations. Default is 20.</p></li>
<li><p><strong>Avoid eyes - [On,Off]:</strong> Avoid eyes while skull stripping. Default is On.</p></li>
<li><p><strong>Use edge - [On,Off]:</strong> Use edge detection to reduce leakage into meninges. Default is On.</p></li>
<li><p><strong>Fractional expansion - [0.1]:</strong> Speed of expansion. Default Value is 0.1</p></li>
<li><p><strong>Push to edge - [Off,On]:</strong> Perform aggressive push to edge, this might cause leakage. Default is Off.</p></li>
<li><p><strong>Use Skull - [Off, On]:</strong> Use the outer skull to limit expansion of surface into the skull in case of very strong shading artifacts. Use this only if you leakage into the skull.</p></li>
<li><p><strong>Perc_init - [0]:</strong> Percentage of segments allowed to intersect surface.It is typically a number between 0 and 0.1, but can include negative values (which implies no testing for intersection). Default is 0.</p></li>
<li><p><strong>Max_inter_iter - [4]:</strong> Number of iterations to remove intersection problems. With each iteration, the program automatically increases the amount of smoothing to get rid of intersections. Default is 4.</p></li>
<li><p><strong>Fac - [1]:</strong> Multiply input dataset by FAC if range of values is too small. Default value is 1.</p></li>
<li><p><strong>blur_fwhm - [2]:</strong> Blur datasets after spatial normalization. Default value is 2.</p></li>
</ol>
</section>
<section id="id5">
<h3>Configuration Without the GUI<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">brain_extraction</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">AFNI</span><span class="o">-</span><span class="mi">3</span><span class="n">dSkullStrip</span><span class="p">:</span>

      <span class="c1"># Output a mask volume instead of a skull-stripped volume. The mask volume containes 0 to 6, which represents voxel&#39;s postion. If set to True, C-PAC will use this output to generate anatomical brain mask for further analysis.</span>
      <span class="n">mask_vol</span><span class="p">:</span> <span class="kc">False</span>

      <span class="c1"># Set the threshold value controlling the brain vs non-brain voxels. Default is 0.6.</span>
      <span class="n">shrink_factor</span><span class="p">:</span> <span class="mf">0.6</span>

      <span class="c1"># Vary the shrink factor at every iteration of the algorithm. This prevents the likelihood of surface getting stuck in large pools of CSF before reaching the outer surface of the brain. Default is On.</span>
      <span class="n">var_shrink_fac</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># The shrink factor bottom limit sets the lower threshold when varying the shrink factor. Default is 0.4, for when edge detection is used (which is On by default), otherwise the default value is 0.65.</span>
      <span class="n">shrink_factor_bot_lim</span><span class="p">:</span> <span class="mf">0.4</span>

      <span class="c1"># Avoids ventricles while skullstripping.</span>
      <span class="n">avoid_vent</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># Set the number of iterations. Default is 250.The number of iterations should depend upon the density of your mesh.</span>
      <span class="n">n_iterations</span><span class="p">:</span> <span class="mi">250</span>

      <span class="c1"># While expanding, consider the voxels above and not only the voxels below</span>
      <span class="n">pushout</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># Perform touchup operations at the end to include areas not covered by surface expansion.</span>
      <span class="n">touchup</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># Give the maximum number of pixels on either side of the hole that can be filled. The default is 10 only if &#39;Touchup&#39; is On - otherwise, the default is 0.</span>
      <span class="n">fill_hole</span><span class="p">:</span> <span class="mi">10</span>

      <span class="c1"># Perform nearest neighbor coordinate interpolation every few iterations. Default is 72.</span>
      <span class="n">NN_smooth</span><span class="p">:</span> <span class="mi">72</span>

      <span class="c1"># Perform final surface smoothing after all iterations. Default is 20.</span>
      <span class="n">smooth_final</span><span class="p">:</span> <span class="mi">20</span>

      <span class="c1"># Avoid eyes while skull stripping. Default is On.</span>
      <span class="n">avoid_eyes</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># Use edge detection to reduce leakage into meninges and eyes. Default is On.</span>
      <span class="n">use_edge</span><span class="p">:</span> <span class="kc">True</span>

      <span class="c1"># Speed of expansion.</span>
      <span class="n">exp_frac</span><span class="p">:</span> <span class="mf">0.1</span>

      <span class="c1"># Perform aggressive push to edge. This might cause leakage. Default is Off.</span>
      <span class="n">push_to_edge</span><span class="p">:</span> <span class="kc">False</span>

      <span class="c1"># Use outer skull to limit expansion of surface into the skull in case of very strong shading artifacts. Use this only if you have leakage into the skull.</span>
      <span class="n">use_skull</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Percentage of segments allowed to intersect surface. It is typically a number between 0 and 0.1, but can include negative values (which implies no testing for intersection).</span>
      <span class="n">perc_int</span><span class="p">:</span> <span class="mi">0</span>

      <span class="c1"># Number of iterations to remove intersection problems. With each iteration, the program automatically increases the amount of smoothing to get rid of intersections. Default is 4.</span>
      <span class="n">max_inter_iter</span><span class="p">:</span> <span class="mi">4</span>

      <span class="c1"># Multiply input dataset by FAC if range of values is too small.</span>
      <span class="n">fac</span><span class="p">:</span> <span class="mi">1</span>

      <span class="c1"># Blur dataset after spatial normalization. Recommended when you have lots of CSF in brain and when you have protruding gyri (finger like). If so, recommended value range is 2-4. Otherwise, leave at 0.</span>
      <span class="n">blur_fwhm</span><span class="p">:</span> <span class="mi">0</span>

      <span class="c1"># Set it as True if processing monkey data with AFNI</span>
      <span class="n">monkey</span><span class="p">:</span> <span class="kc">False</span>

</pre></div>
</div>
</section>
<section id="configuring-fsl-bet-options">
<h3>Configuring FSL BET options:<a class="headerlink" href="#configuring-fsl-bet-options" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> These options are pre-set for FSL BET’s default values. These do not need to be modified unless you are looking to optimize the results of skull-stripping for your particular dataset.</p>
<figure class="align-default">
<img alt="../_images/bet_gui.png" src="../_images/bet_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Threshold - [0.5]:</strong> Set the threshold value controlling the brain vs non-brain voxels. Default is 0.5</p></li>
<li><p><strong>Radius - [0]:</strong> Integer value of head radius. Default is 0.</p></li>
<li><p><strong>Vertical gradient - [Off,On]:</strong> Vertical gradient un fractional intensity threshold. Within the range of (-1,1).</p></li>
<li><p><strong>Apply threshold - [Off,On]:</strong> Apply thresholding to segmented brain image and mask. Default is Off.</p></li>
<li><p><strong>Mask - [Off, On]:</strong> Mask created along with skull stripping. Default option is On.</p></li>
<li><p><strong>Mesh - [Off, On]:</strong> Mesh created along with skull stripping. Default is Off.</p></li>
<li><p><strong>Skull - [Off,On]:</strong> Create a Skull Image. Default is Off.</p></li>
<li><p><strong>Surfaces - [Off, On]:</strong> Get additional skull and scalp surfaces by running bet2 and betsurf. This is mutually exclusive with reduce bias, robust, padding, remove_eyes.</p></li>
<li><p><strong>Surfaces outline - [Off, On]:</strong> Create a surface outline image, Default is Off.</p></li>
<li><p><strong>Padding - [Off, On]:</strong> Add padding to the end of the image, improving BET. Mutually exclusive functional, reduce_bias, robust, padding, remove_eyes, surfaces.</p></li>
<li><p><strong>Reduce bias - [Off, On]:</strong> Reduce bias and cleanup neck. Mutually exclusive with functional, reduce_bias, robust, padding, remove_eyes, surfaces.</p></li>
<li><p><strong>Remove eyes - [Off,On]:</strong> Eyes and optic nerve cleanup. Mutually exclusive with functional, reduce_bias, robust, padding, remove_eyes, surfaces.</p></li>
<li><p><strong>Robust brain center - [Off, On]:</strong> Robust brain center estimation. Mutually exclusive with functional, reduce_bias, robust, padding, remove_eyes, surfaces.</p></li>
</ol>
</section>
<section id="id6">
<h3>Configuration Without the GUI<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">brain_extraction</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">FSL</span><span class="o">-</span><span class="n">BET</span><span class="p">:</span>

      <span class="c1"># Set the threshold value controling the brain vs non-brain voxels, default is 0.5</span>
      <span class="n">frac</span><span class="p">:</span> <span class="mf">0.5</span>

      <span class="c1"># Mask created along with skull stripping. It should be `On`, if selected functionalMasking :  [&#39;Anatomical_Refined&#39;] and `FSL` as skull-stripping method.</span>
      <span class="n">mask_boolean</span><span class="p">:</span> <span class="n">On</span>

      <span class="c1"># Mesh created along with skull stripping</span>
      <span class="n">mesh_boolean</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Create a surface outline image</span>
      <span class="n">outline</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Add padding to the end of the image, improving BET.Mutually exclusive with functional,reduce_bias,robust,padding,remove_eyes,surfaces</span>
      <span class="n">padding</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Integer value of head radius</span>
      <span class="n">radius</span><span class="p">:</span> <span class="mi">0</span>

      <span class="c1"># Reduce bias and cleanup neck. Mutually exclusive with functional,reduce_bias,robust,padding,remove_eyes,surfaces</span>
      <span class="n">reduce_bias</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Eyes and optic nerve cleanup. Mutually exclusive with functional,reduce_bias,robust,padding,remove_eyes,surfaces</span>
      <span class="n">remove_eyes</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Robust brain center estimation. Mutually exclusive with functional,reduce_bias,robust,padding,remove_eyes,surfaces</span>
      <span class="n">robust</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Create a skull image</span>
      <span class="n">skull</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Gets additional skull and scalp surfaces by running bet2 and betsurf. This is mutually exclusive with reduce_bias, robust, padding, remove_eyes</span>
      <span class="n">surfaces</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Apply thresholding to segmented brain image and mask</span>
      <span class="n">threshold</span><span class="p">:</span> <span class="n">Off</span>

      <span class="c1"># Vertical gradient in fractional intensity threshold (-1,1)</span>
      <span class="n">vertical_gradient</span> <span class="p">:</span> <span class="mf">0.0</span>

</pre></div>
</div>
</section>
<section id="configuring-niworkflows-ants-options">
<h3>Configuring niworkflows-ants options:<a class="headerlink" href="#configuring-niworkflows-ants-options" title="Permalink to this headline">¶</a></h3>
<p><strong>Note:</strong> These templates are used during niworkflows-ants skull stripping. e.g. OASIS template can be downloaded <a class="reference external" href="https://s3-eu-west-1.amazonaws.com/pfigshare-u-files/3133832/Oasis.zip">here</a>.</p>
<figure class="align-default">
<img alt="../_images/niworkflows-ants_gui.png" src="../_images/niworkflows-ants_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>niworkflows_ants_template_path:</strong> Set the brain extraction template . e.g. OASIStemplate/T_template0_BrainCerebellumProbabilityMask.nii.gz</p></li>
<li><p><strong>niworkflows_ants_mask_path:</strong> Set the brain extraction probability mask. e.g. OASIStemplate/T_template0_BrainCerebellumProbabilityMask.nii.gz</p></li>
<li><p><strong>niworkflows_ants_regmask_path:</strong> Set the brain extraction registration mask, used for registration to limit the metric computation to a specific region. e.g. OASIStemplate/T_template0_BrainCerebellumRegistrationMask.nii.gz</p></li>
</ol>
</section>
<section id="id7">
<h3>Configuration Without the GUI<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">anatomical_preproc</span><span class="p">:</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">brain_extraction</span><span class="p">:</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">niworkflows</span><span class="o">-</span><span class="n">ants</span><span class="p">:</span>

      <span class="c1"># Template to be used during niworkflows-ants.</span>
      <span class="c1"># It is not necessary to change this path unless you intend to use a non-standard template.</span>

      <span class="c1"># niworkflows-ants Brain extraction template</span>
      <span class="n">template_path</span> <span class="p">:</span> <span class="o">/</span><span class="n">ants_template</span><span class="o">/</span><span class="n">oasis</span><span class="o">/</span><span class="n">T_template0</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>

      <span class="c1"># niworkflows-ants probability mask</span>
      <span class="n">mask_path</span> <span class="p">:</span> <span class="o">/</span><span class="n">ants_template</span><span class="o">/</span><span class="n">oasis</span><span class="o">/</span><span class="n">T_template0_BrainCerebellumProbabilityMask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>

      <span class="c1"># niworkflows-ants registration mask (can be optional)</span>
      <span class="n">regmask_path</span> <span class="p">:</span> <span class="o">/</span><span class="n">ants_template</span><span class="o">/</span><span class="n">oasis</span><span class="o">/</span><span class="n">T_template0_BrainCerebellumRegistrationMask</span><span class="o">.</span><span class="n">nii</span><span class="o">.</span><span class="n">gz</span>

</pre></div>
</div>
</section>
</section>
<section id="anatomical-registration">
<h2>Anatomical Registration<a class="headerlink" href="#anatomical-registration" title="Permalink to this headline">¶</a></h2>
<p>In order to compare brain activations between subjects, individual functional and anatomical images must first be transformed to match a common template. The most commonly used template (<a class="reference external" href="http://www.bic.mni.mcgill.ca/ServicesAtlases/ICBM152NLin2009">MNI152</a>) is maintained by the Montreal Neurological Institute, and is created by combining data from the brains of many different individuals to create an “average” brain. The image below shows how an individual brain is warped to match the shape of the template.</p>
<figure class="align-default">
<img alt="../_images/registration.png" src="../_images/registration.png" />
</figure>
<p>C-PAC provides the option of either using FSL (<a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FLIRT">FLIRT</a> and <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FNIRT">FNIRT</a>) or <a class="reference external" href="http://stnava.github.io/ANTs/">Advanced Normalization Tools (ANTS)</a> to register images. Although the use of ANTS requires an extra step during the C-PAC install process, we have found its results to be significantly better than those produced by FSL (a conclusion supported by a <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pubmed/20123029">recent systematic analysis by Klein et al.</a>).</p>
<p>During registration, individual anatomical images are first transformed to match the common template. Then, the functional data for each subject is registered to their own transformed anatomical image. Finally, functional derivative files are transformed to the common template. For more detail on how C-PAC computes these steps, please see the <a class="reference external" href="http://fcp-indi.github.io/docs/developer/workflows/registration.html">Registration Page of the developer documentation</a>.</p>
<p>By default, C-PAC will register subject brains to the MNI152 template included with FSL. Users wishing to register their data to a different template (such as a group specific template) can specify alternative template files.</p>
<section id="configuring-cpac-to-run-anatomical-registration">
<h3>Configuring CPAC to Run Anatomical Registration<a class="headerlink" href="#configuring-cpac-to-run-anatomical-registration" title="Permalink to this headline">¶</a></h3>
<figure class="align-default">
<img alt="../_images/anat_reg_gui.png" src="../_images/anat_reg_gui.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Anatomical Template Resolution - [1 An integer indicating three same dimensions (e.g., 1mm, 2mm, 3mm, 4mm); 2 A float number indicating three same dimensions (e.g., 3.5mm etc.); 3 Three numbers connected by ‘x’ indicating three different dimensions (e.g., 2.67mmx2.67mmx3mm etc.)]:</strong> The resolution to which anatomical images should be transformed during registration. This is the resolution at which processed anatomical files will be output.</p></li>
<li><p><strong>Anatomical Template (Brain Only) - [path]:</strong> Template to be used during registration. It is not necessary to change this path unless you intend to use a non-standard template.</p></li>
<li><p><strong>Anatomical Template (With Skull) - [path]:</strong> Template to be used during registration. It is not necessary to change this path unless you intend to use a non-standard template.</p></li>
<li><p><strong>Anatomical to Template Registration Method - [ANTS, FSL, ANTS &amp; FSL]:</strong> Registration method(s) to be used. Options are <a class="reference external" href="http://stnava.github.io/ANTs/">ANTS</a>, <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fslcourse/lectures/practicals/reg/">FSL</a>, or both.</p></li>
<li><p><strong>ANTS skull-on transform - [Off, On]:</strong> Register skull-on anatomical image to template. Calculating the transform with skull-stripped images is reported to be better, but it requires very high-quality skull-stripping. If skull-stripping is imprecise, registration with skull is preferred. Note: This option only affects ANTS due to the fact that FNIRT already uses skull-on images for calculating warps.</p></li>
<li><p><strong>Interpolation Method - [Linear, BSpline, LanczosWindowedSinc]:</strong> Interpolation method for writing out transformed anatomical images. ANTS registration tools only. Options are Linear, BSpline, or LanczosWindowedSinc.</p></li>
<li><p><strong>ANTs Registration Parameters :</strong> Clicking on the setting icon will bring up a dialog where you can set ‘antsRegistration’ parameters.</p></li>
<li><p><strong>FNIRT Configuration - [path]:</strong> Configuration file specifying settings used during registration. Required if FSL is selected as the registration method. This file can be found in the <code class="file docutils literal notranslate"><span class="pre">/etc/flirtsch</span></code> directory of your FSL install.</p></li>
<li><p><strong>FNIRT Reference Mask - [path]:</strong> A reference mask to be used by FNIRT.</p></li>
<li><p><strong>Perform linear registration only - [Off, On]:</strong> Whether or not perform only FLIRT.</p></li>
<li><p><strong>Interpolation Method - [trilinear, sinc, spline]:</strong> Interpolation method for writing out transformed anatomical images. FSL registration tools only. Options are trilinear, sinc, or spline.</p></li>
</ol>
</section>
<section id="id8">
<h3>Configuration Without the GUI<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">registration_workflows</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="nt">anatomical_registration</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">On</span><span class="w"></span>

<span class="w">    </span><span class="c1"># The resolution to which anatomical images should be transformed during registration.</span><span class="w"></span>
<span class="w">    </span><span class="c1"># This is the resolution at which processed anatomical files will be output.</span><span class="w"></span>
<span class="w">    </span><span class="nt">resolution_for_anat</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2mm</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Template to be used during registration.</span><span class="w"></span>
<span class="w">    </span><span class="c1"># It is not necessary to change this path unless you intend to use a non-standard template.</span><span class="w"></span>
<span class="w">    </span><span class="nt">T1w_brain_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}_brain.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Template to be used during registration.</span><span class="w"></span>
<span class="w">    </span><span class="c1"># It is not necessary to change this path unless you intend to use a non-standard template.</span><span class="w"></span>
<span class="w">    </span><span class="nt">T1w_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Template to be used during registration.</span><span class="w"></span>
<span class="w">    </span><span class="c1"># It is not necessary to change this path unless you intend to use a non-standard template.</span><span class="w"></span>
<span class="w">    </span><span class="nt">T1w_brain_template_mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}_brain_mask.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="c1"># Register skull-on anatomical image to a template.</span><span class="w"></span>
<span class="w">    </span><span class="nt">reg_with_skull</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>

<span class="w">    </span><span class="nt">registration</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="c1"># using: [&#39;ANTS&#39;, &#39;FSL&#39;, &#39;FSL-linear&#39;]</span><span class="w"></span>
<span class="w">      </span><span class="c1"># this is a fork point</span><span class="w"></span>
<span class="w">      </span><span class="c1">#   selecting both [&#39;ANTS&#39;, &#39;FSL&#39;] will run both and fork the pipeline</span><span class="w"></span>
<span class="w">      </span><span class="nt">using</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;ANTS&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># option parameters</span><span class="w"></span>
<span class="w">      </span><span class="nt">ANTs</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># If a lesion mask is available for a T1w image, use it to improve the ANTs&#39; registration</span><span class="w"></span>
<span class="w">        </span><span class="c1"># ANTS registration only.</span><span class="w"></span>
<span class="w">        </span><span class="nt">use_lesion_mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">False</span><span class="w"></span>

<span class="w">        </span><span class="c1"># ANTs parameters for T1-template-based registration</span><span class="w"></span>
<span class="w">        </span><span class="nt">T1_registration</span><span class="p">:</span><span class="w"></span>

<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">collapse-output-transforms</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">dimensionality</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span><span class="w"></span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">initial-moving-transform </span><span class="p">:</span><span class="w"></span>
<span class="w">             </span><span class="nt">initializationFeature</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>

<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">transforms</span><span class="p">:</span><span class="w"></span>
<span class="w">             </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Rigid</span><span class="p">:</span><span class="w"></span>
<span class="w">                 </span><span class="nt">gradientStep </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">metric </span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">type </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MI</span><span class="w"></span>
<span class="w">                   </span><span class="nt">metricWeight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">                   </span><span class="nt">numberOfBins </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span><span class="w"></span>
<span class="w">                   </span><span class="nt">samplingStrategy </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Regular</span><span class="w"></span>
<span class="w">                   </span><span class="nt">samplingPercentage </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25</span><span class="w"></span>
<span class="w">                 </span><span class="nt">convergence</span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">iteration </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000x500x250x100</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceThreshold </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e-08</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceWindowSize </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">                 </span><span class="nt">smoothing-sigmas </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0x2.0x1.0x0.0</span><span class="w"></span>
<span class="w">                 </span><span class="nt">shrink-factors </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8x4x2x1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">use-histogram-matching </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>

<span class="w">             </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Affine</span><span class="p">:</span><span class="w"></span>
<span class="w">                 </span><span class="nt">gradientStep </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">metric </span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">type </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MI</span><span class="w"></span>
<span class="w">                   </span><span class="nt">metricWeight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">                   </span><span class="nt">numberOfBins </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32</span><span class="w"></span>
<span class="w">                   </span><span class="nt">samplingStrategy </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Regular</span><span class="w"></span>
<span class="w">                   </span><span class="nt">samplingPercentage </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.25</span><span class="w"></span>
<span class="w">                 </span><span class="nt">convergence</span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">iteration </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000x500x250x100</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceThreshold </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e-08</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceWindowSize </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w"></span>
<span class="w">                 </span><span class="nt">smoothing-sigmas </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0x2.0x1.0x0.0</span><span class="w"></span>
<span class="w">                 </span><span class="nt">shrink-factors </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8x4x2x1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">use-histogram-matching </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>

<span class="w">             </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">SyN</span><span class="p">:</span><span class="w"></span>
<span class="w">                 </span><span class="nt">gradientStep </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">updateFieldVarianceInVoxelSpace </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0</span><span class="w"></span>
<span class="w">                 </span><span class="nt">totalFieldVarianceInVoxelSpace </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w"></span>
<span class="w">                 </span><span class="nt">metric</span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">type </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CC</span><span class="w"></span>
<span class="w">                   </span><span class="nt">metricWeight</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<span class="w">                   </span><span class="nt">radius </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span><span class="w"></span>
<span class="w">                 </span><span class="nt">convergence</span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">iteration </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100x100x70x20</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceThreshold </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1e-09</span><span class="w"></span>
<span class="w">                   </span><span class="nt">convergenceWindowSize </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span><span class="w"></span>
<span class="w">                 </span><span class="nt">smoothing-sigmas </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0x2.0x1.0x0.0</span><span class="w"></span>
<span class="w">                 </span><span class="nt">shrink-factors </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">6x4x2x1</span><span class="w"></span>
<span class="w">                 </span><span class="nt">use-histogram-matching </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>
<span class="w">                 </span><span class="nt">winsorize-image-intensities </span><span class="p">:</span><span class="w"></span>
<span class="w">                   </span><span class="nt">lowerQuantile </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span><span class="w"></span>
<span class="w">                   </span><span class="nt">upperQuantile </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.99</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Interpolation method for writing out transformed anatomical images.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># Possible values: Linear, BSpline, LanczosWindowedSinc</span><span class="w"></span>
<span class="w">        </span><span class="nt">interpolation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LanczosWindowedSinc</span><span class="w"></span>

<span class="w">      </span><span class="nt">FSL-FNIRT</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Configuration file to be used by FSL to set FNIRT parameters.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use custom FNIRT parameters or a non-standard template.</span><span class="w"></span>
<span class="w">        </span><span class="nt">fnirt_config</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">T1_2_MNI152_2mm</span><span class="w"></span>

<span class="w">        </span><span class="c1"># The resolution to which anatomical images should be transformed during registration.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># This is the resolution at which processed anatomical files will be output. </span><span class="w"></span>
<span class="w">        </span><span class="c1"># specifically for monkey pipeline</span><span class="w"></span>
<span class="w">        </span><span class="nt">ref_resolution</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2mm</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Reference mask for FSL registration.</span><span class="w"></span>
<span class="w">        </span><span class="nt">ref_mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}_brain_mask_dil.nii.gz</span><span class="w"></span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Template to be used during registration.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is for monkey pipeline specifically. </span><span class="w"></span>
<span class="w">        </span><span class="nt">FNIRT_T1w_brain_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Template to be used during registration.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is for monkey pipeline specifically. </span><span class="w"></span>
<span class="w">        </span><span class="nt">FNIRT_T1w_template</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span><span class="w"></span>
<span class="w">        </span>
<span class="w">        </span><span class="c1"># Interpolation method for writing out transformed anatomical images.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># Possible values: trilinear, sinc, spline</span><span class="w"></span>
<span class="w">        </span><span class="nt">interpolation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sinc</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Identity matrix used during FSL-based resampling of anatomical-space data throughout the pipeline.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use a different template.</span><span class="w"></span>
<span class="w">        </span><span class="nt">identity_matrix</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/etc/flirtsch/ident.mat</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Reference mask for FSL registration.</span><span class="w"></span>
<span class="w">        </span><span class="nt">ref_mask</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_${resolution_for_anat}_brain_mask_dil.nii.gz</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Reference mask with 2mm resolution to be used during FNIRT-based brain extraction in ABCD-options pipeline.</span><span class="w"></span>
<span class="w">        </span><span class="nt">ref_mask_res-2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_2mm_brain_mask_dil.nii.gz</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Template with 2mm resolution to be used during FNIRT-based brain extraction in ABCD-options pipeline.</span><span class="w"></span>
<span class="w">        </span><span class="nt">T1w_template_res-2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/fsl/5.0/data/standard/MNI152_T1_2mm.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="nt">overwrite_transform</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Off</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Choose the tool to overwrite transform, currently only support &#39;FSL&#39; to overwrite &#39;ANTs&#39; transforms in ABCD-options pipeline.</span><span class="w"></span>
<span class="w">      </span><span class="c1"># using: &#39;FSL&#39;</span><span class="w"></span>
<span class="w">      </span><span class="nt">using</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">FSL</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="anatomical-tissue-segmentation">
<h2>Anatomical Tissue Segmentation<a class="headerlink" href="#anatomical-tissue-segmentation" title="Permalink to this headline">¶</a></h2>
<div class="flowchart-container"><object data="../_static/flowcharts/segmentation.svg" type="image/svg+xml"></object></div><p>C-PAC uses <a class="reference external" href="http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FAST">FSL/FAST</a> to automatically segment brain images into white matter, gray matter, and CSF. This is done using probability maps that contain information about the likelihood that a given voxel will be of a particular tissue type. Users specify a probability threshold such that voxels meeting a minimum probability of being a particular tissue will be classified as such. This results in masks containing voxels of only a single tissue type.</p>
<figure class="align-default">
<img alt="../_images/segmentation.png" src="../_images/segmentation.png" />
</figure>
<p>The default tissue probability maps (referred to as Prior Probability Maps) used during segmentation are based on information from a large number of brains, and are based on the priors distributed with FSL and are included in the “Image Resource Files” package downloaded during installation. Also, CPAC has thresholding and erosion options for anatomical segmentation to further refine the resulting segmentation tissue masks. Threshold value and erosion proportion can be changeable by user. The erosion implementation is adapted from <a class="reference external" href="https://fmriprep.readthedocs.io/en/stable/">fmriprep</a>.</p>
<p>For more detail on how CPAC computes these steps, please see the <a class="reference external" href="http://fcp-indi.github.io/docs/developer/workflows/seg_preproc.html">Segmentation Page of the developer documentation</a>.</p>
<p>Thresholding options have returned, and new erosion options for anatomical segmentation have been introduced. The erosion implementation was adapted from fmriprep.</p>
<p>If you would like to use different priors, they must first be binarized such that for each voxel the probability for each tissue type is set to either 0% or 100%.</p>
<p>The following bash script will binarize existing priors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Define what kind of priors to generate (gray, white, or csf)
tissue=gray

# Define threshold to use when binarizing data
threshold=0.5

# Copy existing priors (in this example, from FSL)
3dcopy $FSL_DIR/data/standard/tissuepriors/avg152T1_${tissue}.hdr avg152T1_${tissue}.nii.gz

# Binarize image using threshold set above
fslmaths avg152T1_${tissue}.nii.gz -thr $threshold -bin avg152T1_${tissue}_2mm_bin
</pre></div>
</div>
<p>In addition, C-PAC offers template-based segmentation options that facilitate nonhuman data processing. Optimal for use with functional-only pipelines commonly used for rodent data, users can now employ a template-based tissue segmentation approach that applies inverse registration transforms to template-space tissue priors.</p>
<p>C-PAC offers ANTs prior-based tissue segmentation, which is optimal for non-human primate segmentations. Users could provide atlas and atlas segmentation images to perform ANTs Prior-based Segmentation.</p>
<section id="configuring-cpac-to-run-anatomical-tissue-segmentation">
<h3>Configuring CPAC to Run Anatomical Tissue Segmentation<a class="headerlink" href="#configuring-cpac-to-run-anatomical-tissue-segmentation" title="Permalink to this headline">¶</a></h3>
<figure class="align-default">
<img alt="../_images/seg_gui_1.png" src="../_images/seg_gui_1.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Tissue Segmentation - [On, Off]:</strong> Automatically segment anatomical images into white matter, gray matter, and CSF based on prior probability maps.</p></li>
<li><p><strong>Use Priors - [On, Off]:</strong> Whether or not to use template-space tissue priors to refine the binary tissue masks generated by segmentation.</p></li>
<li><p><strong>White Matter Prior Probability Map - [path]:</strong> Full path to a binarized White Matter prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.</p></li>
<li><p><strong>Gray Matter Prior Probability Map - [path]:</strong> Full path to a binarized Gray Matter prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.</p></li>
<li><p><strong>CSF Prior Probability Map - [path]:</strong> Full path to a binarized CSF prior probability map. It is not necessary to change this path unless you intend to use non-standard priors.</p></li>
<li><p><strong>FSL-FAST Thresholding - [On, Off]]:</strong> Use FSL-FAST generated binary masks to generate the resulting segmentation tissue masks.</p></li>
<li><p><strong>Customized Thresholding - [On,Off]]:</strong> Set the threshold value for tissue probability maps to generate the resulting segmentation tissue masks.</p></li>
<li><p><strong>White Matter Threshold Value - [float]:</strong> Set the threshold value for refining the resulting White Matter segmentation tissue mask, if choose Customized Thresholding. The default value is 0.95.</p></li>
<li><p><strong>Gray Matter Threshold Value - [float]:</strong> Set the threshold value for refining the resulting Gray Matter segmentation tissue mask, if choose Customized Thresholding. The default value is 0.95.</p></li>
<li><p><strong>CSF Threshold Value - [float]:</strong> Set the threshold value for refining the resulting CSF segmentation tissue mask, if choose Customized Thresholding. The default value is 0.95.</p></li>
<li><p><strong>Erosion - [On, Off]:</strong> Whether or not to use erosion to erode binarized tissue masks.</p></li>
<li><p><strong>Erosion Proportion - [float]:</strong> Set the target volume ratio, if using erosion to erode binarized tissue masks. The default is 0.6.</p></li>
</ol>
<figure class="align-default">
<img alt="../_images/seg_gui_2.png" src="../_images/seg_gui_2.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>Template Based Segmentation - [EPI Template based, T1 Template based]:</strong> Optimal for use with functional-only pipelines commonly used for rodent data, users can now employ a template-based tissue segmentation approach that applies inverse registration transforms to template-space tissue priors. If choose ‘EPI Template based’ or ‘T1 Template based’ as template based segmentation method, please make sure to specify white matter, gray matter, CSF mask paths at below three configurations.</p></li>
<li><p><strong>White Matter Binary Mask - [path]:</strong> Full path to a binarized White Matter mask.</p></li>
<li><p><strong>Gray Matter Binary Mask - [path]:</strong> Full path to a binarized Gray Matter mask.</p></li>
<li><p><strong>CSF Prior Binary Mask - [path]:</strong> Full path to a binarized CSF mask.</p></li>
</ol>
<figure class="align-default">
<img alt="../_images/seg_gui_3.png" src="../_images/seg_gui_3.png" />
</figure>
<ol class="arabic simple">
<li><p><strong>ANTs Prior-Based Segmentation - [On, Off]:</strong> ANTs Prior-based Segmentation workflow that has shown optimal results for non-human primate data. Generate white matter, gray matter, CSF masks based on antsJointLabelFusion.</p></li>
<li><p><strong>The atlas image - [path]:</strong> The atlas image assumed to be used in ANTs Prior-based Segmentation. Clicking on the <em>+</em> icon to the right of the box here will bring up a dialog where you can define multiple paths to NifTIs containing the atlas image.  You may add multiple images to the box.</p></li>
<li><p><strong>The atlas segmentation images - [path]:</strong> The number of specified segmentations should be identical to the number of atlas brain images. Clicking on the <em>+</em> icon to the right of the box here will bring up a dialog where you can define multiple paths to NifTIs containing the atlas segmentation image.  You may add multiple images to the box.</p></li>
<li><p><strong>CSF Label Value - [integer]:</strong> Label value corresponding to CSF in multiatlas file. It is not necessary to change this values unless your CSF/GM/WM label values are different from <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">Freesurfer Color Lookup Table.</a></p></li>
<li><p><strong>Left Gray Matter Label Value - [integer]:</strong> Label value corresponding to Left Gray Matter in multiatlas file. It is not necessary to change this values unless your CSF/GM/WM label values are different from <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">Freesurfer Color Lookup Table.</a></p></li>
<li><p><strong>Right Gray Matter Label Value - [integer]:</strong> Label value corresponding to Right Gray Matter in multiatlas file. It is not necessary to change this values unless your CSF/GM/WM label values are different from <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">Freesurfer Color Lookup Table.</a></p></li>
<li><p><strong>Left White Matter Label Value - [integer]:</strong> Label value corresponding to Left White Matter in multiatlas file. It is not necessary to change this values unless your CSF/GM/WM label values are different from <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">Freesurfer Color Lookup Table.</a></p></li>
<li><p><strong>Right White Matter Label Value - [integer]:</strong> Label value corresponding to Right White Matter in multiatlas file. It is not necessary to change this values unless your CSF/GM/WM label values are different from <a class="reference external" href="https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT">Freesurfer Color Lookup Table.</a></p></li>
</ol>
</section>
<section id="id13">
<h3>Configuration Without the GUI<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h3>
<p>The following nested key/value pairs will be set to these defaults if not defined in your <a class="reference internal" href="pipelines/pipeline_config"><span class="doc">pipeline configuration YAML</span></a>.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">segmentation</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="c1"># Automatically segment anatomical images into white matter, gray matter,</span><span class="w"></span>
<span class="w">  </span><span class="c1"># and CSF based on prior probability maps.</span><span class="w"></span>
<span class="w">  </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">On</span><span class="w"></span>

<span class="w">  </span><span class="nt">tissue_segmentation</span><span class="p">:</span><span class="w"></span>

<span class="w">    </span><span class="c1"># using: [&#39;FSL-FAST&#39;, &#39;Template_Based&#39;, &#39;ANTs_Prior_Based&#39;, &#39;FreeSurfer&#39;]</span><span class="w"></span>
<span class="w">    </span><span class="c1"># this is a fork point</span><span class="w"></span>
<span class="w">    </span><span class="nt">using</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;FSL-FAST&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="c1"># option parameters</span><span class="w"></span>
<span class="w">    </span><span class="nt">FSL-FAST</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="nt">thresholding</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># thresholding of the tissue segmentation probability maps</span><span class="w"></span>
<span class="w">        </span><span class="c1"># options: &#39;Auto&#39;, &#39;Custom&#39;</span><span class="w"></span>
<span class="w">        </span><span class="nt">use</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;Auto&#39;</span><span class="w"></span>

<span class="w">        </span><span class="nt">Custom</span><span class="p">:</span><span class="w"></span>
<span class="w">          </span><span class="c1"># Set the threshold value for the segmentation probability masks (CSF, White Matter, and Gray Matter)</span><span class="w"></span>
<span class="w">          </span><span class="c1"># The values remaining will become the binary tissue masks.</span><span class="w"></span>
<span class="w">          </span><span class="c1"># A good starting point is 0.95.</span><span class="w"></span>

<span class="w">          </span><span class="c1"># CSF (cerebrospinal fluid) threshold.</span><span class="w"></span>
<span class="w">          </span><span class="nt">CSF_threshold_value </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.95</span><span class="w"></span>

<span class="w">          </span><span class="c1"># White matter threshold.</span><span class="w"></span>
<span class="w">          </span><span class="nt">WM_threshold_value </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.95</span><span class="w"></span>

<span class="w">          </span><span class="c1"># Gray matter threshold.</span><span class="w"></span>
<span class="w">          </span><span class="nt">GM_threshold_value </span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.95</span><span class="w"></span>

<span class="w">      </span><span class="nt">use_priors</span><span class="p">:</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Use template-space tissue priors to refine the binary tissue masks generated by segmentation.</span><span class="w"></span>
<span class="w">        </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">On</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Full path to a directory containing binarized prior probability maps.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># These maps are included as part of the &#39;Image Resource Files&#39; package available on the Install page of the User Guide.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use non-standard priors.</span><span class="w"></span>
<span class="w">        </span><span class="nt">priors_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$FSLDIR/data/standard/tissuepriors/2mm</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Full path to a binarized White Matter prior probability map.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use non-standard priors.</span><span class="w"></span>
<span class="w">        </span><span class="nt">WM_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$priors_path/avg152T1_white_bin.nii.gz</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Full path to a binarized Gray Matter prior probability map.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use non-standard priors.</span><span class="w"></span>
<span class="w">        </span><span class="nt">GM_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$priors_path/avg152T1_gray_bin.nii.gz</span><span class="w"></span>

<span class="w">        </span><span class="c1"># Full path to a binarized CSF prior probability map.</span><span class="w"></span>
<span class="w">        </span><span class="c1"># It is not necessary to change this path unless you intend to use non-standard priors.</span><span class="w"></span>
<span class="w">        </span><span class="nt">CSF_path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$priors_path/avg152T1_csf_bin.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="nt">Template_Based</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="c1"># These masks should be in the same space of your registration template, e.g. if</span><span class="w"></span>
<span class="w">      </span><span class="c1"># you choose &#39;EPI Template&#39; , below tissue masks should also be EPI template tissue masks.</span><span class="w"></span>
<span class="w">      </span><span class="c1">#</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Options: [&#39;T1_Template&#39;, &#39;EPI_Template&#39;]</span><span class="w"></span>
<span class="w">      </span><span class="nt">template_for_segmentation</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;T1_Template&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># These masks are included as part of the &#39;Image Resource Files&#39; package available</span><span class="w"></span>
<span class="w">      </span><span class="c1"># on the Install page of the User Guide.</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Full path to a binarized White Matter mask.</span><span class="w"></span>
<span class="w">      </span><span class="nt">WHITE</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$FSLDIR/data/standard/tissuepriors/2mm/avg152T1_white_bin.nii.gz</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Full path to a binarized Gray Matter mask.</span><span class="w"></span>
<span class="w">      </span><span class="nt">GRAY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$FSLDIR/data/standard/tissuepriors/2mm/avg152T1_gray_bin.nii.gz</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Full path to a binarized CSF mask.</span><span class="w"></span>
<span class="w">      </span><span class="nt">CSF</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$FSLDIR/data/standard/tissuepriors/2mm/avg152T1_csf_bin.nii.gz</span><span class="w"></span>

<span class="w">    </span><span class="nt">ANTs_Prior_Based</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Generate white matter, gray matter, CSF masks based on antsJointLabelFusion</span><span class="w"></span>
<span class="w">      </span><span class="c1"># ANTs Prior-based Segmentation workflow that has shown optimal results for non-human primate data.</span><span class="w"></span>

<span class="w">      </span><span class="c1"># The atlas image assumed to be used in ANTs Prior-based Segmentation.</span><span class="w"></span>
<span class="w">      </span><span class="nt">template_brain_list </span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/cpac_templates/MacaqueYerkes19_T1w_0.5mm_desc-JLC_T1w_brain.nii.gz</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/cpac_templates/J_Macaque_11mo_atlas_nACQ_194x252x160space_0.5mm_desc-JLC_T1w_brain.nii.gz</span><span class="w"></span>

<span class="w">      </span><span class="c1"># The atlas segmentation images.</span><span class="w"></span>
<span class="w">      </span><span class="c1"># For performing ANTs Prior-based segmentation method</span><span class="w"></span>
<span class="w">      </span><span class="c1"># the number of specified segmentations should be identical to the number of atlas brain image sets.</span><span class="w"></span>
<span class="w">      </span><span class="c1"># eg.</span><span class="w"></span>
<span class="w">      </span><span class="c1"># ANTs_prior_seg_template_brain_list :</span><span class="w"></span>
<span class="w">      </span><span class="c1">#   - atlas1.nii.gz</span><span class="w"></span>
<span class="w">      </span><span class="c1">#   - atlas2.nii.gz</span><span class="w"></span>
<span class="w">      </span><span class="c1"># ANTs_prior_seg_template_segmentation_list:</span><span class="w"></span>
<span class="w">      </span><span class="c1">#   - segmentation1.nii.gz</span><span class="w"></span>
<span class="w">      </span><span class="c1">#   - segmentation1.nii.gz</span><span class="w"></span>
<span class="w">      </span><span class="nt">template_segmentation_list</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/cpac_templates/MacaqueYerkes19_T1w_0.5mm_desc-JLC_Segmentation.nii.gz</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/cpac_templates/J_Macaque_11mo_atlas_nACQ_194x252x160space_0.5mm_desc-JLC_Segmentation.nii.gz</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to CSF/GM/WM in atlas file</span><span class="w"></span>
<span class="w">      </span><span class="c1"># It is not necessary to change this values unless your CSF/GM/WM label values are different from Freesurfer Color Lookup Table.</span><span class="w"></span>
<span class="w">      </span><span class="c1"># https://surfer.nmr.mgh.harvard.edu/fswiki/FsTutorial/AnatomicalROI/FreeSurferColorLUT</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to CSF in multiatlas file</span><span class="w"></span>
<span class="w">      </span><span class="nt">CSF_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">24</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to Gray Matter in multiatlas file</span><span class="w"></span>
<span class="w">      </span><span class="nt">GM_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">42</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to White Matter in multiatlas file</span><span class="w"></span>
<span class="w">      </span><span class="nt">WM_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">41</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">    </span><span class="nt">FreeSurfer</span><span class="p">:</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Use mri_binarize --erode option to erode segmentation masks</span><span class="w"></span>
<span class="w">      </span><span class="nt">erode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to CSF in FreeSurfer aseg segmentation file</span><span class="w"></span>
<span class="w">      </span><span class="nt">CSF_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">24</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to Gray Matter in FreeSurfer aseg segmentation file</span><span class="w"></span>
<span class="w">      </span><span class="nt">GM_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">3</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">42</span><span class="p p-Indicator">]</span><span class="w"></span>

<span class="w">      </span><span class="c1"># Label values corresponding to White Matter in FreeSurfer aseg segmentation file</span><span class="w"></span>
<span class="w">      </span><span class="nt">WM_label </span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">2</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">41</span><span class="p p-Indicator">]</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dSkullStrip.html">AFNI 3dSkullStrip</a></p>
<p>Smith, Stephen M., <a class="reference external" href="http://dx.doi.org/10.1002/hbm.10062">Fast robust automated brain extraction</a>, Human Brain Mapping 2002, Volume 17 Issue 3, page 143-155.</p>
<ol class="upperalpha simple" start="14">
<li><p>Tustison et al., <a class="reference external" href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3071855/pdf/nihms279873.pdf">N4ITK: Improved N3 Bias Correction</a>, IEEE Transactions on Medical Imaging, 29(6):1310-1320, June 2010.</p></li>
</ol>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index">
              <img class="logo" src="../_static/cpac_logo_vertical.png" alt="Logo"/>
            </a></p>
  <h3><a href="../index">Table of Contents</a></h3>
  <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index">User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quick">1. C-PAC Quickstart</a></li>
<li class="toctree-l2"><a class="reference internal" href="subject_list_config">2. Specify Your Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="pipelines/pipeline_config">3. Select Your Pipeline</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="preprocessing">4. Pre-Process Your Data</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Anatomical Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="func">Functional Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="longitudinal">Longitudinal Preprocessing</a></li>
<li class="toctree-l3"><a class="reference internal" href="nuisance">Nuisance Corrections</a></li>
<li class="toctree-l3"><a class="reference internal" href="aroma_ica">ICA Denoising</a></li>
<li class="toctree-l3"><a class="reference internal" href="tse">Timeseries Extraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="tse#configuring-roi-time-series-extraction">Configuring ROI Time Series Extraction</a></li>
<li class="toctree-l3"><a class="reference internal" href="after_warp">After Warp Settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="derivatives">5. Compute Derivatives</a></li>
<li class="toctree-l2"><a class="reference internal" href="running">6. All Run Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="group_analysis">7. Run Group Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="output_dir">8. Check Your Outputs</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorials/index">9. Tutorials</a></li>
<li class="toctree-l2"><a class="reference internal" href="help">10. Troubleshoot</a></li>
<li class="toctree-l2"><a class="reference internal" href="rnotes">11. Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix">Appendix</a></li>
<li class="toctree-l2"><a class="reference internal" href="appendix#benchmark-package">Benchmark Package</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developer/index">Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../license">License</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="func" title="Functional Preprocessing"
             >next</a> |</li>
        <li class="right" >
          <a href="pipelines/pre-and-post" title="Pre- and post-processing"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index">C-PAC 1.8.5.dev Beta documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index" >User Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="pipelines/pipeline_config" >Setting Up A Pipeline Configuration</a> &#187;</li>
          <li class="nav-item nav-item-3"><a href="pipelines/pre-and-post" >Pre- and post-processing</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Anatomical Preprocessing</a></li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2012‒2022, C-PAC Developers. C-PAC is licensed under LGPL-3.0-or-later.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.0.
    </div>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-19224662-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'UA-19224662-10');
    </script>
    <script defer src="https://fcp-indi.github.io/scripts/versionList.js"></script>

  </body>
</html>